<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.0.1"/>
    <title>lilit.likelihood API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../lilit.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;lilit</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#LiLit">LiLit</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LiLit.__init__">LiLit</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.set_lmin_lmax_fsky">set_lmin_lmax_fsky</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.cov_filling">cov_filling</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.get_keys">get_keys</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.get_Gauss_keys">get_Gauss_keys</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.find_spectrum">find_spectrum</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.sigma">sigma</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.inv_sigma">inv_sigma</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.get_reduced_data">get_reduced_data</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.CAMBres2dict">CAMBres2dict</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.txt2dict">txt2dict</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.prod_fidu">prod_fidu</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.prod_noise">prod_noise</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.initialize">initialize</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.get_requirements">get_requirements</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.data_vector">data_vector</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.chi_exact">chi_exact</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.chi_gaussian">chi_gaussian</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.compute_chi_part">compute_chi_part</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.log_likelihood">log_likelihood</a>
                        </li>
                        <li>
                                <a class="function" href="#LiLit.logp">logp</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../lilit.html">lilit</a><wbr>.likelihood    </h1>

                
                        <input id="mod-likelihood-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-likelihood-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">cobaya.likelihood</span> <span class="kn">import</span> <span class="n">Likelihood</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="k">class</span> <span class="nc">LiLit</span><span class="p">(</span><span class="n">Likelihood</span><span class="p">):</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class defining the Likelihood for LiteBIRD (LiLit).</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">    Within LiLit, the most relevant study cases of LiteBIRD (T, E, B) are already tested and working. So, if you need to work with those, you should not need to look into the actual definition of the likelihood function, since you can proptly start running your MCMCs. Despite this, you should provide to the likelihood some file where to find the proper LiteBIRD noise power spectra, given that LiLit is implementing a simple inverse noise weighting just as a place-holder for something more realistic. As regards lensing, LiLit will need you to pass the reconstruction noise, since its computation is not coded, thus there is no place-holder for lensing.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    Parameters:</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">        name (str):</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">            The name for the likelihood, used in the output. It is necessary to pass it to LiLit. (default: None).</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        fields (list):</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">            List of fields in the data file (default: None).</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        lmax (int or list):</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">            Maximum multipole to consider (default: None).</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">        like (str, optional):</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">            Type of likelihood to use (default: &quot;exact&quot;). Currently supports &quot;exact&quot; and &quot;gaussian&quot;.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        lmin (int or list):</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">            Minimum multipole to consider (default: 2).</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        cl_file (str, optional):</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">            Path to Cl file (default: None).</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        nl_file (str, optional):</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">            Path to noise file (default: None).</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        mapping (dict, optional):</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">            Dictionary of mapping between the fields in the noise file and the fields in the likelihood, used only if nl_file has .txt extension (default: None).</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        experiment (str, optional):</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">            Name of experiment (default: None).</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">        nside (int, optional):</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">            Nside of the map (default: None).</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">        r (float, optional):</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">            Tensor-to-scalar ratio (default: None).</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        nt (float, optional):</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">            Tensor spectral tilt (default: None).</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        pivot_t (float, optional):</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">            Pivot scale of the tensor primordial power spectrum (default: 0.01).</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        fsky (float or list):</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">            Sky fraction (default: 1).</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        sep (str, optional):</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">            Separator used in the data file (default: &quot;&quot;).</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        debug (bool, optional):</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            If True, produces more verbose output (default: None).</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    Attributes:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        fields (list):</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">            List of fields in the data file.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        n_fields (int):</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">            Number of fields.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        keys (list):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">            List of keywords for the dictionaries.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">        gauss_keys (list):</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">            List of keywords for the Gaussian likelihood (4-points).</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">        sigma2 (np.ndarray):</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">            Array of covariances for the Gaussian likelihood case.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        lmax (int or list):</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">            List of lmax values.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        lmaxes (dict):</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">            Dictionary of lmax values.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        fsky (int or list):</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">            List of fsky values.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">        fskies (dict):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">            Dictionary of fsky values.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">        lmin (int or list):</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">            Minimum multipole to consider.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        lmins (dict):</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">            Dictionary of lmin values.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">        like (str):</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">            Type of likelihood to use.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">        cl_file (str):</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">            Path to Cl file.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        fiduCLS (dict):</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">            Dictionary of fiducial Cls.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        noiseCLS (dict):</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">            Dictionary of noise Cls.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">        fiduCOV (np.ndarray):</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">            Fiducial covariance matrix obtained from the corresponding dictionary.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        noiseCOV (np.ndarray):</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">            Noise covariance matrix obtained from the corresponding dictionary.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">        data (np.ndarray):</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">            Data vector obtained by summing fiduCOV + noiseCOV.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">        cobaCLS (dict):</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">            Dictionary of Cobaya Cls.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">        cobaCOV (np.ndarray):</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">            Cobaya covariance matrix obtained from the corresponding dictionary.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">        coba (np.ndarray):</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">            Cobaya vector obtained by summing cobaCOV + noiseCOV.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        nl_file (str):</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">            Path to noise file.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        mapping (dict):</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">            Dictionary of mapping between the fields in the noise file and the fields in the likelihood, used only if nl_file has .txt extension.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        experiment (str):</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">            Name of experiment.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        nside (int):</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">            Nside of the map.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        r (float):</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">            Tensor-to-scalar ratio.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">        nt (float):</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">            Tensor spectral tilt.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        pivot_t (float):</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">            Pivot scale of the tensor primordial power spectrum.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        sep (str):</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">            Separator used in the data file.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">        debug (bool):</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">            If True, produces more output.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">lmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="n">like</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">lmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="n">cl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="n">nl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="n">nside</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="n">nt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="n">pivot_t</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="n">fsky</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="p">):</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="c1"># Check that the user has provided the name of the likelihood</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide the name of the likelihood (e.g. &#39;BB&#39; or &#39;TTTEEE&#39;)&quot;</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="c1"># Check that the user has provided the fields</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide the fields (e.g. &#39;b&#39; or [&#39;t&#39;, &#39;e&#39;])&quot;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="c1"># Check that the user has provided the maximum multipole</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="k">assert</span> <span class="n">lmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must provide the lmax (e.g. 300)&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="n">lmin</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">=</span> <span class="n">like</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span> <span class="o">=</span> <span class="n">cl_file</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span> <span class="o">=</span> <span class="n">nl_file</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="c1"># Check that the user has provided the nside if an experiment is used</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">assert</span> <span class="n">nside</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must provide an nside to compute the noise&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="n">nside</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">()</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="c1"># Check that the user has provided the tensor-to-scalar ratio if a BB likelihood is used</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="p">),</span> <span class="s2">&quot;You must provide the tensor-to-scalar ratio r for the fiducial production (defaul is at 0.01 Mpc^-1)&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nt</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pivot_t</span> <span class="o">=</span> <span class="n">pivot_t</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_lmin_lmax_fsky</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">fsky</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">Likelihood</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="k">def</span> <span class="nf">set_lmin_lmax_fsky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">fsky</span><span class="p">):</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Take lmin, lmax and fsky parameters and set the corresponding attributes.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        Sets the minimum multipole, the maximum multipole and the sky fraction. This handles automatically the case of a single value or a list of values. Note that the lmin, lmax and fsky for the cross-correlations are set to the geometrical mean of the lmin, lmax and fsky of the two fields. This approximation has been tested and found to be accurate, at least assuming that the two masks of the two considered multipoles are very overlapped.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Parameters:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            lmin (int or list):</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">                Value or list of values of lmin.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">            lmax (int or list):</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">                Value or list of values of lmax.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">            fsky (float or list):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">                Value or list of values of fsky.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="c1"># Set lmin</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">lmin</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple lmin, they must match the number of requested fields with the same order&quot;</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmin</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                    <span class="p">)</span>  <span class="c1"># this approximaiton allows to gain some extra multipoles in the cross-correalation for which the SNR is still good.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmin</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="n">lmin</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="c1"># Set lmax</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lmax</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple lmax, they must match the number of requested fields with the same order&quot;</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                    <span class="p">)</span>  <span class="c1"># this approximaiton allows to gain some extra multipoles in the cross-correalation for which the SNR is still good.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">=</span> <span class="n">lmax</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="c1"># Set fsky</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fsky</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">fsky</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple fsky, they must match the number of requested fields with the same order&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                        <span class="n">fsky</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsky</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                    <span class="p">)</span>  <span class="c1"># this approximation for the cross-correlation is not correct in the case of two very different masks (verified with simulations)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fsky</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsky</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="o">=</span> <span class="n">fsky</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="k">return</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_dict</span><span class="p">):</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill covariance matrix with appropriate spectra.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        Computes the covariance matrix once given a dictionary. Returns the covariance matrix of the considered fields, in a shape equal to (num_fields x num_fields x lmax). Note that if more than one lmax, or lmin, is specified, there will be null values in the matrices, making them singular. This will be handled in another method.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        Parameters:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            cov_dict (dict):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">                The input dictionary of spectra.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="c1"># Initialize output array</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="c1"># Loop over field1</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="c1"># Loop over field2</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">field2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">:]):</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                <span class="c1"># Get the index of field2</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                <span class="c1"># Get the key of the covariance matrix</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">field1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">field2</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="c1"># Get lmin and lmax for this field pair</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="n">lmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="n">lmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="c1"># Get the covariance for this field pair</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="n">cov</span> <span class="o">=</span> <span class="n">cov_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                <span class="c1"># Set the appropriate values in the covariance matrix</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="c1"># Fill the covariance matrix symmetrically</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>    <span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts the keys that has to be used as a function of the requested fields. These will be the usual 2-points, e.g., tt, te, ee, etc.&quot;&quot;&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="c1"># List of all the possible combinations of the requested fields</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="p">]</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="c1"># Print the requested keys</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The requested keys are </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>    <span class="k">def</span> <span class="nf">get_Gauss_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the proper dictionary keys for the requested fields.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">        Extracts the keys that has to be used as a function of the requested fields for the Gaussian likelihood. Indeed, the Gaussian likelihood is computed using 4-points, so the keys are different. E.g., there will be keys such as tttt, ttee, tete, etc.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="c1"># Calculate the number of elements in the covariance matrix</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="c1"># Initialize a 3-d array to store the keys</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="c1"># Loop over all the elements in the covariance matrix</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="c1"># Generate a key for the i-th and j-th element</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                <span class="c1"># Loop over all the characters in the key</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                    <span class="c1"># Add the k-th character to the i-th, j-th, and k-th</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                    <span class="c1"># indices of the array</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">elem</span><span class="p">)[</span><span class="n">k</span><span class="p">])</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="c1"># Print the keys if the debug flag is set</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The requested keys are </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="c1"># Return the keys</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>    <span class="k">def</span> <span class="nf">find_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a spectrum in a given dictionary.</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">        Returns the corresponding power sepctrum for a given key. If the key is not found, it will try to find the reverse key. Otherwise it will fill the array with zeros.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">        Parameters:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">            input_dict (dict):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">                Dictionary where you want to search for keys.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">            key (str):</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">                Key to search for.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="c1"># create a zero array</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="c1"># get lmin and lmax</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">lmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="n">lmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="c1"># try to find the key in the dictionary</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="c1"># if the key is not found, try the reverse key</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="c1"># fill the array with the requested spectrum</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="n">res</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fiduDICT</span><span class="p">,</span> <span class="n">noiseDICT</span><span class="p">):</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the covariance matrix for the Gaussian case.</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        In case of Gaussian likelihood, this returns the covariance matrix needed for the computation of the chi2. Note that the inversion is done in a separate funciton.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        Parameters:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">            keys (dict):</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">                Keys for the covariance elements.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">            fiduDICT (dict):</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">                Dictionary with the fiducial spectra.</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">            noiseDICT (dict):</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">                Dictionary with the noise spectra.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="c1"># The covariance matrix has to be symmetric.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="c1"># The number of parameters in the likelihood is self.n.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="c1"># The covariance matrix is a (self.n x self.n x self.lmax+1) ndarray.</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="c1"># We will store the covariance matrix in a (n x n x self.lmax+1) ndarray,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="c1"># where n = int(self.n * (self.n + 1) / 2).</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># Loop over all combinations of pairs of spectra</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                <span class="n">C_AC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                    <span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="p">)</span>  <span class="c1"># Find the fiducial spectra for each pair</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                <span class="n">C_BD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="n">C_AD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                <span class="n">C_BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                <span class="n">N_AC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                    <span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="p">)</span>  <span class="c1"># Find the noise spectra for each pair</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="n">N_BD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                <span class="n">N_AD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="n">N_BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If self.fsky is defined, use the fsky value</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                        <span class="p">(</span><span class="n">C_AC</span> <span class="o">+</span> <span class="n">N_AC</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_BD</span> <span class="o">+</span> <span class="n">N_BD</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">C_AD</span> <span class="o">+</span> <span class="n">N_AD</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_BC</span> <span class="o">+</span> <span class="n">N_BC</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                    <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, use the fsky values from the input spectra</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                    <span class="n">AC</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                    <span class="n">BD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                    <span class="n">AD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                    <span class="n">BC</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                    <span class="n">AB</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                    <span class="n">CD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AC</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">BD</span><span class="p">])</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_AC</span> <span class="o">+</span> <span class="n">N_AC</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_BD</span> <span class="o">+</span> <span class="n">N_BD</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AD</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">BC</span><span class="p">])</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_AD</span> <span class="o">+</span> <span class="n">N_AD</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_BC</span> <span class="o">+</span> <span class="n">N_BC</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AB</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">CD</span><span class="p">])</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>    <span class="k">def</span> <span class="nf">inv_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the covariance matrix of the Gaussian case.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        Inverts the previously calculated sigma ndarray. Note that some elements may be null, thus the covariance may be singular. If so, this also reduces the dimension of the matrix by deleting the corresponding row and column.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">        Parameters:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">            ndarray (np.ndarray):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">                (self.n x self.n x self.lmax+1) ndarray with the previously computed sigma (not inverted).</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="c1"># Initialize array to store the inverted covariance matrices</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="c1"># Loop over multipoles</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="c1"># Check if matrix is singular</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="n">COV</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="c1"># Get indices of null diagonal elements</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                <span class="c1"># Remove corresponding rows and columns</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="c1"># Invert matrix</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>    <span class="k">def</span> <span class="nf">get_reduced_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the reduced data eliminating the singularity of the matrix.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        Cuts the row and column corresponding to a zero diagonal value. Indeed, in case of different lmax, or lmin, for the fields, you will have singular marices.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        Parameters:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">            ndarray (np.ndarray):</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">                A ndarray containing the covariance matrices, with some singular ones.</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="c1"># Select the indices corresponding to the zero diagonal</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="c1"># Delete the rows and columns from the matrix</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>    <span class="k">def</span> <span class="nf">CAMBres2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camb_results</span><span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes the CAMB result product from get_cmb_power_spectra and convert it to a dictionary with the proper keys.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">        Parameters:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">            camb_results (CAMBdata):</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">                CAMB result product from the method get_cmb_power_spectra.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="c1"># Get the number of multipoles</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">camb_results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="c1"># Mapping between the CAMB keys and the ones we want</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;te&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="c1"># Initialize the output dictionary</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ell&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="c1"># Loop over the keys we want</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="c1"># Save the results</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">camb_results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="c1"># Check if we want the lensing potential</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">if</span> <span class="s2">&quot;pp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="c1"># Get the lensing potential</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">cl_lens</span> <span class="o">=</span> <span class="n">camb_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lens_potential&quot;</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="c1"># Check if it exists</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="k">if</span> <span class="n">cl_lens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="c1"># Save it</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_lens</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                <span class="c1"># Check if we want the cross terms</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="k">if</span> <span class="s2">&quot;pt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="ow">and</span> <span class="s2">&quot;pe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                    <span class="c1"># Loop over the cross terms</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cross</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;pe&quot;</span><span class="p">]):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                        <span class="c1"># Save the result</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                        <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_lens</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                        <span class="c1"># Save the symmetric term</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                        <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">]</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="k">def</span> <span class="nf">txt2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes a txt file and convert it to a dictionary. This requires a way to map the columns to the keys. Also, it is possible to apply an ell factor to the Cls.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        Parameters:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">            txt (str):</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">                Path to txt file containing the spectra as columns.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">            mapping (dict):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">                Dictionary containing the mapping. Keywords will become the new keywords and values represent the index of the corresponding column.</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="c1"># Define the ell values from the length of the txt file</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="n">mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide a way to map the columns of your txt to the keys of a dictionary&quot;</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ell&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="c1"># Loop over the mapping and extract the corresponding column from the txt file</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="c1"># and store it in the dictionary under the corresponding keyword</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="k">if</span> <span class="n">apply_ellfactor</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ls</span> <span class="o">*</span> <span class="p">(</span><span class="n">ls</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="nf">prod_fidu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce fiducial spectra or read the input ones.</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">        If the user has not provided a Cl file, this function will produce the fiducial power spectra starting from the CAMB inifile for Planck2018. The extra keywords defined will maximize the accordance between the fiducial Cls and the ones obtained from Cobaya. If B-modes are requested, the tensor-to-scalar ratio and the spectral tilt will be set to the requested values. Note that if you do not provide a tilt, this will follow the standard single-field consistency relation. If instead you provide a custom file, stores that.</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="c1"># If a custom file is provided, use that</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="c1"># If the file is a pickle file, load it</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="c1"># Otherwise, load it as text file</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                <span class="n">txt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;te&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt2dict</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="kn">import</span> <span class="nn">camb</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAMB seems to be not installed. Check the requirements.&quot;</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="c1"># Read the ini file containing the parameters for CAMB</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="n">planck_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;planck_2018.ini&quot;</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="n">pars</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">read_ini</span><span class="p">(</span><span class="n">planck_path</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>  <span class="c1"># If we want to include the tensor mode</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Producing fiducial spectra for r=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="si">}</span><span class="s2"> and nt=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                <span class="n">As</span><span class="o">=</span><span class="mf">2.100549e-9</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>                <span class="n">ns</span><span class="o">=</span><span class="mf">0.9660499</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>                <span class="n">nt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                <span class="n">pivot_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_t</span><span class="p">,</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>                <span class="n">pivot_scalar</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>                <span class="n">parameterization</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">WantTensors</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">AccurateBB</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="n">pars</span><span class="o">.</span><span class="n">DoLensing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="c1"># _pars.Accuracy.AccuracyBoost = 2 # This helps getting an extra squeeze on the accordance of Cobaya and Fiducial spectra</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_cmb_power_spectra</span><span class="p">(</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="n">CMB_unit</span><span class="o">=</span><span class="s2">&quot;muK&quot;</span><span class="p">,</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="n">lmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">,</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="n">raw_cl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CAMBres2dict</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>    <span class="k">def</span> <span class="nf">prod_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce noise power spectra or read the input ones.</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a><span class="sd">        If the user has not provided a noise file, this function will produce the noise power spectra for a given experiment with inverse noise weighting of white noise in each channel (TT, EE, BB). Note that you may want to have a look at the procedure since it is merely a place-holder. Indeed, you should provide a more realistic file from which to read the noise spectra, given that inverse noise weighting severely underestimates the amount of noise. If instead you provide the proper custom file, this method stores that.</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="c1"># If the input noise file is a pickle file, load it.</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">):</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="c1"># If not, load the file as a text file</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="n">_txt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>                <span class="c1"># Convert the text file to a dictionary</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt2dict</span><span class="p">(</span><span class="n">_txt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>            <span class="s2">&quot;***WARNING***: the inverse noise weighting performed here severely underestimates </span><span class="se">\</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="s2">            the actual noise level of LiteBIRD. You should provide an input </span><span class="se">\</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="s2">            noise power spectrum with a more realistic noise.&quot;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="kn">from</span> <span class="nn">yaml.loader</span> <span class="kn">import</span> <span class="n">SafeLoader</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YAML or Healpy seems to be not installed. Check the requirements.&quot;</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="p">),</span> <span class="s2">&quot;You must specify the experiment you want to consider&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Computing noise for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="n">experiments_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;experiments.yaml&quot;</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">experiments_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="c1"># Get the instrument data from the saved data</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">]</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="c1"># Get the FWHM values from the instrument data</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="n">fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">])</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="c1"># Get the frequency values from the instrument data</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">])</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="c1"># Get the depth values from the instrument data</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="n">depth_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;depth_p&quot;</span><span class="p">])</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="n">depth_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;depth_i&quot;</span><span class="p">])</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="c1"># Convert the depth to a pixel value</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="n">depth_p</span> <span class="o">/=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="n">depth_i</span> <span class="o">/=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="n">depth_p</span> <span class="o">=</span> <span class="n">depth_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="n">hp</span><span class="o">.</span><span class="n">pixelfunc</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>        <span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="n">depth_i</span> <span class="o">=</span> <span class="n">depth_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="n">hp</span><span class="o">.</span><span class="n">pixelfunc</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="c1"># Get the number of frequencies</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        <span class="n">n_freq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="c1"># Define the ell values as a numpy array</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="c1"># Define the keys for the dictionary that will be returned</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">]</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">fwhms</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="c1"># Calculate the Gaussian beam function</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        <span class="c1"># Calculate the polarization factor</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>        <span class="n">pol_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sigma2</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">],</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>        <span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="c1"># Calculate the polarization factor as a function of ell</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="n">pol_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pol_factor</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="c1"># Calculate the Gaussian beam function for each polarization</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pol_factor</span><span class="p">):</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>        <span class="c1"># Initialize the dictionary that will be returned</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="c1"># Calculate the unnormalized power spectra</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_i</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="c1"># Calculate the normalized power spectra</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the fiducial spectra and the noise power spectra.&quot;&quot;&quot;</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="c1"># Compute the fiducial and noise power spectra</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_fidu</span><span class="p">()</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_noise</span><span class="p">()</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="c1"># Compute the covariance matrices</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="c1"># Print some information for debugging</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of fiducial CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of noise CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing the first few values to check that it starts from 0...&quot;</span><span class="p">)</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fiducial CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>        <span class="c1"># Compute the total covariance matrix</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>        <span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>        <span class="c1"># Compute the inverse of the covariance matrix</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Gauss_keys</span><span class="p">()</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>            <span class="n">sigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_sigma</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>    <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Defines requirements of the likelihood, specifying quantities calculated by a theory code are needed. Note that you may want to change the overall keyword from &#39;Cl&#39; to &#39;unlensed_Cl&#39; if you want to work without considering lensing.&quot;&quot;&quot;</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="c1"># The likelihood needs the lensed CMB angular power spectra. The keyword can be set to &quot;unlensed_Cl&quot; to get the unlensed ones</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="n">requitements</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="n">requitements</span><span class="p">[</span><span class="s2">&quot;Cl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cl</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="c1"># If debug is set to True, the likelihood will print the list of items required by the likelihood</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>            <span class="n">requitements</span><span class="p">[</span><span class="s2">&quot;CAMBdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You requested that Cobaya provides to the likelihood the following items: </span><span class="si">{</span><span class="n">requitements</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>            <span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="k">return</span> <span class="n">requitements</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>    <span class="k">def</span> <span class="nf">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov</span><span class="p">):</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data vector from the covariance matrix.</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        Extracts the data vector necessary for the Gaussian case. Note that this will cut the null value since some may be null when the fields have different values for lmax.</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">        Parameters:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">            cov (np.ndarray):</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a><span class="sd">                A ndarray containing the covariance matrices, with some null ones.</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>        <span class="k">return</span> <span class="n">cov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)][</span><span class="n">cov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>    <span class="k">def</span> <span class="nf">chi_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes proper chi-square term for the exact likelihood case.</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a><span class="sd">        Parameters:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a><span class="sd">            i (int, optional):</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        <span class="c1"># If the number of datasets is not equal to 1, then we have a</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="c1"># multi-dataset case, in which case we need to compute the</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="c1"># covariance matrix for each dataset.</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>            <span class="c1"># We extract the covariance matrix and data for the ith</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>            <span class="c1"># dataset.</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>            <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">coba</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>            <span class="c1"># If the determinant is equal to 0, then we need to reduce</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>            <span class="c1"># the dimensionality of the data and covariance matrix.</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>            <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_data</span><span class="p">(</span><span class="n">coba</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>            <span class="c1"># We compute the matrix M using the covariance matrix and</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>            <span class="c1"># the data.</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">coba</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>            <span class="c1"># We compute the chi-square term using the trace of M, the</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>            <span class="c1"># log determinant of M, and the number of fields.</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">M</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>        <span class="c1"># If the number of datasets is equal to 1, then we have a single</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="c1"># dataset case, in which case we do not need to loop over the</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>        <span class="c1"># datasets.</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="c1"># We compute the matrix M using the covariance matrix and</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>            <span class="c1"># the data.</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>            <span class="c1"># We compute the chi-square term using M, the log of M, and</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>            <span class="c1"># a constant value.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>            <span class="k">return</span> <span class="n">M</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">M</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>    <span class="k">def</span> <span class="nf">chi_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes proper chi-square term for the Gaussian likelihood case.</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">        Parameters:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a><span class="sd">            i (int, optional):</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        <span class="c1"># If we have more than one data vector</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>        <span class="c1"># If we have only one data vector</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span> <span class="o">*</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>    <span class="k">def</span> <span class="nf">compute_chi_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Chooses which chi-square term to compute.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a><span class="sd">        Parameters:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a><span class="sd">            i (int, optional):</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>        <span class="c1"># check if the likelihood is &quot;exact&quot;</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;exact&quot;</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>            <span class="c1"># if so, compute the chi-square term for the exact likelihood</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_exact</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>        <span class="c1"># if not, check if it is &quot;gaussian&quot;</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>            <span class="c1"># if so, compute the chi-square term for the gaussian likelihood</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_gaussian</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>        <span class="c1"># if neither, print an error message</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You requested something different from &#39;exact or &#39;gaussian&#39;!&quot;</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>            <span class="k">return</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>    <span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the log likelihood.&quot;&quot;&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>        <span class="c1"># Get the array of multipoles</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>        <span class="c1"># Compute the log likelihood for each multipole</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>            <span class="n">logp_ℓ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ell</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">):</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>                <span class="n">logp_ℓ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chi_part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>            <span class="n">logp_ℓ</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chi_part</span><span class="p">()</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>        <span class="c1"># Sum the log likelihood over multipoles</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logp_ℓ</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params_values</span><span class="p">):</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the log likelihood and pass it to Cobaya to carry on the MCMC process.&quot;&quot;&quot;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>            <span class="n">CAMBdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">get_CAMBdata</span><span class="p">()</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>            <span class="n">pars</span> <span class="o">=</span> <span class="n">CAMBdata</span><span class="o">.</span><span class="n">Params</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>        <span class="c1"># Get the Cls from Cobaya</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">get_Cl</span><span class="p">(</span><span class="n">ell_factor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of Cobaya CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing the first few values to check that it starts from 0...&quot;</span><span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cobaya CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>        <span class="c1"># Fill the covariance matrix with the Cls from Cobaya</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>            <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fiducial CLs&quot;</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cobaya CLs&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Noise CLs&quot;</span><span class="p">)</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>        <span class="c1"># Add the noise covariance to the covariance matrix filled with the Cls from Cobaya</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coba</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>        <span class="p">)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>        <span class="c1"># Compute the likelihood</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>        <span class="n">logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">()</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">logp</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>            <span class="n">exit</span><span class="p">()</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>        <span class="k">return</span> <span class="n">logp</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LiLit&quot;</span><span class="p">]</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a><span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;google&quot;</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a><span class="n">__pdoc__</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a><span class="n">__pdoc__</span><span class="p">[</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>    <span class="s2">&quot;Likelihood&quot;</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Likelihood class from Cobaya, refer to Cobaya documentation for more information.&quot;</span>
</span></pre></div>


            </section>
                <section id="LiLit">
                            <input id="LiLit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LiLit</span><wbr>(<span class="base">cobaya.likelihood.Likelihood</span>):

                <label class="view-source-button" for="LiLit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit-10"><a href="#LiLit-10"><span class="linenos"> 10</span></a><span class="k">class</span> <span class="nc">LiLit</span><span class="p">(</span><span class="n">Likelihood</span><span class="p">):</span>
</span><span id="LiLit-11"><a href="#LiLit-11"><span class="linenos"> 11</span></a>
</span><span id="LiLit-12"><a href="#LiLit-12"><span class="linenos"> 12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class defining the Likelihood for LiteBIRD (LiLit).</span>
</span><span id="LiLit-13"><a href="#LiLit-13"><span class="linenos"> 13</span></a>
</span><span id="LiLit-14"><a href="#LiLit-14"><span class="linenos"> 14</span></a><span class="sd">    Within LiLit, the most relevant study cases of LiteBIRD (T, E, B) are already tested and working. So, if you need to work with those, you should not need to look into the actual definition of the likelihood function, since you can proptly start running your MCMCs. Despite this, you should provide to the likelihood some file where to find the proper LiteBIRD noise power spectra, given that LiLit is implementing a simple inverse noise weighting just as a place-holder for something more realistic. As regards lensing, LiLit will need you to pass the reconstruction noise, since its computation is not coded, thus there is no place-holder for lensing.</span>
</span><span id="LiLit-15"><a href="#LiLit-15"><span class="linenos"> 15</span></a>
</span><span id="LiLit-16"><a href="#LiLit-16"><span class="linenos"> 16</span></a><span class="sd">    Parameters:</span>
</span><span id="LiLit-17"><a href="#LiLit-17"><span class="linenos"> 17</span></a><span class="sd">        name (str):</span>
</span><span id="LiLit-18"><a href="#LiLit-18"><span class="linenos"> 18</span></a><span class="sd">            The name for the likelihood, used in the output. It is necessary to pass it to LiLit. (default: None).</span>
</span><span id="LiLit-19"><a href="#LiLit-19"><span class="linenos"> 19</span></a><span class="sd">        fields (list):</span>
</span><span id="LiLit-20"><a href="#LiLit-20"><span class="linenos"> 20</span></a><span class="sd">            List of fields in the data file (default: None).</span>
</span><span id="LiLit-21"><a href="#LiLit-21"><span class="linenos"> 21</span></a><span class="sd">        lmax (int or list):</span>
</span><span id="LiLit-22"><a href="#LiLit-22"><span class="linenos"> 22</span></a><span class="sd">            Maximum multipole to consider (default: None).</span>
</span><span id="LiLit-23"><a href="#LiLit-23"><span class="linenos"> 23</span></a><span class="sd">        like (str, optional):</span>
</span><span id="LiLit-24"><a href="#LiLit-24"><span class="linenos"> 24</span></a><span class="sd">            Type of likelihood to use (default: &quot;exact&quot;). Currently supports &quot;exact&quot; and &quot;gaussian&quot;.</span>
</span><span id="LiLit-25"><a href="#LiLit-25"><span class="linenos"> 25</span></a><span class="sd">        lmin (int or list):</span>
</span><span id="LiLit-26"><a href="#LiLit-26"><span class="linenos"> 26</span></a><span class="sd">            Minimum multipole to consider (default: 2).</span>
</span><span id="LiLit-27"><a href="#LiLit-27"><span class="linenos"> 27</span></a><span class="sd">        cl_file (str, optional):</span>
</span><span id="LiLit-28"><a href="#LiLit-28"><span class="linenos"> 28</span></a><span class="sd">            Path to Cl file (default: None).</span>
</span><span id="LiLit-29"><a href="#LiLit-29"><span class="linenos"> 29</span></a><span class="sd">        nl_file (str, optional):</span>
</span><span id="LiLit-30"><a href="#LiLit-30"><span class="linenos"> 30</span></a><span class="sd">            Path to noise file (default: None).</span>
</span><span id="LiLit-31"><a href="#LiLit-31"><span class="linenos"> 31</span></a><span class="sd">        mapping (dict, optional):</span>
</span><span id="LiLit-32"><a href="#LiLit-32"><span class="linenos"> 32</span></a><span class="sd">            Dictionary of mapping between the fields in the noise file and the fields in the likelihood, used only if nl_file has .txt extension (default: None).</span>
</span><span id="LiLit-33"><a href="#LiLit-33"><span class="linenos"> 33</span></a><span class="sd">        experiment (str, optional):</span>
</span><span id="LiLit-34"><a href="#LiLit-34"><span class="linenos"> 34</span></a><span class="sd">            Name of experiment (default: None).</span>
</span><span id="LiLit-35"><a href="#LiLit-35"><span class="linenos"> 35</span></a><span class="sd">        nside (int, optional):</span>
</span><span id="LiLit-36"><a href="#LiLit-36"><span class="linenos"> 36</span></a><span class="sd">            Nside of the map (default: None).</span>
</span><span id="LiLit-37"><a href="#LiLit-37"><span class="linenos"> 37</span></a><span class="sd">        r (float, optional):</span>
</span><span id="LiLit-38"><a href="#LiLit-38"><span class="linenos"> 38</span></a><span class="sd">            Tensor-to-scalar ratio (default: None).</span>
</span><span id="LiLit-39"><a href="#LiLit-39"><span class="linenos"> 39</span></a><span class="sd">        nt (float, optional):</span>
</span><span id="LiLit-40"><a href="#LiLit-40"><span class="linenos"> 40</span></a><span class="sd">            Tensor spectral tilt (default: None).</span>
</span><span id="LiLit-41"><a href="#LiLit-41"><span class="linenos"> 41</span></a><span class="sd">        pivot_t (float, optional):</span>
</span><span id="LiLit-42"><a href="#LiLit-42"><span class="linenos"> 42</span></a><span class="sd">            Pivot scale of the tensor primordial power spectrum (default: 0.01).</span>
</span><span id="LiLit-43"><a href="#LiLit-43"><span class="linenos"> 43</span></a><span class="sd">        fsky (float or list):</span>
</span><span id="LiLit-44"><a href="#LiLit-44"><span class="linenos"> 44</span></a><span class="sd">            Sky fraction (default: 1).</span>
</span><span id="LiLit-45"><a href="#LiLit-45"><span class="linenos"> 45</span></a><span class="sd">        sep (str, optional):</span>
</span><span id="LiLit-46"><a href="#LiLit-46"><span class="linenos"> 46</span></a><span class="sd">            Separator used in the data file (default: &quot;&quot;).</span>
</span><span id="LiLit-47"><a href="#LiLit-47"><span class="linenos"> 47</span></a><span class="sd">        debug (bool, optional):</span>
</span><span id="LiLit-48"><a href="#LiLit-48"><span class="linenos"> 48</span></a><span class="sd">            If True, produces more verbose output (default: None).</span>
</span><span id="LiLit-49"><a href="#LiLit-49"><span class="linenos"> 49</span></a>
</span><span id="LiLit-50"><a href="#LiLit-50"><span class="linenos"> 50</span></a>
</span><span id="LiLit-51"><a href="#LiLit-51"><span class="linenos"> 51</span></a><span class="sd">    Attributes:</span>
</span><span id="LiLit-52"><a href="#LiLit-52"><span class="linenos"> 52</span></a><span class="sd">        fields (list):</span>
</span><span id="LiLit-53"><a href="#LiLit-53"><span class="linenos"> 53</span></a><span class="sd">            List of fields in the data file.</span>
</span><span id="LiLit-54"><a href="#LiLit-54"><span class="linenos"> 54</span></a><span class="sd">        n_fields (int):</span>
</span><span id="LiLit-55"><a href="#LiLit-55"><span class="linenos"> 55</span></a><span class="sd">            Number of fields.</span>
</span><span id="LiLit-56"><a href="#LiLit-56"><span class="linenos"> 56</span></a><span class="sd">        keys (list):</span>
</span><span id="LiLit-57"><a href="#LiLit-57"><span class="linenos"> 57</span></a><span class="sd">            List of keywords for the dictionaries.</span>
</span><span id="LiLit-58"><a href="#LiLit-58"><span class="linenos"> 58</span></a><span class="sd">        gauss_keys (list):</span>
</span><span id="LiLit-59"><a href="#LiLit-59"><span class="linenos"> 59</span></a><span class="sd">            List of keywords for the Gaussian likelihood (4-points).</span>
</span><span id="LiLit-60"><a href="#LiLit-60"><span class="linenos"> 60</span></a><span class="sd">        sigma2 (np.ndarray):</span>
</span><span id="LiLit-61"><a href="#LiLit-61"><span class="linenos"> 61</span></a><span class="sd">            Array of covariances for the Gaussian likelihood case.</span>
</span><span id="LiLit-62"><a href="#LiLit-62"><span class="linenos"> 62</span></a><span class="sd">        lmax (int or list):</span>
</span><span id="LiLit-63"><a href="#LiLit-63"><span class="linenos"> 63</span></a><span class="sd">            List of lmax values.</span>
</span><span id="LiLit-64"><a href="#LiLit-64"><span class="linenos"> 64</span></a><span class="sd">        lmaxes (dict):</span>
</span><span id="LiLit-65"><a href="#LiLit-65"><span class="linenos"> 65</span></a><span class="sd">            Dictionary of lmax values.</span>
</span><span id="LiLit-66"><a href="#LiLit-66"><span class="linenos"> 66</span></a><span class="sd">        fsky (int or list):</span>
</span><span id="LiLit-67"><a href="#LiLit-67"><span class="linenos"> 67</span></a><span class="sd">            List of fsky values.</span>
</span><span id="LiLit-68"><a href="#LiLit-68"><span class="linenos"> 68</span></a><span class="sd">        fskies (dict):</span>
</span><span id="LiLit-69"><a href="#LiLit-69"><span class="linenos"> 69</span></a><span class="sd">            Dictionary of fsky values.</span>
</span><span id="LiLit-70"><a href="#LiLit-70"><span class="linenos"> 70</span></a><span class="sd">        lmin (int or list):</span>
</span><span id="LiLit-71"><a href="#LiLit-71"><span class="linenos"> 71</span></a><span class="sd">            Minimum multipole to consider.</span>
</span><span id="LiLit-72"><a href="#LiLit-72"><span class="linenos"> 72</span></a><span class="sd">        lmins (dict):</span>
</span><span id="LiLit-73"><a href="#LiLit-73"><span class="linenos"> 73</span></a><span class="sd">            Dictionary of lmin values.</span>
</span><span id="LiLit-74"><a href="#LiLit-74"><span class="linenos"> 74</span></a><span class="sd">        like (str):</span>
</span><span id="LiLit-75"><a href="#LiLit-75"><span class="linenos"> 75</span></a><span class="sd">            Type of likelihood to use.</span>
</span><span id="LiLit-76"><a href="#LiLit-76"><span class="linenos"> 76</span></a><span class="sd">        cl_file (str):</span>
</span><span id="LiLit-77"><a href="#LiLit-77"><span class="linenos"> 77</span></a><span class="sd">            Path to Cl file.</span>
</span><span id="LiLit-78"><a href="#LiLit-78"><span class="linenos"> 78</span></a><span class="sd">        fiduCLS (dict):</span>
</span><span id="LiLit-79"><a href="#LiLit-79"><span class="linenos"> 79</span></a><span class="sd">            Dictionary of fiducial Cls.</span>
</span><span id="LiLit-80"><a href="#LiLit-80"><span class="linenos"> 80</span></a><span class="sd">        noiseCLS (dict):</span>
</span><span id="LiLit-81"><a href="#LiLit-81"><span class="linenos"> 81</span></a><span class="sd">            Dictionary of noise Cls.</span>
</span><span id="LiLit-82"><a href="#LiLit-82"><span class="linenos"> 82</span></a><span class="sd">        fiduCOV (np.ndarray):</span>
</span><span id="LiLit-83"><a href="#LiLit-83"><span class="linenos"> 83</span></a><span class="sd">            Fiducial covariance matrix obtained from the corresponding dictionary.</span>
</span><span id="LiLit-84"><a href="#LiLit-84"><span class="linenos"> 84</span></a><span class="sd">        noiseCOV (np.ndarray):</span>
</span><span id="LiLit-85"><a href="#LiLit-85"><span class="linenos"> 85</span></a><span class="sd">            Noise covariance matrix obtained from the corresponding dictionary.</span>
</span><span id="LiLit-86"><a href="#LiLit-86"><span class="linenos"> 86</span></a><span class="sd">        data (np.ndarray):</span>
</span><span id="LiLit-87"><a href="#LiLit-87"><span class="linenos"> 87</span></a><span class="sd">            Data vector obtained by summing fiduCOV + noiseCOV.</span>
</span><span id="LiLit-88"><a href="#LiLit-88"><span class="linenos"> 88</span></a><span class="sd">        cobaCLS (dict):</span>
</span><span id="LiLit-89"><a href="#LiLit-89"><span class="linenos"> 89</span></a><span class="sd">            Dictionary of Cobaya Cls.</span>
</span><span id="LiLit-90"><a href="#LiLit-90"><span class="linenos"> 90</span></a><span class="sd">        cobaCOV (np.ndarray):</span>
</span><span id="LiLit-91"><a href="#LiLit-91"><span class="linenos"> 91</span></a><span class="sd">            Cobaya covariance matrix obtained from the corresponding dictionary.</span>
</span><span id="LiLit-92"><a href="#LiLit-92"><span class="linenos"> 92</span></a><span class="sd">        coba (np.ndarray):</span>
</span><span id="LiLit-93"><a href="#LiLit-93"><span class="linenos"> 93</span></a><span class="sd">            Cobaya vector obtained by summing cobaCOV + noiseCOV.</span>
</span><span id="LiLit-94"><a href="#LiLit-94"><span class="linenos"> 94</span></a><span class="sd">        nl_file (str):</span>
</span><span id="LiLit-95"><a href="#LiLit-95"><span class="linenos"> 95</span></a><span class="sd">            Path to noise file.</span>
</span><span id="LiLit-96"><a href="#LiLit-96"><span class="linenos"> 96</span></a><span class="sd">        mapping (dict):</span>
</span><span id="LiLit-97"><a href="#LiLit-97"><span class="linenos"> 97</span></a><span class="sd">            Dictionary of mapping between the fields in the noise file and the fields in the likelihood, used only if nl_file has .txt extension.</span>
</span><span id="LiLit-98"><a href="#LiLit-98"><span class="linenos"> 98</span></a><span class="sd">        experiment (str):</span>
</span><span id="LiLit-99"><a href="#LiLit-99"><span class="linenos"> 99</span></a><span class="sd">            Name of experiment.</span>
</span><span id="LiLit-100"><a href="#LiLit-100"><span class="linenos">100</span></a><span class="sd">        nside (int):</span>
</span><span id="LiLit-101"><a href="#LiLit-101"><span class="linenos">101</span></a><span class="sd">            Nside of the map.</span>
</span><span id="LiLit-102"><a href="#LiLit-102"><span class="linenos">102</span></a><span class="sd">        r (float):</span>
</span><span id="LiLit-103"><a href="#LiLit-103"><span class="linenos">103</span></a><span class="sd">            Tensor-to-scalar ratio.</span>
</span><span id="LiLit-104"><a href="#LiLit-104"><span class="linenos">104</span></a><span class="sd">        nt (float):</span>
</span><span id="LiLit-105"><a href="#LiLit-105"><span class="linenos">105</span></a><span class="sd">            Tensor spectral tilt.</span>
</span><span id="LiLit-106"><a href="#LiLit-106"><span class="linenos">106</span></a><span class="sd">        pivot_t (float):</span>
</span><span id="LiLit-107"><a href="#LiLit-107"><span class="linenos">107</span></a><span class="sd">            Pivot scale of the tensor primordial power spectrum.</span>
</span><span id="LiLit-108"><a href="#LiLit-108"><span class="linenos">108</span></a><span class="sd">        sep (str):</span>
</span><span id="LiLit-109"><a href="#LiLit-109"><span class="linenos">109</span></a><span class="sd">            Separator used in the data file.</span>
</span><span id="LiLit-110"><a href="#LiLit-110"><span class="linenos">110</span></a><span class="sd">        debug (bool):</span>
</span><span id="LiLit-111"><a href="#LiLit-111"><span class="linenos">111</span></a><span class="sd">            If True, produces more output.</span>
</span><span id="LiLit-112"><a href="#LiLit-112"><span class="linenos">112</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LiLit-113"><a href="#LiLit-113"><span class="linenos">113</span></a>
</span><span id="LiLit-114"><a href="#LiLit-114"><span class="linenos">114</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="LiLit-115"><a href="#LiLit-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LiLit-116"><a href="#LiLit-116"><span class="linenos">116</span></a>        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-117"><a href="#LiLit-117"><span class="linenos">117</span></a>        <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-118"><a href="#LiLit-118"><span class="linenos">118</span></a>        <span class="n">lmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-119"><a href="#LiLit-119"><span class="linenos">119</span></a>        <span class="n">like</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span>
</span><span id="LiLit-120"><a href="#LiLit-120"><span class="linenos">120</span></a>        <span class="n">lmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="LiLit-121"><a href="#LiLit-121"><span class="linenos">121</span></a>        <span class="n">cl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-122"><a href="#LiLit-122"><span class="linenos">122</span></a>        <span class="n">nl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-123"><a href="#LiLit-123"><span class="linenos">123</span></a>        <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-124"><a href="#LiLit-124"><span class="linenos">124</span></a>        <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-125"><a href="#LiLit-125"><span class="linenos">125</span></a>        <span class="n">nside</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-126"><a href="#LiLit-126"><span class="linenos">126</span></a>        <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-127"><a href="#LiLit-127"><span class="linenos">127</span></a>        <span class="n">nt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-128"><a href="#LiLit-128"><span class="linenos">128</span></a>        <span class="n">pivot_t</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span id="LiLit-129"><a href="#LiLit-129"><span class="linenos">129</span></a>        <span class="n">fsky</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="LiLit-130"><a href="#LiLit-130"><span class="linenos">130</span></a>        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="LiLit-131"><a href="#LiLit-131"><span class="linenos">131</span></a>        <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit-132"><a href="#LiLit-132"><span class="linenos">132</span></a>    <span class="p">):</span>
</span><span id="LiLit-133"><a href="#LiLit-133"><span class="linenos">133</span></a>        <span class="c1"># Check that the user has provided the name of the likelihood</span>
</span><span id="LiLit-134"><a href="#LiLit-134"><span class="linenos">134</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-135"><a href="#LiLit-135"><span class="linenos">135</span></a>            <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit-136"><a href="#LiLit-136"><span class="linenos">136</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide the name of the likelihood (e.g. &#39;BB&#39; or &#39;TTTEEE&#39;)&quot;</span>
</span><span id="LiLit-137"><a href="#LiLit-137"><span class="linenos">137</span></a>        <span class="c1"># Check that the user has provided the fields</span>
</span><span id="LiLit-138"><a href="#LiLit-138"><span class="linenos">138</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-139"><a href="#LiLit-139"><span class="linenos">139</span></a>            <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit-140"><a href="#LiLit-140"><span class="linenos">140</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide the fields (e.g. &#39;b&#39; or [&#39;t&#39;, &#39;e&#39;])&quot;</span>
</span><span id="LiLit-141"><a href="#LiLit-141"><span class="linenos">141</span></a>        <span class="c1"># Check that the user has provided the maximum multipole</span>
</span><span id="LiLit-142"><a href="#LiLit-142"><span class="linenos">142</span></a>        <span class="k">assert</span> <span class="n">lmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must provide the lmax (e.g. 300)&quot;</span>
</span><span id="LiLit-143"><a href="#LiLit-143"><span class="linenos">143</span></a>
</span><span id="LiLit-144"><a href="#LiLit-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
</span><span id="LiLit-145"><a href="#LiLit-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</span><span id="LiLit-146"><a href="#LiLit-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="n">lmin</span>
</span><span id="LiLit-147"><a href="#LiLit-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">=</span> <span class="n">like</span>
</span><span id="LiLit-148"><a href="#LiLit-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span>
</span><span id="LiLit-149"><a href="#LiLit-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span> <span class="o">=</span> <span class="n">cl_file</span>
</span><span id="LiLit-150"><a href="#LiLit-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span> <span class="o">=</span> <span class="n">nl_file</span>
</span><span id="LiLit-151"><a href="#LiLit-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
</span><span id="LiLit-152"><a href="#LiLit-152"><span class="linenos">152</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>
</span><span id="LiLit-153"><a href="#LiLit-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span>
</span><span id="LiLit-154"><a href="#LiLit-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit-155"><a href="#LiLit-155"><span class="linenos">155</span></a>            <span class="c1"># Check that the user has provided the nside if an experiment is used</span>
</span><span id="LiLit-156"><a href="#LiLit-156"><span class="linenos">156</span></a>            <span class="k">assert</span> <span class="n">nside</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must provide an nside to compute the noise&quot;</span>
</span><span id="LiLit-157"><a href="#LiLit-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="n">nside</span>
</span><span id="LiLit-158"><a href="#LiLit-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="LiLit-159"><a href="#LiLit-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">()</span>
</span><span id="LiLit-160"><a href="#LiLit-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="LiLit-161"><a href="#LiLit-161"><span class="linenos">161</span></a>            <span class="c1"># Check that the user has provided the tensor-to-scalar ratio if a BB likelihood is used</span>
</span><span id="LiLit-162"><a href="#LiLit-162"><span class="linenos">162</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-163"><a href="#LiLit-163"><span class="linenos">163</span></a>                <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit-164"><a href="#LiLit-164"><span class="linenos">164</span></a>            <span class="p">),</span> <span class="s2">&quot;You must provide the tensor-to-scalar ratio r for the fiducial production (defaul is at 0.01 Mpc^-1)&quot;</span>
</span><span id="LiLit-165"><a href="#LiLit-165"><span class="linenos">165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="LiLit-166"><a href="#LiLit-166"><span class="linenos">166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nt</span>
</span><span id="LiLit-167"><a href="#LiLit-167"><span class="linenos">167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pivot_t</span> <span class="o">=</span> <span class="n">pivot_t</span>
</span><span id="LiLit-168"><a href="#LiLit-168"><span class="linenos">168</span></a>
</span><span id="LiLit-169"><a href="#LiLit-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_lmin_lmax_fsky</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">fsky</span><span class="p">)</span>
</span><span id="LiLit-170"><a href="#LiLit-170"><span class="linenos">170</span></a>
</span><span id="LiLit-171"><a href="#LiLit-171"><span class="linenos">171</span></a>        <span class="n">Likelihood</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="LiLit-172"><a href="#LiLit-172"><span class="linenos">172</span></a>
</span><span id="LiLit-173"><a href="#LiLit-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">set_lmin_lmax_fsky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">fsky</span><span class="p">):</span>
</span><span id="LiLit-174"><a href="#LiLit-174"><span class="linenos">174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Take lmin, lmax and fsky parameters and set the corresponding attributes.</span>
</span><span id="LiLit-175"><a href="#LiLit-175"><span class="linenos">175</span></a>
</span><span id="LiLit-176"><a href="#LiLit-176"><span class="linenos">176</span></a><span class="sd">        Sets the minimum multipole, the maximum multipole and the sky fraction. This handles automatically the case of a single value or a list of values. Note that the lmin, lmax and fsky for the cross-correlations are set to the geometrical mean of the lmin, lmax and fsky of the two fields. This approximation has been tested and found to be accurate, at least assuming that the two masks of the two considered multipoles are very overlapped.</span>
</span><span id="LiLit-177"><a href="#LiLit-177"><span class="linenos">177</span></a>
</span><span id="LiLit-178"><a href="#LiLit-178"><span class="linenos">178</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-179"><a href="#LiLit-179"><span class="linenos">179</span></a><span class="sd">            lmin (int or list):</span>
</span><span id="LiLit-180"><a href="#LiLit-180"><span class="linenos">180</span></a><span class="sd">                Value or list of values of lmin.</span>
</span><span id="LiLit-181"><a href="#LiLit-181"><span class="linenos">181</span></a><span class="sd">            lmax (int or list):</span>
</span><span id="LiLit-182"><a href="#LiLit-182"><span class="linenos">182</span></a><span class="sd">                Value or list of values of lmax.</span>
</span><span id="LiLit-183"><a href="#LiLit-183"><span class="linenos">183</span></a><span class="sd">            fsky (float or list):</span>
</span><span id="LiLit-184"><a href="#LiLit-184"><span class="linenos">184</span></a><span class="sd">                Value or list of values of fsky.</span>
</span><span id="LiLit-185"><a href="#LiLit-185"><span class="linenos">185</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-186"><a href="#LiLit-186"><span class="linenos">186</span></a>
</span><span id="LiLit-187"><a href="#LiLit-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit-188"><a href="#LiLit-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit-189"><a href="#LiLit-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit-190"><a href="#LiLit-190"><span class="linenos">190</span></a>
</span><span id="LiLit-191"><a href="#LiLit-191"><span class="linenos">191</span></a>        <span class="c1"># Set lmin</span>
</span><span id="LiLit-192"><a href="#LiLit-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="LiLit-193"><a href="#LiLit-193"><span class="linenos">193</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-194"><a href="#LiLit-194"><span class="linenos">194</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">lmin</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="LiLit-195"><a href="#LiLit-195"><span class="linenos">195</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple lmin, they must match the number of requested fields with the same order&quot;</span>
</span><span id="LiLit-196"><a href="#LiLit-196"><span class="linenos">196</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-197"><a href="#LiLit-197"><span class="linenos">197</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-198"><a href="#LiLit-198"><span class="linenos">198</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-199"><a href="#LiLit-199"><span class="linenos">199</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="LiLit-200"><a href="#LiLit-200"><span class="linenos">200</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmin</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span id="LiLit-201"><a href="#LiLit-201"><span class="linenos">201</span></a>                    <span class="p">)</span>  <span class="c1"># this approximaiton allows to gain some extra multipoles in the cross-correalation for which the SNR is still good.</span>
</span><span id="LiLit-202"><a href="#LiLit-202"><span class="linenos">202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmin</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="LiLit-203"><a href="#LiLit-203"><span class="linenos">203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="LiLit-204"><a href="#LiLit-204"><span class="linenos">204</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-205"><a href="#LiLit-205"><span class="linenos">205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="n">lmin</span>
</span><span id="LiLit-206"><a href="#LiLit-206"><span class="linenos">206</span></a>
</span><span id="LiLit-207"><a href="#LiLit-207"><span class="linenos">207</span></a>        <span class="c1"># Set lmax</span>
</span><span id="LiLit-208"><a href="#LiLit-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lmax</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="LiLit-209"><a href="#LiLit-209"><span class="linenos">209</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-210"><a href="#LiLit-210"><span class="linenos">210</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="LiLit-211"><a href="#LiLit-211"><span class="linenos">211</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple lmax, they must match the number of requested fields with the same order&quot;</span>
</span><span id="LiLit-212"><a href="#LiLit-212"><span class="linenos">212</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-213"><a href="#LiLit-213"><span class="linenos">213</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-214"><a href="#LiLit-214"><span class="linenos">214</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-215"><a href="#LiLit-215"><span class="linenos">215</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="LiLit-216"><a href="#LiLit-216"><span class="linenos">216</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span id="LiLit-217"><a href="#LiLit-217"><span class="linenos">217</span></a>                    <span class="p">)</span>  <span class="c1"># this approximaiton allows to gain some extra multipoles in the cross-correalation for which the SNR is still good.</span>
</span><span id="LiLit-218"><a href="#LiLit-218"><span class="linenos">218</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="LiLit-219"><a href="#LiLit-219"><span class="linenos">219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="LiLit-220"><a href="#LiLit-220"><span class="linenos">220</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-221"><a href="#LiLit-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">=</span> <span class="n">lmax</span>
</span><span id="LiLit-222"><a href="#LiLit-222"><span class="linenos">222</span></a>
</span><span id="LiLit-223"><a href="#LiLit-223"><span class="linenos">223</span></a>        <span class="c1"># Set fsky</span>
</span><span id="LiLit-224"><a href="#LiLit-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fsky</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="LiLit-225"><a href="#LiLit-225"><span class="linenos">225</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-226"><a href="#LiLit-226"><span class="linenos">226</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">fsky</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="LiLit-227"><a href="#LiLit-227"><span class="linenos">227</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple fsky, they must match the number of requested fields with the same order&quot;</span>
</span><span id="LiLit-228"><a href="#LiLit-228"><span class="linenos">228</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-229"><a href="#LiLit-229"><span class="linenos">229</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-230"><a href="#LiLit-230"><span class="linenos">230</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-231"><a href="#LiLit-231"><span class="linenos">231</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="LiLit-232"><a href="#LiLit-232"><span class="linenos">232</span></a>                        <span class="n">fsky</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsky</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-233"><a href="#LiLit-233"><span class="linenos">233</span></a>                    <span class="p">)</span>  <span class="c1"># this approximation for the cross-correlation is not correct in the case of two very different masks (verified with simulations)</span>
</span><span id="LiLit-234"><a href="#LiLit-234"><span class="linenos">234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fsky</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsky</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="LiLit-235"><a href="#LiLit-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LiLit-236"><a href="#LiLit-236"><span class="linenos">236</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-237"><a href="#LiLit-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="o">=</span> <span class="n">fsky</span>
</span><span id="LiLit-238"><a href="#LiLit-238"><span class="linenos">238</span></a>        <span class="k">return</span>
</span><span id="LiLit-239"><a href="#LiLit-239"><span class="linenos">239</span></a>
</span><span id="LiLit-240"><a href="#LiLit-240"><span class="linenos">240</span></a>    <span class="k">def</span> <span class="nf">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_dict</span><span class="p">):</span>
</span><span id="LiLit-241"><a href="#LiLit-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill covariance matrix with appropriate spectra.</span>
</span><span id="LiLit-242"><a href="#LiLit-242"><span class="linenos">242</span></a>
</span><span id="LiLit-243"><a href="#LiLit-243"><span class="linenos">243</span></a><span class="sd">        Computes the covariance matrix once given a dictionary. Returns the covariance matrix of the considered fields, in a shape equal to (num_fields x num_fields x lmax). Note that if more than one lmax, or lmin, is specified, there will be null values in the matrices, making them singular. This will be handled in another method.</span>
</span><span id="LiLit-244"><a href="#LiLit-244"><span class="linenos">244</span></a>
</span><span id="LiLit-245"><a href="#LiLit-245"><span class="linenos">245</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-246"><a href="#LiLit-246"><span class="linenos">246</span></a><span class="sd">            cov_dict (dict):</span>
</span><span id="LiLit-247"><a href="#LiLit-247"><span class="linenos">247</span></a><span class="sd">                The input dictionary of spectra.</span>
</span><span id="LiLit-248"><a href="#LiLit-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-249"><a href="#LiLit-249"><span class="linenos">249</span></a>        <span class="c1"># Initialize output array</span>
</span><span id="LiLit-250"><a href="#LiLit-250"><span class="linenos">250</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit-251"><a href="#LiLit-251"><span class="linenos">251</span></a>
</span><span id="LiLit-252"><a href="#LiLit-252"><span class="linenos">252</span></a>        <span class="c1"># Loop over field1</span>
</span><span id="LiLit-253"><a href="#LiLit-253"><span class="linenos">253</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
</span><span id="LiLit-254"><a href="#LiLit-254"><span class="linenos">254</span></a>            <span class="c1"># Loop over field2</span>
</span><span id="LiLit-255"><a href="#LiLit-255"><span class="linenos">255</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">field2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">:]):</span>
</span><span id="LiLit-256"><a href="#LiLit-256"><span class="linenos">256</span></a>                <span class="c1"># Get the index of field2</span>
</span><span id="LiLit-257"><a href="#LiLit-257"><span class="linenos">257</span></a>                <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span>
</span><span id="LiLit-258"><a href="#LiLit-258"><span class="linenos">258</span></a>
</span><span id="LiLit-259"><a href="#LiLit-259"><span class="linenos">259</span></a>                <span class="c1"># Get the key of the covariance matrix</span>
</span><span id="LiLit-260"><a href="#LiLit-260"><span class="linenos">260</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">field1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">field2</span>
</span><span id="LiLit-261"><a href="#LiLit-261"><span class="linenos">261</span></a>
</span><span id="LiLit-262"><a href="#LiLit-262"><span class="linenos">262</span></a>                <span class="c1"># Get lmin and lmax for this field pair</span>
</span><span id="LiLit-263"><a href="#LiLit-263"><span class="linenos">263</span></a>                <span class="n">lmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="LiLit-264"><a href="#LiLit-264"><span class="linenos">264</span></a>                <span class="n">lmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="LiLit-265"><a href="#LiLit-265"><span class="linenos">265</span></a>
</span><span id="LiLit-266"><a href="#LiLit-266"><span class="linenos">266</span></a>                <span class="c1"># Get the covariance for this field pair</span>
</span><span id="LiLit-267"><a href="#LiLit-267"><span class="linenos">267</span></a>                <span class="n">cov</span> <span class="o">=</span> <span class="n">cov_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit-268"><a href="#LiLit-268"><span class="linenos">268</span></a>
</span><span id="LiLit-269"><a href="#LiLit-269"><span class="linenos">269</span></a>                <span class="c1"># Set the appropriate values in the covariance matrix</span>
</span><span id="LiLit-270"><a href="#LiLit-270"><span class="linenos">270</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-271"><a href="#LiLit-271"><span class="linenos">271</span></a>                <span class="c1"># Fill the covariance matrix symmetrically</span>
</span><span id="LiLit-272"><a href="#LiLit-272"><span class="linenos">272</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-273"><a href="#LiLit-273"><span class="linenos">273</span></a>
</span><span id="LiLit-274"><a href="#LiLit-274"><span class="linenos">274</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-275"><a href="#LiLit-275"><span class="linenos">275</span></a>
</span><span id="LiLit-276"><a href="#LiLit-276"><span class="linenos">276</span></a>    <span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-277"><a href="#LiLit-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts the keys that has to be used as a function of the requested fields. These will be the usual 2-points, e.g., tt, te, ee, etc.&quot;&quot;&quot;</span>
</span><span id="LiLit-278"><a href="#LiLit-278"><span class="linenos">278</span></a>        <span class="c1"># List of all the possible combinations of the requested fields</span>
</span><span id="LiLit-279"><a href="#LiLit-279"><span class="linenos">279</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LiLit-280"><a href="#LiLit-280"><span class="linenos">280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-281"><a href="#LiLit-281"><span class="linenos">281</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span><span id="LiLit-282"><a href="#LiLit-282"><span class="linenos">282</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span><span id="LiLit-283"><a href="#LiLit-283"><span class="linenos">283</span></a>        <span class="p">]</span>
</span><span id="LiLit-284"><a href="#LiLit-284"><span class="linenos">284</span></a>        <span class="c1"># Print the requested keys</span>
</span><span id="LiLit-285"><a href="#LiLit-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-286"><a href="#LiLit-286"><span class="linenos">286</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The requested keys are </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-287"><a href="#LiLit-287"><span class="linenos">287</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-288"><a href="#LiLit-288"><span class="linenos">288</span></a>
</span><span id="LiLit-289"><a href="#LiLit-289"><span class="linenos">289</span></a>    <span class="k">def</span> <span class="nf">get_Gauss_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-290"><a href="#LiLit-290"><span class="linenos">290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the proper dictionary keys for the requested fields.</span>
</span><span id="LiLit-291"><a href="#LiLit-291"><span class="linenos">291</span></a>
</span><span id="LiLit-292"><a href="#LiLit-292"><span class="linenos">292</span></a><span class="sd">        Extracts the keys that has to be used as a function of the requested fields for the Gaussian likelihood. Indeed, the Gaussian likelihood is computed using 4-points, so the keys are different. E.g., there will be keys such as tttt, ttee, tete, etc.</span>
</span><span id="LiLit-293"><a href="#LiLit-293"><span class="linenos">293</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-294"><a href="#LiLit-294"><span class="linenos">294</span></a>        <span class="c1"># Calculate the number of elements in the covariance matrix</span>
</span><span id="LiLit-295"><a href="#LiLit-295"><span class="linenos">295</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit-296"><a href="#LiLit-296"><span class="linenos">296</span></a>        <span class="c1"># Initialize a 3-d array to store the keys</span>
</span><span id="LiLit-297"><a href="#LiLit-297"><span class="linenos">297</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="LiLit-298"><a href="#LiLit-298"><span class="linenos">298</span></a>        <span class="c1"># Loop over all the elements in the covariance matrix</span>
</span><span id="LiLit-299"><a href="#LiLit-299"><span class="linenos">299</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-300"><a href="#LiLit-300"><span class="linenos">300</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-301"><a href="#LiLit-301"><span class="linenos">301</span></a>                <span class="c1"># Generate a key for the i-th and j-th element</span>
</span><span id="LiLit-302"><a href="#LiLit-302"><span class="linenos">302</span></a>                <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-303"><a href="#LiLit-303"><span class="linenos">303</span></a>                <span class="c1"># Loop over all the characters in the key</span>
</span><span id="LiLit-304"><a href="#LiLit-304"><span class="linenos">304</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="LiLit-305"><a href="#LiLit-305"><span class="linenos">305</span></a>                    <span class="c1"># Add the k-th character to the i-th, j-th, and k-th</span>
</span><span id="LiLit-306"><a href="#LiLit-306"><span class="linenos">306</span></a>                    <span class="c1"># indices of the array</span>
</span><span id="LiLit-307"><a href="#LiLit-307"><span class="linenos">307</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">elem</span><span class="p">)[</span><span class="n">k</span><span class="p">])</span>
</span><span id="LiLit-308"><a href="#LiLit-308"><span class="linenos">308</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span id="LiLit-309"><a href="#LiLit-309"><span class="linenos">309</span></a>        <span class="c1"># Print the keys if the debug flag is set</span>
</span><span id="LiLit-310"><a href="#LiLit-310"><span class="linenos">310</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-311"><a href="#LiLit-311"><span class="linenos">311</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The requested keys are </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-312"><a href="#LiLit-312"><span class="linenos">312</span></a>        <span class="c1"># Return the keys</span>
</span><span id="LiLit-313"><a href="#LiLit-313"><span class="linenos">313</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-314"><a href="#LiLit-314"><span class="linenos">314</span></a>
</span><span id="LiLit-315"><a href="#LiLit-315"><span class="linenos">315</span></a>    <span class="k">def</span> <span class="nf">find_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="LiLit-316"><a href="#LiLit-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a spectrum in a given dictionary.</span>
</span><span id="LiLit-317"><a href="#LiLit-317"><span class="linenos">317</span></a>
</span><span id="LiLit-318"><a href="#LiLit-318"><span class="linenos">318</span></a><span class="sd">        Returns the corresponding power sepctrum for a given key. If the key is not found, it will try to find the reverse key. Otherwise it will fill the array with zeros.</span>
</span><span id="LiLit-319"><a href="#LiLit-319"><span class="linenos">319</span></a>
</span><span id="LiLit-320"><a href="#LiLit-320"><span class="linenos">320</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-321"><a href="#LiLit-321"><span class="linenos">321</span></a><span class="sd">            input_dict (dict):</span>
</span><span id="LiLit-322"><a href="#LiLit-322"><span class="linenos">322</span></a><span class="sd">                Dictionary where you want to search for keys.</span>
</span><span id="LiLit-323"><a href="#LiLit-323"><span class="linenos">323</span></a>
</span><span id="LiLit-324"><a href="#LiLit-324"><span class="linenos">324</span></a><span class="sd">            key (str):</span>
</span><span id="LiLit-325"><a href="#LiLit-325"><span class="linenos">325</span></a><span class="sd">                Key to search for.</span>
</span><span id="LiLit-326"><a href="#LiLit-326"><span class="linenos">326</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-327"><a href="#LiLit-327"><span class="linenos">327</span></a>        <span class="c1"># create a zero array</span>
</span><span id="LiLit-328"><a href="#LiLit-328"><span class="linenos">328</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit-329"><a href="#LiLit-329"><span class="linenos">329</span></a>
</span><span id="LiLit-330"><a href="#LiLit-330"><span class="linenos">330</span></a>        <span class="c1"># get lmin and lmax</span>
</span><span id="LiLit-331"><a href="#LiLit-331"><span class="linenos">331</span></a>        <span class="n">lmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="LiLit-332"><a href="#LiLit-332"><span class="linenos">332</span></a>        <span class="n">lmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="LiLit-333"><a href="#LiLit-333"><span class="linenos">333</span></a>
</span><span id="LiLit-334"><a href="#LiLit-334"><span class="linenos">334</span></a>        <span class="c1"># try to find the key in the dictionary</span>
</span><span id="LiLit-335"><a href="#LiLit-335"><span class="linenos">335</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
</span><span id="LiLit-336"><a href="#LiLit-336"><span class="linenos">336</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="LiLit-337"><a href="#LiLit-337"><span class="linenos">337</span></a>        <span class="c1"># if the key is not found, try the reverse key</span>
</span><span id="LiLit-338"><a href="#LiLit-338"><span class="linenos">338</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-339"><a href="#LiLit-339"><span class="linenos">339</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit-340"><a href="#LiLit-340"><span class="linenos">340</span></a>
</span><span id="LiLit-341"><a href="#LiLit-341"><span class="linenos">341</span></a>        <span class="c1"># fill the array with the requested spectrum</span>
</span><span id="LiLit-342"><a href="#LiLit-342"><span class="linenos">342</span></a>        <span class="n">res</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-343"><a href="#LiLit-343"><span class="linenos">343</span></a>
</span><span id="LiLit-344"><a href="#LiLit-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-345"><a href="#LiLit-345"><span class="linenos">345</span></a>
</span><span id="LiLit-346"><a href="#LiLit-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fiduDICT</span><span class="p">,</span> <span class="n">noiseDICT</span><span class="p">):</span>
</span><span id="LiLit-347"><a href="#LiLit-347"><span class="linenos">347</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the covariance matrix for the Gaussian case.</span>
</span><span id="LiLit-348"><a href="#LiLit-348"><span class="linenos">348</span></a>
</span><span id="LiLit-349"><a href="#LiLit-349"><span class="linenos">349</span></a><span class="sd">        In case of Gaussian likelihood, this returns the covariance matrix needed for the computation of the chi2. Note that the inversion is done in a separate funciton.</span>
</span><span id="LiLit-350"><a href="#LiLit-350"><span class="linenos">350</span></a>
</span><span id="LiLit-351"><a href="#LiLit-351"><span class="linenos">351</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-352"><a href="#LiLit-352"><span class="linenos">352</span></a><span class="sd">            keys (dict):</span>
</span><span id="LiLit-353"><a href="#LiLit-353"><span class="linenos">353</span></a><span class="sd">                Keys for the covariance elements.</span>
</span><span id="LiLit-354"><a href="#LiLit-354"><span class="linenos">354</span></a>
</span><span id="LiLit-355"><a href="#LiLit-355"><span class="linenos">355</span></a><span class="sd">            fiduDICT (dict):</span>
</span><span id="LiLit-356"><a href="#LiLit-356"><span class="linenos">356</span></a><span class="sd">                Dictionary with the fiducial spectra.</span>
</span><span id="LiLit-357"><a href="#LiLit-357"><span class="linenos">357</span></a>
</span><span id="LiLit-358"><a href="#LiLit-358"><span class="linenos">358</span></a><span class="sd">            noiseDICT (dict):</span>
</span><span id="LiLit-359"><a href="#LiLit-359"><span class="linenos">359</span></a><span class="sd">                Dictionary with the noise spectra.</span>
</span><span id="LiLit-360"><a href="#LiLit-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-361"><a href="#LiLit-361"><span class="linenos">361</span></a>        <span class="c1"># The covariance matrix has to be symmetric.</span>
</span><span id="LiLit-362"><a href="#LiLit-362"><span class="linenos">362</span></a>        <span class="c1"># The number of parameters in the likelihood is self.n.</span>
</span><span id="LiLit-363"><a href="#LiLit-363"><span class="linenos">363</span></a>        <span class="c1"># The covariance matrix is a (self.n x self.n x self.lmax+1) ndarray.</span>
</span><span id="LiLit-364"><a href="#LiLit-364"><span class="linenos">364</span></a>        <span class="c1"># We will store the covariance matrix in a (n x n x self.lmax+1) ndarray,</span>
</span><span id="LiLit-365"><a href="#LiLit-365"><span class="linenos">365</span></a>        <span class="c1"># where n = int(self.n * (self.n + 1) / 2).</span>
</span><span id="LiLit-366"><a href="#LiLit-366"><span class="linenos">366</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit-367"><a href="#LiLit-367"><span class="linenos">367</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit-368"><a href="#LiLit-368"><span class="linenos">368</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># Loop over all combinations of pairs of spectra</span>
</span><span id="LiLit-369"><a href="#LiLit-369"><span class="linenos">369</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="LiLit-370"><a href="#LiLit-370"><span class="linenos">370</span></a>                <span class="n">C_AC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span>
</span><span id="LiLit-371"><a href="#LiLit-371"><span class="linenos">371</span></a>                    <span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit-372"><a href="#LiLit-372"><span class="linenos">372</span></a>                <span class="p">)</span>  <span class="c1"># Find the fiducial spectra for each pair</span>
</span><span id="LiLit-373"><a href="#LiLit-373"><span class="linenos">373</span></a>                <span class="n">C_BD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit-374"><a href="#LiLit-374"><span class="linenos">374</span></a>                <span class="n">C_AD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit-375"><a href="#LiLit-375"><span class="linenos">375</span></a>                <span class="n">C_BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="LiLit-376"><a href="#LiLit-376"><span class="linenos">376</span></a>                <span class="n">N_AC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span>
</span><span id="LiLit-377"><a href="#LiLit-377"><span class="linenos">377</span></a>                    <span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit-378"><a href="#LiLit-378"><span class="linenos">378</span></a>                <span class="p">)</span>  <span class="c1"># Find the noise spectra for each pair</span>
</span><span id="LiLit-379"><a href="#LiLit-379"><span class="linenos">379</span></a>                <span class="n">N_BD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit-380"><a href="#LiLit-380"><span class="linenos">380</span></a>                <span class="n">N_AD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit-381"><a href="#LiLit-381"><span class="linenos">381</span></a>                <span class="n">N_BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="LiLit-382"><a href="#LiLit-382"><span class="linenos">382</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If self.fsky is defined, use the fsky value</span>
</span><span id="LiLit-383"><a href="#LiLit-383"><span class="linenos">383</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit-384"><a href="#LiLit-384"><span class="linenos">384</span></a>                        <span class="p">(</span><span class="n">C_AC</span> <span class="o">+</span> <span class="n">N_AC</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_BD</span> <span class="o">+</span> <span class="n">N_BD</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">C_AD</span> <span class="o">+</span> <span class="n">N_AD</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_BC</span> <span class="o">+</span> <span class="n">N_BC</span><span class="p">)</span>
</span><span id="LiLit-385"><a href="#LiLit-385"><span class="linenos">385</span></a>                    <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span>
</span><span id="LiLit-386"><a href="#LiLit-386"><span class="linenos">386</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, use the fsky values from the input spectra</span>
</span><span id="LiLit-387"><a href="#LiLit-387"><span class="linenos">387</span></a>                    <span class="n">AC</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit-388"><a href="#LiLit-388"><span class="linenos">388</span></a>                    <span class="n">BD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="LiLit-389"><a href="#LiLit-389"><span class="linenos">389</span></a>                    <span class="n">AD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="LiLit-390"><a href="#LiLit-390"><span class="linenos">390</span></a>                    <span class="n">BC</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit-391"><a href="#LiLit-391"><span class="linenos">391</span></a>                    <span class="n">AB</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-392"><a href="#LiLit-392"><span class="linenos">392</span></a>                    <span class="n">CD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="LiLit-393"><a href="#LiLit-393"><span class="linenos">393</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit-394"><a href="#LiLit-394"><span class="linenos">394</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AC</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">BD</span><span class="p">])</span>
</span><span id="LiLit-395"><a href="#LiLit-395"><span class="linenos">395</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_AC</span> <span class="o">+</span> <span class="n">N_AC</span><span class="p">)</span>
</span><span id="LiLit-396"><a href="#LiLit-396"><span class="linenos">396</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_BD</span> <span class="o">+</span> <span class="n">N_BD</span><span class="p">)</span>
</span><span id="LiLit-397"><a href="#LiLit-397"><span class="linenos">397</span></a>                        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AD</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">BC</span><span class="p">])</span>
</span><span id="LiLit-398"><a href="#LiLit-398"><span class="linenos">398</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_AD</span> <span class="o">+</span> <span class="n">N_AD</span><span class="p">)</span>
</span><span id="LiLit-399"><a href="#LiLit-399"><span class="linenos">399</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_BC</span> <span class="o">+</span> <span class="n">N_BC</span><span class="p">)</span>
</span><span id="LiLit-400"><a href="#LiLit-400"><span class="linenos">400</span></a>                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AB</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">CD</span><span class="p">])</span>
</span><span id="LiLit-401"><a href="#LiLit-401"><span class="linenos">401</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="LiLit-402"><a href="#LiLit-402"><span class="linenos">402</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-403"><a href="#LiLit-403"><span class="linenos">403</span></a>
</span><span id="LiLit-404"><a href="#LiLit-404"><span class="linenos">404</span></a>    <span class="k">def</span> <span class="nf">inv_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="LiLit-405"><a href="#LiLit-405"><span class="linenos">405</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the covariance matrix of the Gaussian case.</span>
</span><span id="LiLit-406"><a href="#LiLit-406"><span class="linenos">406</span></a>
</span><span id="LiLit-407"><a href="#LiLit-407"><span class="linenos">407</span></a><span class="sd">        Inverts the previously calculated sigma ndarray. Note that some elements may be null, thus the covariance may be singular. If so, this also reduces the dimension of the matrix by deleting the corresponding row and column.</span>
</span><span id="LiLit-408"><a href="#LiLit-408"><span class="linenos">408</span></a>
</span><span id="LiLit-409"><a href="#LiLit-409"><span class="linenos">409</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-410"><a href="#LiLit-410"><span class="linenos">410</span></a><span class="sd">            ndarray (np.ndarray):</span>
</span><span id="LiLit-411"><a href="#LiLit-411"><span class="linenos">411</span></a><span class="sd">                (self.n x self.n x self.lmax+1) ndarray with the previously computed sigma (not inverted).</span>
</span><span id="LiLit-412"><a href="#LiLit-412"><span class="linenos">412</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-413"><a href="#LiLit-413"><span class="linenos">413</span></a>        <span class="c1"># Initialize array to store the inverted covariance matrices</span>
</span><span id="LiLit-414"><a href="#LiLit-414"><span class="linenos">414</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="LiLit-415"><a href="#LiLit-415"><span class="linenos">415</span></a>
</span><span id="LiLit-416"><a href="#LiLit-416"><span class="linenos">416</span></a>        <span class="c1"># Loop over multipoles</span>
</span><span id="LiLit-417"><a href="#LiLit-417"><span class="linenos">417</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="LiLit-418"><a href="#LiLit-418"><span class="linenos">418</span></a>            <span class="c1"># Check if matrix is singular</span>
</span><span id="LiLit-419"><a href="#LiLit-419"><span class="linenos">419</span></a>            <span class="n">COV</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit-420"><a href="#LiLit-420"><span class="linenos">420</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LiLit-421"><a href="#LiLit-421"><span class="linenos">421</span></a>                <span class="c1"># Get indices of null diagonal elements</span>
</span><span id="LiLit-422"><a href="#LiLit-422"><span class="linenos">422</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-423"><a href="#LiLit-423"><span class="linenos">423</span></a>                <span class="c1"># Remove corresponding rows and columns</span>
</span><span id="LiLit-424"><a href="#LiLit-424"><span class="linenos">424</span></a>                <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LiLit-425"><a href="#LiLit-425"><span class="linenos">425</span></a>                <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit-426"><a href="#LiLit-426"><span class="linenos">426</span></a>            <span class="c1"># Invert matrix</span>
</span><span id="LiLit-427"><a href="#LiLit-427"><span class="linenos">427</span></a>            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span>
</span><span id="LiLit-428"><a href="#LiLit-428"><span class="linenos">428</span></a>        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="LiLit-429"><a href="#LiLit-429"><span class="linenos">429</span></a>
</span><span id="LiLit-430"><a href="#LiLit-430"><span class="linenos">430</span></a>    <span class="k">def</span> <span class="nf">get_reduced_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
</span><span id="LiLit-431"><a href="#LiLit-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the reduced data eliminating the singularity of the matrix.</span>
</span><span id="LiLit-432"><a href="#LiLit-432"><span class="linenos">432</span></a>
</span><span id="LiLit-433"><a href="#LiLit-433"><span class="linenos">433</span></a><span class="sd">        Cuts the row and column corresponding to a zero diagonal value. Indeed, in case of different lmax, or lmin, for the fields, you will have singular marices.</span>
</span><span id="LiLit-434"><a href="#LiLit-434"><span class="linenos">434</span></a>
</span><span id="LiLit-435"><a href="#LiLit-435"><span class="linenos">435</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-436"><a href="#LiLit-436"><span class="linenos">436</span></a><span class="sd">            ndarray (np.ndarray):</span>
</span><span id="LiLit-437"><a href="#LiLit-437"><span class="linenos">437</span></a><span class="sd">                A ndarray containing the covariance matrices, with some singular ones.</span>
</span><span id="LiLit-438"><a href="#LiLit-438"><span class="linenos">438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-439"><a href="#LiLit-439"><span class="linenos">439</span></a>        <span class="c1"># Select the indices corresponding to the zero diagonal</span>
</span><span id="LiLit-440"><a href="#LiLit-440"><span class="linenos">440</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-441"><a href="#LiLit-441"><span class="linenos">441</span></a>        <span class="c1"># Delete the rows and columns from the matrix</span>
</span><span id="LiLit-442"><a href="#LiLit-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit-443"><a href="#LiLit-443"><span class="linenos">443</span></a>
</span><span id="LiLit-444"><a href="#LiLit-444"><span class="linenos">444</span></a>    <span class="k">def</span> <span class="nf">CAMBres2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camb_results</span><span class="p">):</span>
</span><span id="LiLit-445"><a href="#LiLit-445"><span class="linenos">445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes the CAMB result product from get_cmb_power_spectra and convert it to a dictionary with the proper keys.</span>
</span><span id="LiLit-446"><a href="#LiLit-446"><span class="linenos">446</span></a>
</span><span id="LiLit-447"><a href="#LiLit-447"><span class="linenos">447</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-448"><a href="#LiLit-448"><span class="linenos">448</span></a><span class="sd">            camb_results (CAMBdata):</span>
</span><span id="LiLit-449"><a href="#LiLit-449"><span class="linenos">449</span></a><span class="sd">                CAMB result product from the method get_cmb_power_spectra.</span>
</span><span id="LiLit-450"><a href="#LiLit-450"><span class="linenos">450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-451"><a href="#LiLit-451"><span class="linenos">451</span></a>        <span class="c1"># Get the number of multipoles</span>
</span><span id="LiLit-452"><a href="#LiLit-452"><span class="linenos">452</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">camb_results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="LiLit-453"><a href="#LiLit-453"><span class="linenos">453</span></a>        <span class="c1"># Mapping between the CAMB keys and the ones we want</span>
</span><span id="LiLit-454"><a href="#LiLit-454"><span class="linenos">454</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;te&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span id="LiLit-455"><a href="#LiLit-455"><span class="linenos">455</span></a>        <span class="c1"># Initialize the output dictionary</span>
</span><span id="LiLit-456"><a href="#LiLit-456"><span class="linenos">456</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ell&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>
</span><span id="LiLit-457"><a href="#LiLit-457"><span class="linenos">457</span></a>        <span class="c1"># Loop over the keys we want</span>
</span><span id="LiLit-458"><a href="#LiLit-458"><span class="linenos">458</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LiLit-459"><a href="#LiLit-459"><span class="linenos">459</span></a>            <span class="c1"># Save the results</span>
</span><span id="LiLit-460"><a href="#LiLit-460"><span class="linenos">460</span></a>            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">camb_results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit-461"><a href="#LiLit-461"><span class="linenos">461</span></a>        <span class="c1"># Check if we want the lensing potential</span>
</span><span id="LiLit-462"><a href="#LiLit-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="s2">&quot;pp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="LiLit-463"><a href="#LiLit-463"><span class="linenos">463</span></a>            <span class="c1"># Get the lensing potential</span>
</span><span id="LiLit-464"><a href="#LiLit-464"><span class="linenos">464</span></a>            <span class="n">cl_lens</span> <span class="o">=</span> <span class="n">camb_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lens_potential&quot;</span><span class="p">)</span>
</span><span id="LiLit-465"><a href="#LiLit-465"><span class="linenos">465</span></a>            <span class="c1"># Check if it exists</span>
</span><span id="LiLit-466"><a href="#LiLit-466"><span class="linenos">466</span></a>            <span class="k">if</span> <span class="n">cl_lens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit-467"><a href="#LiLit-467"><span class="linenos">467</span></a>                <span class="c1"># Save it</span>
</span><span id="LiLit-468"><a href="#LiLit-468"><span class="linenos">468</span></a>                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_lens</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LiLit-469"><a href="#LiLit-469"><span class="linenos">469</span></a>                <span class="c1"># Check if we want the cross terms</span>
</span><span id="LiLit-470"><a href="#LiLit-470"><span class="linenos">470</span></a>                <span class="k">if</span> <span class="s2">&quot;pt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="ow">and</span> <span class="s2">&quot;pe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="LiLit-471"><a href="#LiLit-471"><span class="linenos">471</span></a>                    <span class="c1"># Loop over the cross terms</span>
</span><span id="LiLit-472"><a href="#LiLit-472"><span class="linenos">472</span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cross</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;pe&quot;</span><span class="p">]):</span>
</span><span id="LiLit-473"><a href="#LiLit-473"><span class="linenos">473</span></a>                        <span class="c1"># Save the result</span>
</span><span id="LiLit-474"><a href="#LiLit-474"><span class="linenos">474</span></a>                        <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_lens</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LiLit-475"><a href="#LiLit-475"><span class="linenos">475</span></a>                        <span class="c1"># Save the symmetric term</span>
</span><span id="LiLit-476"><a href="#LiLit-476"><span class="linenos">476</span></a>                        <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">]</span>
</span><span id="LiLit-477"><a href="#LiLit-477"><span class="linenos">477</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-478"><a href="#LiLit-478"><span class="linenos">478</span></a>
</span><span id="LiLit-479"><a href="#LiLit-479"><span class="linenos">479</span></a>    <span class="k">def</span> <span class="nf">txt2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LiLit-480"><a href="#LiLit-480"><span class="linenos">480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes a txt file and convert it to a dictionary. This requires a way to map the columns to the keys. Also, it is possible to apply an ell factor to the Cls.</span>
</span><span id="LiLit-481"><a href="#LiLit-481"><span class="linenos">481</span></a>
</span><span id="LiLit-482"><a href="#LiLit-482"><span class="linenos">482</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-483"><a href="#LiLit-483"><span class="linenos">483</span></a><span class="sd">            txt (str):</span>
</span><span id="LiLit-484"><a href="#LiLit-484"><span class="linenos">484</span></a><span class="sd">                Path to txt file containing the spectra as columns.</span>
</span><span id="LiLit-485"><a href="#LiLit-485"><span class="linenos">485</span></a><span class="sd">            mapping (dict):</span>
</span><span id="LiLit-486"><a href="#LiLit-486"><span class="linenos">486</span></a><span class="sd">                Dictionary containing the mapping. Keywords will become the new keywords and values represent the index of the corresponding column.</span>
</span><span id="LiLit-487"><a href="#LiLit-487"><span class="linenos">487</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-488"><a href="#LiLit-488"><span class="linenos">488</span></a>        <span class="c1"># Define the ell values from the length of the txt file</span>
</span><span id="LiLit-489"><a href="#LiLit-489"><span class="linenos">489</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-490"><a href="#LiLit-490"><span class="linenos">490</span></a>            <span class="n">mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit-491"><a href="#LiLit-491"><span class="linenos">491</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide a way to map the columns of your txt to the keys of a dictionary&quot;</span>
</span><span id="LiLit-492"><a href="#LiLit-492"><span class="linenos">492</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="LiLit-493"><a href="#LiLit-493"><span class="linenos">493</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ell&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>
</span><span id="LiLit-494"><a href="#LiLit-494"><span class="linenos">494</span></a>        <span class="c1"># Loop over the mapping and extract the corresponding column from the txt file</span>
</span><span id="LiLit-495"><a href="#LiLit-495"><span class="linenos">495</span></a>        <span class="c1"># and store it in the dictionary under the corresponding keyword</span>
</span><span id="LiLit-496"><a href="#LiLit-496"><span class="linenos">496</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LiLit-497"><a href="#LiLit-497"><span class="linenos">497</span></a>            <span class="k">if</span> <span class="n">apply_ellfactor</span><span class="p">:</span>
</span><span id="LiLit-498"><a href="#LiLit-498"><span class="linenos">498</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ls</span> <span class="o">*</span> <span class="p">(</span><span class="n">ls</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit-499"><a href="#LiLit-499"><span class="linenos">499</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-500"><a href="#LiLit-500"><span class="linenos">500</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit-501"><a href="#LiLit-501"><span class="linenos">501</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-502"><a href="#LiLit-502"><span class="linenos">502</span></a>
</span><span id="LiLit-503"><a href="#LiLit-503"><span class="linenos">503</span></a>    <span class="k">def</span> <span class="nf">prod_fidu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-504"><a href="#LiLit-504"><span class="linenos">504</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce fiducial spectra or read the input ones.</span>
</span><span id="LiLit-505"><a href="#LiLit-505"><span class="linenos">505</span></a>
</span><span id="LiLit-506"><a href="#LiLit-506"><span class="linenos">506</span></a><span class="sd">        If the user has not provided a Cl file, this function will produce the fiducial power spectra starting from the CAMB inifile for Planck2018. The extra keywords defined will maximize the accordance between the fiducial Cls and the ones obtained from Cobaya. If B-modes are requested, the tensor-to-scalar ratio and the spectral tilt will be set to the requested values. Note that if you do not provide a tilt, this will follow the standard single-field consistency relation. If instead you provide a custom file, stores that.</span>
</span><span id="LiLit-507"><a href="#LiLit-507"><span class="linenos">507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-508"><a href="#LiLit-508"><span class="linenos">508</span></a>        <span class="c1"># If a custom file is provided, use that</span>
</span><span id="LiLit-509"><a href="#LiLit-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit-510"><a href="#LiLit-510"><span class="linenos">510</span></a>            <span class="c1"># If the file is a pickle file, load it</span>
</span><span id="LiLit-511"><a href="#LiLit-511"><span class="linenos">511</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">):</span>
</span><span id="LiLit-512"><a href="#LiLit-512"><span class="linenos">512</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
</span><span id="LiLit-513"><a href="#LiLit-513"><span class="linenos">513</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
</span><span id="LiLit-514"><a href="#LiLit-514"><span class="linenos">514</span></a>            <span class="c1"># Otherwise, load it as text file</span>
</span><span id="LiLit-515"><a href="#LiLit-515"><span class="linenos">515</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-516"><a href="#LiLit-516"><span class="linenos">516</span></a>                <span class="n">txt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="p">)</span>
</span><span id="LiLit-517"><a href="#LiLit-517"><span class="linenos">517</span></a>                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;te&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span id="LiLit-518"><a href="#LiLit-518"><span class="linenos">518</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt2dict</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
</span><span id="LiLit-519"><a href="#LiLit-519"><span class="linenos">519</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-520"><a href="#LiLit-520"><span class="linenos">520</span></a>
</span><span id="LiLit-521"><a href="#LiLit-521"><span class="linenos">521</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LiLit-522"><a href="#LiLit-522"><span class="linenos">522</span></a>            <span class="kn">import</span> <span class="nn">camb</span>
</span><span id="LiLit-523"><a href="#LiLit-523"><span class="linenos">523</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="LiLit-524"><a href="#LiLit-524"><span class="linenos">524</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAMB seems to be not installed. Check the requirements.&quot;</span><span class="p">)</span>
</span><span id="LiLit-525"><a href="#LiLit-525"><span class="linenos">525</span></a>
</span><span id="LiLit-526"><a href="#LiLit-526"><span class="linenos">526</span></a>        <span class="c1"># Read the ini file containing the parameters for CAMB</span>
</span><span id="LiLit-527"><a href="#LiLit-527"><span class="linenos">527</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="LiLit-528"><a href="#LiLit-528"><span class="linenos">528</span></a>        <span class="n">planck_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;planck_2018.ini&quot;</span><span class="p">)</span>
</span><span id="LiLit-529"><a href="#LiLit-529"><span class="linenos">529</span></a>        <span class="n">pars</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">read_ini</span><span class="p">(</span><span class="n">planck_path</span><span class="p">)</span>
</span><span id="LiLit-530"><a href="#LiLit-530"><span class="linenos">530</span></a>
</span><span id="LiLit-531"><a href="#LiLit-531"><span class="linenos">531</span></a>        <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>  <span class="c1"># If we want to include the tensor mode</span>
</span><span id="LiLit-532"><a href="#LiLit-532"><span class="linenos">532</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Producing fiducial spectra for r=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="si">}</span><span class="s2"> and nt=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-533"><a href="#LiLit-533"><span class="linenos">533</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span>
</span><span id="LiLit-534"><a href="#LiLit-534"><span class="linenos">534</span></a>                <span class="n">As</span><span class="o">=</span><span class="mf">2.100549e-9</span><span class="p">,</span>
</span><span id="LiLit-535"><a href="#LiLit-535"><span class="linenos">535</span></a>                <span class="n">ns</span><span class="o">=</span><span class="mf">0.9660499</span><span class="p">,</span>
</span><span id="LiLit-536"><a href="#LiLit-536"><span class="linenos">536</span></a>                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="LiLit-537"><a href="#LiLit-537"><span class="linenos">537</span></a>                <span class="n">nt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
</span><span id="LiLit-538"><a href="#LiLit-538"><span class="linenos">538</span></a>                <span class="n">pivot_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_t</span><span class="p">,</span>
</span><span id="LiLit-539"><a href="#LiLit-539"><span class="linenos">539</span></a>                <span class="n">pivot_scalar</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="LiLit-540"><a href="#LiLit-540"><span class="linenos">540</span></a>                <span class="n">parameterization</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="LiLit-541"><a href="#LiLit-541"><span class="linenos">541</span></a>            <span class="p">)</span>
</span><span id="LiLit-542"><a href="#LiLit-542"><span class="linenos">542</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">WantTensors</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LiLit-543"><a href="#LiLit-543"><span class="linenos">543</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">AccurateBB</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LiLit-544"><a href="#LiLit-544"><span class="linenos">544</span></a>        <span class="n">pars</span><span class="o">.</span><span class="n">DoLensing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LiLit-545"><a href="#LiLit-545"><span class="linenos">545</span></a>        <span class="c1"># _pars.Accuracy.AccuracyBoost = 2 # This helps getting an extra squeeze on the accordance of Cobaya and Fiducial spectra</span>
</span><span id="LiLit-546"><a href="#LiLit-546"><span class="linenos">546</span></a>
</span><span id="LiLit-547"><a href="#LiLit-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-548"><a href="#LiLit-548"><span class="linenos">548</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="LiLit-549"><a href="#LiLit-549"><span class="linenos">549</span></a>
</span><span id="LiLit-550"><a href="#LiLit-550"><span class="linenos">550</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="LiLit-551"><a href="#LiLit-551"><span class="linenos">551</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_cmb_power_spectra</span><span class="p">(</span>
</span><span id="LiLit-552"><a href="#LiLit-552"><span class="linenos">552</span></a>            <span class="n">CMB_unit</span><span class="o">=</span><span class="s2">&quot;muK&quot;</span><span class="p">,</span>
</span><span id="LiLit-553"><a href="#LiLit-553"><span class="linenos">553</span></a>            <span class="n">lmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">,</span>
</span><span id="LiLit-554"><a href="#LiLit-554"><span class="linenos">554</span></a>            <span class="n">raw_cl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LiLit-555"><a href="#LiLit-555"><span class="linenos">555</span></a>        <span class="p">)</span>
</span><span id="LiLit-556"><a href="#LiLit-556"><span class="linenos">556</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CAMBres2dict</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="LiLit-557"><a href="#LiLit-557"><span class="linenos">557</span></a>
</span><span id="LiLit-558"><a href="#LiLit-558"><span class="linenos">558</span></a>    <span class="k">def</span> <span class="nf">prod_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-559"><a href="#LiLit-559"><span class="linenos">559</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce noise power spectra or read the input ones.</span>
</span><span id="LiLit-560"><a href="#LiLit-560"><span class="linenos">560</span></a>
</span><span id="LiLit-561"><a href="#LiLit-561"><span class="linenos">561</span></a><span class="sd">        If the user has not provided a noise file, this function will produce the noise power spectra for a given experiment with inverse noise weighting of white noise in each channel (TT, EE, BB). Note that you may want to have a look at the procedure since it is merely a place-holder. Indeed, you should provide a more realistic file from which to read the noise spectra, given that inverse noise weighting severely underestimates the amount of noise. If instead you provide the proper custom file, this method stores that.</span>
</span><span id="LiLit-562"><a href="#LiLit-562"><span class="linenos">562</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-563"><a href="#LiLit-563"><span class="linenos">563</span></a>        <span class="c1"># If the input noise file is a pickle file, load it.</span>
</span><span id="LiLit-564"><a href="#LiLit-564"><span class="linenos">564</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit-565"><a href="#LiLit-565"><span class="linenos">565</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">):</span>
</span><span id="LiLit-566"><a href="#LiLit-566"><span class="linenos">566</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
</span><span id="LiLit-567"><a href="#LiLit-567"><span class="linenos">567</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
</span><span id="LiLit-568"><a href="#LiLit-568"><span class="linenos">568</span></a>            <span class="c1"># If not, load the file as a text file</span>
</span><span id="LiLit-569"><a href="#LiLit-569"><span class="linenos">569</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-570"><a href="#LiLit-570"><span class="linenos">570</span></a>                <span class="n">_txt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="p">)</span>
</span><span id="LiLit-571"><a href="#LiLit-571"><span class="linenos">571</span></a>                <span class="c1"># Convert the text file to a dictionary</span>
</span><span id="LiLit-572"><a href="#LiLit-572"><span class="linenos">572</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt2dict</span><span class="p">(</span><span class="n">_txt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit-573"><a href="#LiLit-573"><span class="linenos">573</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-574"><a href="#LiLit-574"><span class="linenos">574</span></a>
</span><span id="LiLit-575"><a href="#LiLit-575"><span class="linenos">575</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="LiLit-576"><a href="#LiLit-576"><span class="linenos">576</span></a>            <span class="s2">&quot;***WARNING***: the inverse noise weighting performed here severely underestimates </span><span class="se">\</span>
</span><span id="LiLit-577"><a href="#LiLit-577"><span class="linenos">577</span></a><span class="s2">            the actual noise level of LiteBIRD. You should provide an input </span><span class="se">\</span>
</span><span id="LiLit-578"><a href="#LiLit-578"><span class="linenos">578</span></a><span class="s2">            noise power spectrum with a more realistic noise.&quot;</span>
</span><span id="LiLit-579"><a href="#LiLit-579"><span class="linenos">579</span></a>        <span class="p">)</span>
</span><span id="LiLit-580"><a href="#LiLit-580"><span class="linenos">580</span></a>
</span><span id="LiLit-581"><a href="#LiLit-581"><span class="linenos">581</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LiLit-582"><a href="#LiLit-582"><span class="linenos">582</span></a>            <span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="LiLit-583"><a href="#LiLit-583"><span class="linenos">583</span></a>            <span class="kn">from</span> <span class="nn">yaml.loader</span> <span class="kn">import</span> <span class="n">SafeLoader</span>
</span><span id="LiLit-584"><a href="#LiLit-584"><span class="linenos">584</span></a>            <span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
</span><span id="LiLit-585"><a href="#LiLit-585"><span class="linenos">585</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="LiLit-586"><a href="#LiLit-586"><span class="linenos">586</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YAML or Healpy seems to be not installed. Check the requirements.&quot;</span><span class="p">)</span>
</span><span id="LiLit-587"><a href="#LiLit-587"><span class="linenos">587</span></a>
</span><span id="LiLit-588"><a href="#LiLit-588"><span class="linenos">588</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit-589"><a href="#LiLit-589"><span class="linenos">589</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit-590"><a href="#LiLit-590"><span class="linenos">590</span></a>        <span class="p">),</span> <span class="s2">&quot;You must specify the experiment you want to consider&quot;</span>
</span><span id="LiLit-591"><a href="#LiLit-591"><span class="linenos">591</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Computing noise for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-592"><a href="#LiLit-592"><span class="linenos">592</span></a>
</span><span id="LiLit-593"><a href="#LiLit-593"><span class="linenos">593</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="LiLit-594"><a href="#LiLit-594"><span class="linenos">594</span></a>        <span class="n">experiments_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;experiments.yaml&quot;</span><span class="p">)</span>
</span><span id="LiLit-595"><a href="#LiLit-595"><span class="linenos">595</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">experiments_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LiLit-596"><a href="#LiLit-596"><span class="linenos">596</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>
</span><span id="LiLit-597"><a href="#LiLit-597"><span class="linenos">597</span></a>
</span><span id="LiLit-598"><a href="#LiLit-598"><span class="linenos">598</span></a>        <span class="c1"># Get the instrument data from the saved data</span>
</span><span id="LiLit-599"><a href="#LiLit-599"><span class="linenos">599</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">]</span>
</span><span id="LiLit-600"><a href="#LiLit-600"><span class="linenos">600</span></a>
</span><span id="LiLit-601"><a href="#LiLit-601"><span class="linenos">601</span></a>        <span class="c1"># Get the FWHM values from the instrument data</span>
</span><span id="LiLit-602"><a href="#LiLit-602"><span class="linenos">602</span></a>        <span class="n">fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">])</span>
</span><span id="LiLit-603"><a href="#LiLit-603"><span class="linenos">603</span></a>
</span><span id="LiLit-604"><a href="#LiLit-604"><span class="linenos">604</span></a>        <span class="c1"># Get the frequency values from the instrument data</span>
</span><span id="LiLit-605"><a href="#LiLit-605"><span class="linenos">605</span></a>        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">])</span>
</span><span id="LiLit-606"><a href="#LiLit-606"><span class="linenos">606</span></a>
</span><span id="LiLit-607"><a href="#LiLit-607"><span class="linenos">607</span></a>        <span class="c1"># Get the depth values from the instrument data</span>
</span><span id="LiLit-608"><a href="#LiLit-608"><span class="linenos">608</span></a>        <span class="n">depth_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;depth_p&quot;</span><span class="p">])</span>
</span><span id="LiLit-609"><a href="#LiLit-609"><span class="linenos">609</span></a>        <span class="n">depth_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;depth_i&quot;</span><span class="p">])</span>
</span><span id="LiLit-610"><a href="#LiLit-610"><span class="linenos">610</span></a>
</span><span id="LiLit-611"><a href="#LiLit-611"><span class="linenos">611</span></a>        <span class="c1"># Convert the depth to a pixel value</span>
</span><span id="LiLit-612"><a href="#LiLit-612"><span class="linenos">612</span></a>        <span class="n">depth_p</span> <span class="o">/=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit-613"><a href="#LiLit-613"><span class="linenos">613</span></a>        <span class="n">depth_i</span> <span class="o">/=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit-614"><a href="#LiLit-614"><span class="linenos">614</span></a>        <span class="n">depth_p</span> <span class="o">=</span> <span class="n">depth_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="LiLit-615"><a href="#LiLit-615"><span class="linenos">615</span></a>            <span class="n">hp</span><span class="o">.</span><span class="n">pixelfunc</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="LiLit-616"><a href="#LiLit-616"><span class="linenos">616</span></a>        <span class="p">)</span>
</span><span id="LiLit-617"><a href="#LiLit-617"><span class="linenos">617</span></a>        <span class="n">depth_i</span> <span class="o">=</span> <span class="n">depth_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="LiLit-618"><a href="#LiLit-618"><span class="linenos">618</span></a>            <span class="n">hp</span><span class="o">.</span><span class="n">pixelfunc</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="LiLit-619"><a href="#LiLit-619"><span class="linenos">619</span></a>        <span class="p">)</span>
</span><span id="LiLit-620"><a href="#LiLit-620"><span class="linenos">620</span></a>
</span><span id="LiLit-621"><a href="#LiLit-621"><span class="linenos">621</span></a>        <span class="c1"># Get the number of frequencies</span>
</span><span id="LiLit-622"><a href="#LiLit-622"><span class="linenos">622</span></a>        <span class="n">n_freq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
</span><span id="LiLit-623"><a href="#LiLit-623"><span class="linenos">623</span></a>
</span><span id="LiLit-624"><a href="#LiLit-624"><span class="linenos">624</span></a>        <span class="c1"># Define the ell values as a numpy array</span>
</span><span id="LiLit-625"><a href="#LiLit-625"><span class="linenos">625</span></a>        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit-626"><a href="#LiLit-626"><span class="linenos">626</span></a>
</span><span id="LiLit-627"><a href="#LiLit-627"><span class="linenos">627</span></a>        <span class="c1"># Define the keys for the dictionary that will be returned</span>
</span><span id="LiLit-628"><a href="#LiLit-628"><span class="linenos">628</span></a>        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">]</span>
</span><span id="LiLit-629"><a href="#LiLit-629"><span class="linenos">629</span></a>
</span><span id="LiLit-630"><a href="#LiLit-630"><span class="linenos">630</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">fwhms</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</span><span id="LiLit-631"><a href="#LiLit-631"><span class="linenos">631</span></a>        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>
</span><span id="LiLit-632"><a href="#LiLit-632"><span class="linenos">632</span></a>
</span><span id="LiLit-633"><a href="#LiLit-633"><span class="linenos">633</span></a>        <span class="c1"># Calculate the Gaussian beam function</span>
</span><span id="LiLit-634"><a href="#LiLit-634"><span class="linenos">634</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="LiLit-635"><a href="#LiLit-635"><span class="linenos">635</span></a>
</span><span id="LiLit-636"><a href="#LiLit-636"><span class="linenos">636</span></a>        <span class="c1"># Calculate the polarization factor</span>
</span><span id="LiLit-637"><a href="#LiLit-637"><span class="linenos">637</span></a>        <span class="n">pol_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="LiLit-638"><a href="#LiLit-638"><span class="linenos">638</span></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sigma2</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">],</span>
</span><span id="LiLit-639"><a href="#LiLit-639"><span class="linenos">639</span></a>        <span class="p">)</span>
</span><span id="LiLit-640"><a href="#LiLit-640"><span class="linenos">640</span></a>
</span><span id="LiLit-641"><a href="#LiLit-641"><span class="linenos">641</span></a>        <span class="c1"># Calculate the polarization factor as a function of ell</span>
</span><span id="LiLit-642"><a href="#LiLit-642"><span class="linenos">642</span></a>        <span class="n">pol_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pol_factor</span><span class="p">)</span>
</span><span id="LiLit-643"><a href="#LiLit-643"><span class="linenos">643</span></a>
</span><span id="LiLit-644"><a href="#LiLit-644"><span class="linenos">644</span></a>        <span class="c1"># Calculate the Gaussian beam function for each polarization</span>
</span><span id="LiLit-645"><a href="#LiLit-645"><span class="linenos">645</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LiLit-646"><a href="#LiLit-646"><span class="linenos">646</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pol_factor</span><span class="p">):</span>
</span><span id="LiLit-647"><a href="#LiLit-647"><span class="linenos">647</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="LiLit-648"><a href="#LiLit-648"><span class="linenos">648</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span><span id="LiLit-649"><a href="#LiLit-649"><span class="linenos">649</span></a>
</span><span id="LiLit-650"><a href="#LiLit-650"><span class="linenos">650</span></a>        <span class="c1"># Initialize the dictionary that will be returned</span>
</span><span id="LiLit-651"><a href="#LiLit-651"><span class="linenos">651</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
</span><span id="LiLit-652"><a href="#LiLit-652"><span class="linenos">652</span></a>
</span><span id="LiLit-653"><a href="#LiLit-653"><span class="linenos">653</span></a>        <span class="c1"># Calculate the unnormalized power spectra</span>
</span><span id="LiLit-654"><a href="#LiLit-654"><span class="linenos">654</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_i</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit-655"><a href="#LiLit-655"><span class="linenos">655</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit-656"><a href="#LiLit-656"><span class="linenos">656</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit-657"><a href="#LiLit-657"><span class="linenos">657</span></a>
</span><span id="LiLit-658"><a href="#LiLit-658"><span class="linenos">658</span></a>        <span class="c1"># Calculate the normalized power spectra</span>
</span><span id="LiLit-659"><a href="#LiLit-659"><span class="linenos">659</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit-660"><a href="#LiLit-660"><span class="linenos">660</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit-661"><a href="#LiLit-661"><span class="linenos">661</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit-662"><a href="#LiLit-662"><span class="linenos">662</span></a>
</span><span id="LiLit-663"><a href="#LiLit-663"><span class="linenos">663</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-664"><a href="#LiLit-664"><span class="linenos">664</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-665"><a href="#LiLit-665"><span class="linenos">665</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-666"><a href="#LiLit-666"><span class="linenos">666</span></a>
</span><span id="LiLit-667"><a href="#LiLit-667"><span class="linenos">667</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-668"><a href="#LiLit-668"><span class="linenos">668</span></a>
</span><span id="LiLit-669"><a href="#LiLit-669"><span class="linenos">669</span></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-670"><a href="#LiLit-670"><span class="linenos">670</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the fiducial spectra and the noise power spectra.&quot;&quot;&quot;</span>
</span><span id="LiLit-671"><a href="#LiLit-671"><span class="linenos">671</span></a>        <span class="c1"># Compute the fiducial and noise power spectra</span>
</span><span id="LiLit-672"><a href="#LiLit-672"><span class="linenos">672</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_fidu</span><span class="p">()</span>
</span><span id="LiLit-673"><a href="#LiLit-673"><span class="linenos">673</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_noise</span><span class="p">()</span>
</span><span id="LiLit-674"><a href="#LiLit-674"><span class="linenos">674</span></a>
</span><span id="LiLit-675"><a href="#LiLit-675"><span class="linenos">675</span></a>        <span class="c1"># Compute the covariance matrices</span>
</span><span id="LiLit-676"><a href="#LiLit-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">)</span>
</span><span id="LiLit-677"><a href="#LiLit-677"><span class="linenos">677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">)</span>
</span><span id="LiLit-678"><a href="#LiLit-678"><span class="linenos">678</span></a>
</span><span id="LiLit-679"><a href="#LiLit-679"><span class="linenos">679</span></a>        <span class="c1"># Print some information for debugging</span>
</span><span id="LiLit-680"><a href="#LiLit-680"><span class="linenos">680</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-681"><a href="#LiLit-681"><span class="linenos">681</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of fiducial CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-682"><a href="#LiLit-682"><span class="linenos">682</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of noise CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-683"><a href="#LiLit-683"><span class="linenos">683</span></a>
</span><span id="LiLit-684"><a href="#LiLit-684"><span class="linenos">684</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing the first few values to check that it starts from 0...&quot;</span><span class="p">)</span>
</span><span id="LiLit-685"><a href="#LiLit-685"><span class="linenos">685</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-686"><a href="#LiLit-686"><span class="linenos">686</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fiducial CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-687"><a href="#LiLit-687"><span class="linenos">687</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-688"><a href="#LiLit-688"><span class="linenos">688</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-689"><a href="#LiLit-689"><span class="linenos">689</span></a>
</span><span id="LiLit-690"><a href="#LiLit-690"><span class="linenos">690</span></a>        <span class="c1"># Compute the total covariance matrix</span>
</span><span id="LiLit-691"><a href="#LiLit-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit-692"><a href="#LiLit-692"><span class="linenos">692</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-693"><a href="#LiLit-693"><span class="linenos">693</span></a>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-694"><a href="#LiLit-694"><span class="linenos">694</span></a>        <span class="p">)</span>
</span><span id="LiLit-695"><a href="#LiLit-695"><span class="linenos">695</span></a>
</span><span id="LiLit-696"><a href="#LiLit-696"><span class="linenos">696</span></a>        <span class="c1"># Compute the inverse of the covariance matrix</span>
</span><span id="LiLit-697"><a href="#LiLit-697"><span class="linenos">697</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
</span><span id="LiLit-698"><a href="#LiLit-698"><span class="linenos">698</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Gauss_keys</span><span class="p">()</span>
</span><span id="LiLit-699"><a href="#LiLit-699"><span class="linenos">699</span></a>            <span class="n">sigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">)</span>
</span><span id="LiLit-700"><a href="#LiLit-700"><span class="linenos">700</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_sigma</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)</span>
</span><span id="LiLit-701"><a href="#LiLit-701"><span class="linenos">701</span></a>
</span><span id="LiLit-702"><a href="#LiLit-702"><span class="linenos">702</span></a>    <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-703"><a href="#LiLit-703"><span class="linenos">703</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Defines requirements of the likelihood, specifying quantities calculated by a theory code are needed. Note that you may want to change the overall keyword from &#39;Cl&#39; to &#39;unlensed_Cl&#39; if you want to work without considering lensing.&quot;&quot;&quot;</span>
</span><span id="LiLit-704"><a href="#LiLit-704"><span class="linenos">704</span></a>        <span class="c1"># The likelihood needs the lensed CMB angular power spectra. The keyword can be set to &quot;unlensed_Cl&quot; to get the unlensed ones</span>
</span><span id="LiLit-705"><a href="#LiLit-705"><span class="linenos">705</span></a>        <span class="n">requitements</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit-706"><a href="#LiLit-706"><span class="linenos">706</span></a>        <span class="n">requitements</span><span class="p">[</span><span class="s2">&quot;Cl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cl</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
</span><span id="LiLit-707"><a href="#LiLit-707"><span class="linenos">707</span></a>        <span class="c1"># If debug is set to True, the likelihood will print the list of items required by the likelihood</span>
</span><span id="LiLit-708"><a href="#LiLit-708"><span class="linenos">708</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-709"><a href="#LiLit-709"><span class="linenos">709</span></a>            <span class="n">requitements</span><span class="p">[</span><span class="s2">&quot;CAMBdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LiLit-710"><a href="#LiLit-710"><span class="linenos">710</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="LiLit-711"><a href="#LiLit-711"><span class="linenos">711</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You requested that Cobaya provides to the likelihood the following items: </span><span class="si">{</span><span class="n">requitements</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="LiLit-712"><a href="#LiLit-712"><span class="linenos">712</span></a>            <span class="p">)</span>
</span><span id="LiLit-713"><a href="#LiLit-713"><span class="linenos">713</span></a>        <span class="k">return</span> <span class="n">requitements</span>
</span><span id="LiLit-714"><a href="#LiLit-714"><span class="linenos">714</span></a>
</span><span id="LiLit-715"><a href="#LiLit-715"><span class="linenos">715</span></a>    <span class="k">def</span> <span class="nf">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov</span><span class="p">):</span>
</span><span id="LiLit-716"><a href="#LiLit-716"><span class="linenos">716</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data vector from the covariance matrix.</span>
</span><span id="LiLit-717"><a href="#LiLit-717"><span class="linenos">717</span></a>
</span><span id="LiLit-718"><a href="#LiLit-718"><span class="linenos">718</span></a><span class="sd">        Extracts the data vector necessary for the Gaussian case. Note that this will cut the null value since some may be null when the fields have different values for lmax.</span>
</span><span id="LiLit-719"><a href="#LiLit-719"><span class="linenos">719</span></a>
</span><span id="LiLit-720"><a href="#LiLit-720"><span class="linenos">720</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-721"><a href="#LiLit-721"><span class="linenos">721</span></a><span class="sd">            cov (np.ndarray):</span>
</span><span id="LiLit-722"><a href="#LiLit-722"><span class="linenos">722</span></a><span class="sd">                A ndarray containing the covariance matrices, with some null ones.</span>
</span><span id="LiLit-723"><a href="#LiLit-723"><span class="linenos">723</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-724"><a href="#LiLit-724"><span class="linenos">724</span></a>        <span class="k">return</span> <span class="n">cov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)][</span><span class="n">cov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-725"><a href="#LiLit-725"><span class="linenos">725</span></a>
</span><span id="LiLit-726"><a href="#LiLit-726"><span class="linenos">726</span></a>    <span class="k">def</span> <span class="nf">chi_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="LiLit-727"><a href="#LiLit-727"><span class="linenos">727</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes proper chi-square term for the exact likelihood case.</span>
</span><span id="LiLit-728"><a href="#LiLit-728"><span class="linenos">728</span></a>
</span><span id="LiLit-729"><a href="#LiLit-729"><span class="linenos">729</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-730"><a href="#LiLit-730"><span class="linenos">730</span></a><span class="sd">            i (int, optional):</span>
</span><span id="LiLit-731"><a href="#LiLit-731"><span class="linenos">731</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="LiLit-732"><a href="#LiLit-732"><span class="linenos">732</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-733"><a href="#LiLit-733"><span class="linenos">733</span></a>        <span class="c1"># If the number of datasets is not equal to 1, then we have a</span>
</span><span id="LiLit-734"><a href="#LiLit-734"><span class="linenos">734</span></a>        <span class="c1"># multi-dataset case, in which case we need to compute the</span>
</span><span id="LiLit-735"><a href="#LiLit-735"><span class="linenos">735</span></a>        <span class="c1"># covariance matrix for each dataset.</span>
</span><span id="LiLit-736"><a href="#LiLit-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LiLit-737"><a href="#LiLit-737"><span class="linenos">737</span></a>            <span class="c1"># We extract the covariance matrix and data for the ith</span>
</span><span id="LiLit-738"><a href="#LiLit-738"><span class="linenos">738</span></a>            <span class="c1"># dataset.</span>
</span><span id="LiLit-739"><a href="#LiLit-739"><span class="linenos">739</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit-740"><a href="#LiLit-740"><span class="linenos">740</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit-741"><a href="#LiLit-741"><span class="linenos">741</span></a>            <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">coba</span><span class="p">)</span>
</span><span id="LiLit-742"><a href="#LiLit-742"><span class="linenos">742</span></a>            <span class="c1"># If the determinant is equal to 0, then we need to reduce</span>
</span><span id="LiLit-743"><a href="#LiLit-743"><span class="linenos">743</span></a>            <span class="c1"># the dimensionality of the data and covariance matrix.</span>
</span><span id="LiLit-744"><a href="#LiLit-744"><span class="linenos">744</span></a>            <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LiLit-745"><a href="#LiLit-745"><span class="linenos">745</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="LiLit-746"><a href="#LiLit-746"><span class="linenos">746</span></a>                <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_data</span><span class="p">(</span><span class="n">coba</span><span class="p">)</span>
</span><span id="LiLit-747"><a href="#LiLit-747"><span class="linenos">747</span></a>            <span class="c1"># We compute the matrix M using the covariance matrix and</span>
</span><span id="LiLit-748"><a href="#LiLit-748"><span class="linenos">748</span></a>            <span class="c1"># the data.</span>
</span><span id="LiLit-749"><a href="#LiLit-749"><span class="linenos">749</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">coba</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="LiLit-750"><a href="#LiLit-750"><span class="linenos">750</span></a>            <span class="c1"># We compute the chi-square term using the trace of M, the</span>
</span><span id="LiLit-751"><a href="#LiLit-751"><span class="linenos">751</span></a>            <span class="c1"># log determinant of M, and the number of fields.</span>
</span><span id="LiLit-752"><a href="#LiLit-752"><span class="linenos">752</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">M</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-753"><a href="#LiLit-753"><span class="linenos">753</span></a>        <span class="c1"># If the number of datasets is equal to 1, then we have a single</span>
</span><span id="LiLit-754"><a href="#LiLit-754"><span class="linenos">754</span></a>        <span class="c1"># dataset case, in which case we do not need to loop over the</span>
</span><span id="LiLit-755"><a href="#LiLit-755"><span class="linenos">755</span></a>        <span class="c1"># datasets.</span>
</span><span id="LiLit-756"><a href="#LiLit-756"><span class="linenos">756</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-757"><a href="#LiLit-757"><span class="linenos">757</span></a>            <span class="c1"># We compute the matrix M using the covariance matrix and</span>
</span><span id="LiLit-758"><a href="#LiLit-758"><span class="linenos">758</span></a>            <span class="c1"># the data.</span>
</span><span id="LiLit-759"><a href="#LiLit-759"><span class="linenos">759</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span>
</span><span id="LiLit-760"><a href="#LiLit-760"><span class="linenos">760</span></a>            <span class="c1"># We compute the chi-square term using M, the log of M, and</span>
</span><span id="LiLit-761"><a href="#LiLit-761"><span class="linenos">761</span></a>            <span class="c1"># a constant value.</span>
</span><span id="LiLit-762"><a href="#LiLit-762"><span class="linenos">762</span></a>            <span class="k">return</span> <span class="n">M</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">M</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="LiLit-763"><a href="#LiLit-763"><span class="linenos">763</span></a>
</span><span id="LiLit-764"><a href="#LiLit-764"><span class="linenos">764</span></a>    <span class="k">def</span> <span class="nf">chi_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="LiLit-765"><a href="#LiLit-765"><span class="linenos">765</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes proper chi-square term for the Gaussian likelihood case.</span>
</span><span id="LiLit-766"><a href="#LiLit-766"><span class="linenos">766</span></a>
</span><span id="LiLit-767"><a href="#LiLit-767"><span class="linenos">767</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-768"><a href="#LiLit-768"><span class="linenos">768</span></a><span class="sd">            i (int, optional):</span>
</span><span id="LiLit-769"><a href="#LiLit-769"><span class="linenos">769</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="LiLit-770"><a href="#LiLit-770"><span class="linenos">770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-771"><a href="#LiLit-771"><span class="linenos">771</span></a>        <span class="c1"># If we have more than one data vector</span>
</span><span id="LiLit-772"><a href="#LiLit-772"><span class="linenos">772</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LiLit-773"><a href="#LiLit-773"><span class="linenos">773</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="LiLit-774"><a href="#LiLit-774"><span class="linenos">774</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="LiLit-775"><a href="#LiLit-775"><span class="linenos">775</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span>
</span><span id="LiLit-776"><a href="#LiLit-776"><span class="linenos">776</span></a>        <span class="c1"># If we have only one data vector</span>
</span><span id="LiLit-777"><a href="#LiLit-777"><span class="linenos">777</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-778"><a href="#LiLit-778"><span class="linenos">778</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="LiLit-779"><a href="#LiLit-779"><span class="linenos">779</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="LiLit-780"><a href="#LiLit-780"><span class="linenos">780</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span> <span class="o">*</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span>
</span><span id="LiLit-781"><a href="#LiLit-781"><span class="linenos">781</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit-782"><a href="#LiLit-782"><span class="linenos">782</span></a>
</span><span id="LiLit-783"><a href="#LiLit-783"><span class="linenos">783</span></a>    <span class="k">def</span> <span class="nf">compute_chi_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="LiLit-784"><a href="#LiLit-784"><span class="linenos">784</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Chooses which chi-square term to compute.</span>
</span><span id="LiLit-785"><a href="#LiLit-785"><span class="linenos">785</span></a>
</span><span id="LiLit-786"><a href="#LiLit-786"><span class="linenos">786</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit-787"><a href="#LiLit-787"><span class="linenos">787</span></a><span class="sd">            i (int, optional):</span>
</span><span id="LiLit-788"><a href="#LiLit-788"><span class="linenos">788</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="LiLit-789"><a href="#LiLit-789"><span class="linenos">789</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit-790"><a href="#LiLit-790"><span class="linenos">790</span></a>        <span class="c1"># check if the likelihood is &quot;exact&quot;</span>
</span><span id="LiLit-791"><a href="#LiLit-791"><span class="linenos">791</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;exact&quot;</span><span class="p">:</span>
</span><span id="LiLit-792"><a href="#LiLit-792"><span class="linenos">792</span></a>            <span class="c1"># if so, compute the chi-square term for the exact likelihood</span>
</span><span id="LiLit-793"><a href="#LiLit-793"><span class="linenos">793</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_exact</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="LiLit-794"><a href="#LiLit-794"><span class="linenos">794</span></a>        <span class="c1"># if not, check if it is &quot;gaussian&quot;</span>
</span><span id="LiLit-795"><a href="#LiLit-795"><span class="linenos">795</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
</span><span id="LiLit-796"><a href="#LiLit-796"><span class="linenos">796</span></a>            <span class="c1"># if so, compute the chi-square term for the gaussian likelihood</span>
</span><span id="LiLit-797"><a href="#LiLit-797"><span class="linenos">797</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_gaussian</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="LiLit-798"><a href="#LiLit-798"><span class="linenos">798</span></a>        <span class="c1"># if neither, print an error message</span>
</span><span id="LiLit-799"><a href="#LiLit-799"><span class="linenos">799</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-800"><a href="#LiLit-800"><span class="linenos">800</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You requested something different from &#39;exact or &#39;gaussian&#39;!&quot;</span><span class="p">)</span>
</span><span id="LiLit-801"><a href="#LiLit-801"><span class="linenos">801</span></a>            <span class="k">return</span>
</span><span id="LiLit-802"><a href="#LiLit-802"><span class="linenos">802</span></a>
</span><span id="LiLit-803"><a href="#LiLit-803"><span class="linenos">803</span></a>    <span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit-804"><a href="#LiLit-804"><span class="linenos">804</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the log likelihood.&quot;&quot;&quot;</span>
</span><span id="LiLit-805"><a href="#LiLit-805"><span class="linenos">805</span></a>        <span class="c1"># Get the array of multipoles</span>
</span><span id="LiLit-806"><a href="#LiLit-806"><span class="linenos">806</span></a>        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit-807"><a href="#LiLit-807"><span class="linenos">807</span></a>        <span class="c1"># Compute the log likelihood for each multipole</span>
</span><span id="LiLit-808"><a href="#LiLit-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LiLit-809"><a href="#LiLit-809"><span class="linenos">809</span></a>            <span class="n">logp_ℓ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ell</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="LiLit-810"><a href="#LiLit-810"><span class="linenos">810</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">):</span>
</span><span id="LiLit-811"><a href="#LiLit-811"><span class="linenos">811</span></a>                <span class="n">logp_ℓ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chi_part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="LiLit-812"><a href="#LiLit-812"><span class="linenos">812</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit-813"><a href="#LiLit-813"><span class="linenos">813</span></a>            <span class="n">logp_ℓ</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chi_part</span><span class="p">()</span>
</span><span id="LiLit-814"><a href="#LiLit-814"><span class="linenos">814</span></a>        <span class="c1"># Sum the log likelihood over multipoles</span>
</span><span id="LiLit-815"><a href="#LiLit-815"><span class="linenos">815</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logp_ℓ</span><span class="p">)</span>
</span><span id="LiLit-816"><a href="#LiLit-816"><span class="linenos">816</span></a>
</span><span id="LiLit-817"><a href="#LiLit-817"><span class="linenos">817</span></a>    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params_values</span><span class="p">):</span>
</span><span id="LiLit-818"><a href="#LiLit-818"><span class="linenos">818</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the log likelihood and pass it to Cobaya to carry on the MCMC process.&quot;&quot;&quot;</span>
</span><span id="LiLit-819"><a href="#LiLit-819"><span class="linenos">819</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-820"><a href="#LiLit-820"><span class="linenos">820</span></a>            <span class="n">CAMBdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">get_CAMBdata</span><span class="p">()</span>
</span><span id="LiLit-821"><a href="#LiLit-821"><span class="linenos">821</span></a>            <span class="n">pars</span> <span class="o">=</span> <span class="n">CAMBdata</span><span class="o">.</span><span class="n">Params</span>
</span><span id="LiLit-822"><a href="#LiLit-822"><span class="linenos">822</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="LiLit-823"><a href="#LiLit-823"><span class="linenos">823</span></a>
</span><span id="LiLit-824"><a href="#LiLit-824"><span class="linenos">824</span></a>        <span class="c1"># Get the Cls from Cobaya</span>
</span><span id="LiLit-825"><a href="#LiLit-825"><span class="linenos">825</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">get_Cl</span><span class="p">(</span><span class="n">ell_factor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit-826"><a href="#LiLit-826"><span class="linenos">826</span></a>
</span><span id="LiLit-827"><a href="#LiLit-827"><span class="linenos">827</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-828"><a href="#LiLit-828"><span class="linenos">828</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of Cobaya CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-829"><a href="#LiLit-829"><span class="linenos">829</span></a>
</span><span id="LiLit-830"><a href="#LiLit-830"><span class="linenos">830</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit-831"><a href="#LiLit-831"><span class="linenos">831</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing the first few values to check that it starts from 0...&quot;</span><span class="p">)</span>
</span><span id="LiLit-832"><a href="#LiLit-832"><span class="linenos">832</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cobaya CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit-833"><a href="#LiLit-833"><span class="linenos">833</span></a>
</span><span id="LiLit-834"><a href="#LiLit-834"><span class="linenos">834</span></a>        <span class="c1"># Fill the covariance matrix with the Cls from Cobaya</span>
</span><span id="LiLit-835"><a href="#LiLit-835"><span class="linenos">835</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="p">)</span>
</span><span id="LiLit-836"><a href="#LiLit-836"><span class="linenos">836</span></a>
</span><span id="LiLit-837"><a href="#LiLit-837"><span class="linenos">837</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-838"><a href="#LiLit-838"><span class="linenos">838</span></a>            <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit-839"><a href="#LiLit-839"><span class="linenos">839</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fiducial CLs&quot;</span><span class="p">)</span>
</span><span id="LiLit-840"><a href="#LiLit-840"><span class="linenos">840</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cobaya CLs&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</span><span id="LiLit-841"><a href="#LiLit-841"><span class="linenos">841</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Noise CLs&quot;</span><span class="p">)</span>
</span><span id="LiLit-842"><a href="#LiLit-842"><span class="linenos">842</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="LiLit-843"><a href="#LiLit-843"><span class="linenos">843</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="LiLit-844"><a href="#LiLit-844"><span class="linenos">844</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="LiLit-845"><a href="#LiLit-845"><span class="linenos">845</span></a>
</span><span id="LiLit-846"><a href="#LiLit-846"><span class="linenos">846</span></a>        <span class="c1"># Add the noise covariance to the covariance matrix filled with the Cls from Cobaya</span>
</span><span id="LiLit-847"><a href="#LiLit-847"><span class="linenos">847</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coba</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit-848"><a href="#LiLit-848"><span class="linenos">848</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-849"><a href="#LiLit-849"><span class="linenos">849</span></a>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit-850"><a href="#LiLit-850"><span class="linenos">850</span></a>        <span class="p">)</span>
</span><span id="LiLit-851"><a href="#LiLit-851"><span class="linenos">851</span></a>
</span><span id="LiLit-852"><a href="#LiLit-852"><span class="linenos">852</span></a>        <span class="c1"># Compute the likelihood</span>
</span><span id="LiLit-853"><a href="#LiLit-853"><span class="linenos">853</span></a>        <span class="n">logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">()</span>
</span><span id="LiLit-854"><a href="#LiLit-854"><span class="linenos">854</span></a>
</span><span id="LiLit-855"><a href="#LiLit-855"><span class="linenos">855</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit-856"><a href="#LiLit-856"><span class="linenos">856</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">logp</span><span class="p">)</span>
</span><span id="LiLit-857"><a href="#LiLit-857"><span class="linenos">857</span></a>            <span class="n">exit</span><span class="p">()</span>
</span><span id="LiLit-858"><a href="#LiLit-858"><span class="linenos">858</span></a>
</span><span id="LiLit-859"><a href="#LiLit-859"><span class="linenos">859</span></a>        <span class="k">return</span> <span class="n">logp</span>
</span></pre></div>


            <div class="docstring"><p>Class defining the Likelihood for LiteBIRD (LiLit).</p>

<p>Within LiLit, the most relevant study cases of LiteBIRD (T, E, B) are already tested and working. So, if you need to work with those, you should not need to look into the actual definition of the likelihood function, since you can proptly start running your MCMCs. Despite this, you should provide to the likelihood some file where to find the proper LiteBIRD noise power spectra, given that LiLit is implementing a simple inverse noise weighting just as a place-holder for something more realistic. As regards lensing, LiLit will need you to pass the reconstruction noise, since its computation is not coded, thus there is no place-holder for lensing.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>name (str):</strong>  The name for the likelihood, used in the output. It is necessary to pass it to LiLit. (default: None).</li>
<li><strong>fields (list):</strong>  List of fields in the data file (default: None).</li>
<li><strong>lmax (int or list):</strong>  Maximum multipole to consider (default: None).</li>
<li><strong>like (str, optional):</strong>  Type of likelihood to use (default: "exact"). Currently supports "exact" and "gaussian".</li>
<li><strong>lmin (int or list):</strong>  Minimum multipole to consider (default: 2).</li>
<li><strong>cl_file (str, optional):</strong>  Path to Cl file (default: None).</li>
<li><strong>nl_file (str, optional):</strong>  Path to noise file (default: None).</li>
<li><strong>mapping (dict, optional):</strong>  Dictionary of mapping between the fields in the noise file and the fields in the likelihood, used only if nl_file has .txt extension (default: None).</li>
<li><strong>experiment (str, optional):</strong>  Name of experiment (default: None).</li>
<li><strong>nside (int, optional):</strong>  Nside of the map (default: None).</li>
<li><strong>r (float, optional):</strong>  Tensor-to-scalar ratio (default: None).</li>
<li><strong>nt (float, optional):</strong>  Tensor spectral tilt (default: None).</li>
<li><strong>pivot_t (float, optional):</strong>  Pivot scale of the tensor primordial power spectrum (default: 0.01).</li>
<li><strong>fsky (float or list):</strong>  Sky fraction (default: 1).</li>
<li><strong>sep (str, optional):</strong>  Separator used in the data file (default: "").</li>
<li><strong>debug (bool, optional):</strong>  If True, produces more verbose output (default: None).</li>
</ul>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>fields (list):</strong>  List of fields in the data file.</li>
<li><strong>n_fields (int):</strong>  Number of fields.</li>
<li><strong>keys (list):</strong>  List of keywords for the dictionaries.</li>
<li><strong>gauss_keys (list):</strong>  List of keywords for the Gaussian likelihood (4-points).</li>
<li><strong>sigma2 (np.ndarray):</strong>  Array of covariances for the Gaussian likelihood case.</li>
<li><strong>lmax (int or list):</strong>  List of lmax values.</li>
<li><strong>lmaxes (dict):</strong>  Dictionary of lmax values.</li>
<li><strong>fsky (int or list):</strong>  List of fsky values.</li>
<li><strong>fskies (dict):</strong>  Dictionary of fsky values.</li>
<li><strong>lmin (int or list):</strong>  Minimum multipole to consider.</li>
<li><strong>lmins (dict):</strong>  Dictionary of lmin values.</li>
<li><strong>like (str):</strong>  Type of likelihood to use.</li>
<li><strong>cl_file (str):</strong>  Path to Cl file.</li>
<li><strong>fiduCLS (dict):</strong>  Dictionary of fiducial Cls.</li>
<li><strong>noiseCLS (dict):</strong>  Dictionary of noise Cls.</li>
<li><strong>fiduCOV (np.ndarray):</strong>  Fiducial covariance matrix obtained from the corresponding dictionary.</li>
<li><strong>noiseCOV (np.ndarray):</strong>  Noise covariance matrix obtained from the corresponding dictionary.</li>
<li><strong>data (np.ndarray):</strong>  Data vector obtained by summing fiduCOV + noiseCOV.</li>
<li><strong>cobaCLS (dict):</strong>  Dictionary of Cobaya Cls.</li>
<li><strong>cobaCOV (np.ndarray):</strong>  Cobaya covariance matrix obtained from the corresponding dictionary.</li>
<li><strong>coba (np.ndarray):</strong>  Cobaya vector obtained by summing cobaCOV + noiseCOV.</li>
<li><strong>nl_file (str):</strong>  Path to noise file.</li>
<li><strong>mapping (dict):</strong>  Dictionary of mapping between the fields in the noise file and the fields in the likelihood, used only if nl_file has .txt extension.</li>
<li><strong>experiment (str):</strong>  Name of experiment.</li>
<li><strong>nside (int):</strong>  Nside of the map.</li>
<li><strong>r (float):</strong>  Tensor-to-scalar ratio.</li>
<li><strong>nt (float):</strong>  Tensor spectral tilt.</li>
<li><strong>pivot_t (float):</strong>  Pivot scale of the tensor primordial power spectrum.</li>
<li><strong>sep (str):</strong>  Separator used in the data file.</li>
<li><strong>debug (bool):</strong>  If True, produces more output.</li>
</ul>
</div>


                            <div id="LiLit.__init__" class="classattr">
                                        <input id="LiLit.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LiLit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">name</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">fields</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">lmax</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">like</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span>,</span><span class="param">	<span class="n">lmin</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">cl_file</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">nl_file</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">mapping</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">experiment</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">nside</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">r</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">nt</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">pivot_t</span><span class="o">=</span><span class="mf">0.01</span>,</span><span class="param">	<span class="n">fsky</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="LiLit.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.__init__-114"><a href="#LiLit.__init__-114"><span class="linenos">114</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="LiLit.__init__-115"><a href="#LiLit.__init__-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LiLit.__init__-116"><a href="#LiLit.__init__-116"><span class="linenos">116</span></a>        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-117"><a href="#LiLit.__init__-117"><span class="linenos">117</span></a>        <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-118"><a href="#LiLit.__init__-118"><span class="linenos">118</span></a>        <span class="n">lmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-119"><a href="#LiLit.__init__-119"><span class="linenos">119</span></a>        <span class="n">like</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span>
</span><span id="LiLit.__init__-120"><a href="#LiLit.__init__-120"><span class="linenos">120</span></a>        <span class="n">lmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="LiLit.__init__-121"><a href="#LiLit.__init__-121"><span class="linenos">121</span></a>        <span class="n">cl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-122"><a href="#LiLit.__init__-122"><span class="linenos">122</span></a>        <span class="n">nl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-123"><a href="#LiLit.__init__-123"><span class="linenos">123</span></a>        <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-124"><a href="#LiLit.__init__-124"><span class="linenos">124</span></a>        <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-125"><a href="#LiLit.__init__-125"><span class="linenos">125</span></a>        <span class="n">nside</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-126"><a href="#LiLit.__init__-126"><span class="linenos">126</span></a>        <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-127"><a href="#LiLit.__init__-127"><span class="linenos">127</span></a>        <span class="n">nt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-128"><a href="#LiLit.__init__-128"><span class="linenos">128</span></a>        <span class="n">pivot_t</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span id="LiLit.__init__-129"><a href="#LiLit.__init__-129"><span class="linenos">129</span></a>        <span class="n">fsky</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="LiLit.__init__-130"><a href="#LiLit.__init__-130"><span class="linenos">130</span></a>        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="LiLit.__init__-131"><a href="#LiLit.__init__-131"><span class="linenos">131</span></a>        <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LiLit.__init__-132"><a href="#LiLit.__init__-132"><span class="linenos">132</span></a>    <span class="p">):</span>
</span><span id="LiLit.__init__-133"><a href="#LiLit.__init__-133"><span class="linenos">133</span></a>        <span class="c1"># Check that the user has provided the name of the likelihood</span>
</span><span id="LiLit.__init__-134"><a href="#LiLit.__init__-134"><span class="linenos">134</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.__init__-135"><a href="#LiLit.__init__-135"><span class="linenos">135</span></a>            <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit.__init__-136"><a href="#LiLit.__init__-136"><span class="linenos">136</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide the name of the likelihood (e.g. &#39;BB&#39; or &#39;TTTEEE&#39;)&quot;</span>
</span><span id="LiLit.__init__-137"><a href="#LiLit.__init__-137"><span class="linenos">137</span></a>        <span class="c1"># Check that the user has provided the fields</span>
</span><span id="LiLit.__init__-138"><a href="#LiLit.__init__-138"><span class="linenos">138</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.__init__-139"><a href="#LiLit.__init__-139"><span class="linenos">139</span></a>            <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit.__init__-140"><a href="#LiLit.__init__-140"><span class="linenos">140</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide the fields (e.g. &#39;b&#39; or [&#39;t&#39;, &#39;e&#39;])&quot;</span>
</span><span id="LiLit.__init__-141"><a href="#LiLit.__init__-141"><span class="linenos">141</span></a>        <span class="c1"># Check that the user has provided the maximum multipole</span>
</span><span id="LiLit.__init__-142"><a href="#LiLit.__init__-142"><span class="linenos">142</span></a>        <span class="k">assert</span> <span class="n">lmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must provide the lmax (e.g. 300)&quot;</span>
</span><span id="LiLit.__init__-143"><a href="#LiLit.__init__-143"><span class="linenos">143</span></a>
</span><span id="LiLit.__init__-144"><a href="#LiLit.__init__-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
</span><span id="LiLit.__init__-145"><a href="#LiLit.__init__-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</span><span id="LiLit.__init__-146"><a href="#LiLit.__init__-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="n">lmin</span>
</span><span id="LiLit.__init__-147"><a href="#LiLit.__init__-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">=</span> <span class="n">like</span>
</span><span id="LiLit.__init__-148"><a href="#LiLit.__init__-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span>
</span><span id="LiLit.__init__-149"><a href="#LiLit.__init__-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span> <span class="o">=</span> <span class="n">cl_file</span>
</span><span id="LiLit.__init__-150"><a href="#LiLit.__init__-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span> <span class="o">=</span> <span class="n">nl_file</span>
</span><span id="LiLit.__init__-151"><a href="#LiLit.__init__-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
</span><span id="LiLit.__init__-152"><a href="#LiLit.__init__-152"><span class="linenos">152</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>
</span><span id="LiLit.__init__-153"><a href="#LiLit.__init__-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span>
</span><span id="LiLit.__init__-154"><a href="#LiLit.__init__-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit.__init__-155"><a href="#LiLit.__init__-155"><span class="linenos">155</span></a>            <span class="c1"># Check that the user has provided the nside if an experiment is used</span>
</span><span id="LiLit.__init__-156"><a href="#LiLit.__init__-156"><span class="linenos">156</span></a>            <span class="k">assert</span> <span class="n">nside</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must provide an nside to compute the noise&quot;</span>
</span><span id="LiLit.__init__-157"><a href="#LiLit.__init__-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="n">nside</span>
</span><span id="LiLit.__init__-158"><a href="#LiLit.__init__-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="LiLit.__init__-159"><a href="#LiLit.__init__-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">()</span>
</span><span id="LiLit.__init__-160"><a href="#LiLit.__init__-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="LiLit.__init__-161"><a href="#LiLit.__init__-161"><span class="linenos">161</span></a>            <span class="c1"># Check that the user has provided the tensor-to-scalar ratio if a BB likelihood is used</span>
</span><span id="LiLit.__init__-162"><a href="#LiLit.__init__-162"><span class="linenos">162</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.__init__-163"><a href="#LiLit.__init__-163"><span class="linenos">163</span></a>                <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit.__init__-164"><a href="#LiLit.__init__-164"><span class="linenos">164</span></a>            <span class="p">),</span> <span class="s2">&quot;You must provide the tensor-to-scalar ratio r for the fiducial production (defaul is at 0.01 Mpc^-1)&quot;</span>
</span><span id="LiLit.__init__-165"><a href="#LiLit.__init__-165"><span class="linenos">165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
</span><span id="LiLit.__init__-166"><a href="#LiLit.__init__-166"><span class="linenos">166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nt</span>
</span><span id="LiLit.__init__-167"><a href="#LiLit.__init__-167"><span class="linenos">167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pivot_t</span> <span class="o">=</span> <span class="n">pivot_t</span>
</span><span id="LiLit.__init__-168"><a href="#LiLit.__init__-168"><span class="linenos">168</span></a>
</span><span id="LiLit.__init__-169"><a href="#LiLit.__init__-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_lmin_lmax_fsky</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">fsky</span><span class="p">)</span>
</span><span id="LiLit.__init__-170"><a href="#LiLit.__init__-170"><span class="linenos">170</span></a>
</span><span id="LiLit.__init__-171"><a href="#LiLit.__init__-171"><span class="linenos">171</span></a>        <span class="n">Likelihood</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="LiLit.set_lmin_lmax_fsky" class="classattr">
                                        <input id="LiLit.set_lmin_lmax_fsky-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_lmin_lmax_fsky</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lmin</span>, </span><span class="param"><span class="n">lmax</span>, </span><span class="param"><span class="n">fsky</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.set_lmin_lmax_fsky-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.set_lmin_lmax_fsky"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.set_lmin_lmax_fsky-173"><a href="#LiLit.set_lmin_lmax_fsky-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">set_lmin_lmax_fsky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">fsky</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-174"><a href="#LiLit.set_lmin_lmax_fsky-174"><span class="linenos">174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Take lmin, lmax and fsky parameters and set the corresponding attributes.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-175"><a href="#LiLit.set_lmin_lmax_fsky-175"><span class="linenos">175</span></a>
</span><span id="LiLit.set_lmin_lmax_fsky-176"><a href="#LiLit.set_lmin_lmax_fsky-176"><span class="linenos">176</span></a><span class="sd">        Sets the minimum multipole, the maximum multipole and the sky fraction. This handles automatically the case of a single value or a list of values. Note that the lmin, lmax and fsky for the cross-correlations are set to the geometrical mean of the lmin, lmax and fsky of the two fields. This approximation has been tested and found to be accurate, at least assuming that the two masks of the two considered multipoles are very overlapped.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-177"><a href="#LiLit.set_lmin_lmax_fsky-177"><span class="linenos">177</span></a>
</span><span id="LiLit.set_lmin_lmax_fsky-178"><a href="#LiLit.set_lmin_lmax_fsky-178"><span class="linenos">178</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.set_lmin_lmax_fsky-179"><a href="#LiLit.set_lmin_lmax_fsky-179"><span class="linenos">179</span></a><span class="sd">            lmin (int or list):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-180"><a href="#LiLit.set_lmin_lmax_fsky-180"><span class="linenos">180</span></a><span class="sd">                Value or list of values of lmin.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-181"><a href="#LiLit.set_lmin_lmax_fsky-181"><span class="linenos">181</span></a><span class="sd">            lmax (int or list):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-182"><a href="#LiLit.set_lmin_lmax_fsky-182"><span class="linenos">182</span></a><span class="sd">                Value or list of values of lmax.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-183"><a href="#LiLit.set_lmin_lmax_fsky-183"><span class="linenos">183</span></a><span class="sd">            fsky (float or list):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-184"><a href="#LiLit.set_lmin_lmax_fsky-184"><span class="linenos">184</span></a><span class="sd">                Value or list of values of fsky.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-185"><a href="#LiLit.set_lmin_lmax_fsky-185"><span class="linenos">185</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.set_lmin_lmax_fsky-186"><a href="#LiLit.set_lmin_lmax_fsky-186"><span class="linenos">186</span></a>
</span><span id="LiLit.set_lmin_lmax_fsky-187"><a href="#LiLit.set_lmin_lmax_fsky-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit.set_lmin_lmax_fsky-188"><a href="#LiLit.set_lmin_lmax_fsky-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit.set_lmin_lmax_fsky-189"><a href="#LiLit.set_lmin_lmax_fsky-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit.set_lmin_lmax_fsky-190"><a href="#LiLit.set_lmin_lmax_fsky-190"><span class="linenos">190</span></a>
</span><span id="LiLit.set_lmin_lmax_fsky-191"><a href="#LiLit.set_lmin_lmax_fsky-191"><span class="linenos">191</span></a>        <span class="c1"># Set lmin</span>
</span><span id="LiLit.set_lmin_lmax_fsky-192"><a href="#LiLit.set_lmin_lmax_fsky-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-193"><a href="#LiLit.set_lmin_lmax_fsky-193"><span class="linenos">193</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.set_lmin_lmax_fsky-194"><a href="#LiLit.set_lmin_lmax_fsky-194"><span class="linenos">194</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">lmin</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="LiLit.set_lmin_lmax_fsky-195"><a href="#LiLit.set_lmin_lmax_fsky-195"><span class="linenos">195</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple lmin, they must match the number of requested fields with the same order&quot;</span>
</span><span id="LiLit.set_lmin_lmax_fsky-196"><a href="#LiLit.set_lmin_lmax_fsky-196"><span class="linenos">196</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-197"><a href="#LiLit.set_lmin_lmax_fsky-197"><span class="linenos">197</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-198"><a href="#LiLit.set_lmin_lmax_fsky-198"><span class="linenos">198</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.set_lmin_lmax_fsky-199"><a href="#LiLit.set_lmin_lmax_fsky-199"><span class="linenos">199</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="LiLit.set_lmin_lmax_fsky-200"><a href="#LiLit.set_lmin_lmax_fsky-200"><span class="linenos">200</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmin</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span id="LiLit.set_lmin_lmax_fsky-201"><a href="#LiLit.set_lmin_lmax_fsky-201"><span class="linenos">201</span></a>                    <span class="p">)</span>  <span class="c1"># this approximaiton allows to gain some extra multipoles in the cross-correalation for which the SNR is still good.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-202"><a href="#LiLit.set_lmin_lmax_fsky-202"><span class="linenos">202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmin</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="LiLit.set_lmin_lmax_fsky-203"><a href="#LiLit.set_lmin_lmax_fsky-203"><span class="linenos">203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="LiLit.set_lmin_lmax_fsky-204"><a href="#LiLit.set_lmin_lmax_fsky-204"><span class="linenos">204</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.set_lmin_lmax_fsky-205"><a href="#LiLit.set_lmin_lmax_fsky-205"><span class="linenos">205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="o">=</span> <span class="n">lmin</span>
</span><span id="LiLit.set_lmin_lmax_fsky-206"><a href="#LiLit.set_lmin_lmax_fsky-206"><span class="linenos">206</span></a>
</span><span id="LiLit.set_lmin_lmax_fsky-207"><a href="#LiLit.set_lmin_lmax_fsky-207"><span class="linenos">207</span></a>        <span class="c1"># Set lmax</span>
</span><span id="LiLit.set_lmin_lmax_fsky-208"><a href="#LiLit.set_lmin_lmax_fsky-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lmax</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-209"><a href="#LiLit.set_lmin_lmax_fsky-209"><span class="linenos">209</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.set_lmin_lmax_fsky-210"><a href="#LiLit.set_lmin_lmax_fsky-210"><span class="linenos">210</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="LiLit.set_lmin_lmax_fsky-211"><a href="#LiLit.set_lmin_lmax_fsky-211"><span class="linenos">211</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple lmax, they must match the number of requested fields with the same order&quot;</span>
</span><span id="LiLit.set_lmin_lmax_fsky-212"><a href="#LiLit.set_lmin_lmax_fsky-212"><span class="linenos">212</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-213"><a href="#LiLit.set_lmin_lmax_fsky-213"><span class="linenos">213</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-214"><a href="#LiLit.set_lmin_lmax_fsky-214"><span class="linenos">214</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.set_lmin_lmax_fsky-215"><a href="#LiLit.set_lmin_lmax_fsky-215"><span class="linenos">215</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="LiLit.set_lmin_lmax_fsky-216"><a href="#LiLit.set_lmin_lmax_fsky-216"><span class="linenos">216</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
</span><span id="LiLit.set_lmin_lmax_fsky-217"><a href="#LiLit.set_lmin_lmax_fsky-217"><span class="linenos">217</span></a>                    <span class="p">)</span>  <span class="c1"># this approximaiton allows to gain some extra multipoles in the cross-correalation for which the SNR is still good.</span>
</span><span id="LiLit.set_lmin_lmax_fsky-218"><a href="#LiLit.set_lmin_lmax_fsky-218"><span class="linenos">218</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
</span><span id="LiLit.set_lmin_lmax_fsky-219"><a href="#LiLit.set_lmin_lmax_fsky-219"><span class="linenos">219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="LiLit.set_lmin_lmax_fsky-220"><a href="#LiLit.set_lmin_lmax_fsky-220"><span class="linenos">220</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.set_lmin_lmax_fsky-221"><a href="#LiLit.set_lmin_lmax_fsky-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">=</span> <span class="n">lmax</span>
</span><span id="LiLit.set_lmin_lmax_fsky-222"><a href="#LiLit.set_lmin_lmax_fsky-222"><span class="linenos">222</span></a>
</span><span id="LiLit.set_lmin_lmax_fsky-223"><a href="#LiLit.set_lmin_lmax_fsky-223"><span class="linenos">223</span></a>        <span class="c1"># Set fsky</span>
</span><span id="LiLit.set_lmin_lmax_fsky-224"><a href="#LiLit.set_lmin_lmax_fsky-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fsky</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-225"><a href="#LiLit.set_lmin_lmax_fsky-225"><span class="linenos">225</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.set_lmin_lmax_fsky-226"><a href="#LiLit.set_lmin_lmax_fsky-226"><span class="linenos">226</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">fsky</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span><span id="LiLit.set_lmin_lmax_fsky-227"><a href="#LiLit.set_lmin_lmax_fsky-227"><span class="linenos">227</span></a>            <span class="p">),</span> <span class="s2">&quot;If you provide multiple fsky, they must match the number of requested fields with the same order&quot;</span>
</span><span id="LiLit.set_lmin_lmax_fsky-228"><a href="#LiLit.set_lmin_lmax_fsky-228"><span class="linenos">228</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-229"><a href="#LiLit.set_lmin_lmax_fsky-229"><span class="linenos">229</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.set_lmin_lmax_fsky-230"><a href="#LiLit.set_lmin_lmax_fsky-230"><span class="linenos">230</span></a>                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.set_lmin_lmax_fsky-231"><a href="#LiLit.set_lmin_lmax_fsky-231"><span class="linenos">231</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="LiLit.set_lmin_lmax_fsky-232"><a href="#LiLit.set_lmin_lmax_fsky-232"><span class="linenos">232</span></a>                        <span class="n">fsky</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsky</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.set_lmin_lmax_fsky-233"><a href="#LiLit.set_lmin_lmax_fsky-233"><span class="linenos">233</span></a>                    <span class="p">)</span>  <span class="c1"># this approximation for the cross-correlation is not correct in the case of two very different masks (verified with simulations)</span>
</span><span id="LiLit.set_lmin_lmax_fsky-234"><a href="#LiLit.set_lmin_lmax_fsky-234"><span class="linenos">234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fsky</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsky</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="LiLit.set_lmin_lmax_fsky-235"><a href="#LiLit.set_lmin_lmax_fsky-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LiLit.set_lmin_lmax_fsky-236"><a href="#LiLit.set_lmin_lmax_fsky-236"><span class="linenos">236</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.set_lmin_lmax_fsky-237"><a href="#LiLit.set_lmin_lmax_fsky-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="o">=</span> <span class="n">fsky</span>
</span><span id="LiLit.set_lmin_lmax_fsky-238"><a href="#LiLit.set_lmin_lmax_fsky-238"><span class="linenos">238</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Take lmin, lmax and fsky parameters and set the corresponding attributes.</p>

<p>Sets the minimum multipole, the maximum multipole and the sky fraction. This handles automatically the case of a single value or a list of values. Note that the lmin, lmax and fsky for the cross-correlations are set to the geometrical mean of the lmin, lmax and fsky of the two fields. This approximation has been tested and found to be accurate, at least assuming that the two masks of the two considered multipoles are very overlapped.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>lmin (int or list):</strong>  Value or list of values of lmin.</li>
<li><strong>lmax (int or list):</strong>  Value or list of values of lmax.</li>
<li><strong>fsky (float or list):</strong>  Value or list of values of fsky.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.cov_filling" class="classattr">
                                        <input id="LiLit.cov_filling-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cov_filling</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cov_dict</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.cov_filling-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.cov_filling"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.cov_filling-240"><a href="#LiLit.cov_filling-240"><span class="linenos">240</span></a>    <span class="k">def</span> <span class="nf">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_dict</span><span class="p">):</span>
</span><span id="LiLit.cov_filling-241"><a href="#LiLit.cov_filling-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill covariance matrix with appropriate spectra.</span>
</span><span id="LiLit.cov_filling-242"><a href="#LiLit.cov_filling-242"><span class="linenos">242</span></a>
</span><span id="LiLit.cov_filling-243"><a href="#LiLit.cov_filling-243"><span class="linenos">243</span></a><span class="sd">        Computes the covariance matrix once given a dictionary. Returns the covariance matrix of the considered fields, in a shape equal to (num_fields x num_fields x lmax). Note that if more than one lmax, or lmin, is specified, there will be null values in the matrices, making them singular. This will be handled in another method.</span>
</span><span id="LiLit.cov_filling-244"><a href="#LiLit.cov_filling-244"><span class="linenos">244</span></a>
</span><span id="LiLit.cov_filling-245"><a href="#LiLit.cov_filling-245"><span class="linenos">245</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.cov_filling-246"><a href="#LiLit.cov_filling-246"><span class="linenos">246</span></a><span class="sd">            cov_dict (dict):</span>
</span><span id="LiLit.cov_filling-247"><a href="#LiLit.cov_filling-247"><span class="linenos">247</span></a><span class="sd">                The input dictionary of spectra.</span>
</span><span id="LiLit.cov_filling-248"><a href="#LiLit.cov_filling-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.cov_filling-249"><a href="#LiLit.cov_filling-249"><span class="linenos">249</span></a>        <span class="c1"># Initialize output array</span>
</span><span id="LiLit.cov_filling-250"><a href="#LiLit.cov_filling-250"><span class="linenos">250</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit.cov_filling-251"><a href="#LiLit.cov_filling-251"><span class="linenos">251</span></a>
</span><span id="LiLit.cov_filling-252"><a href="#LiLit.cov_filling-252"><span class="linenos">252</span></a>        <span class="c1"># Loop over field1</span>
</span><span id="LiLit.cov_filling-253"><a href="#LiLit.cov_filling-253"><span class="linenos">253</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
</span><span id="LiLit.cov_filling-254"><a href="#LiLit.cov_filling-254"><span class="linenos">254</span></a>            <span class="c1"># Loop over field2</span>
</span><span id="LiLit.cov_filling-255"><a href="#LiLit.cov_filling-255"><span class="linenos">255</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">field2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">:]):</span>
</span><span id="LiLit.cov_filling-256"><a href="#LiLit.cov_filling-256"><span class="linenos">256</span></a>                <span class="c1"># Get the index of field2</span>
</span><span id="LiLit.cov_filling-257"><a href="#LiLit.cov_filling-257"><span class="linenos">257</span></a>                <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span>
</span><span id="LiLit.cov_filling-258"><a href="#LiLit.cov_filling-258"><span class="linenos">258</span></a>
</span><span id="LiLit.cov_filling-259"><a href="#LiLit.cov_filling-259"><span class="linenos">259</span></a>                <span class="c1"># Get the key of the covariance matrix</span>
</span><span id="LiLit.cov_filling-260"><a href="#LiLit.cov_filling-260"><span class="linenos">260</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">field1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">field2</span>
</span><span id="LiLit.cov_filling-261"><a href="#LiLit.cov_filling-261"><span class="linenos">261</span></a>
</span><span id="LiLit.cov_filling-262"><a href="#LiLit.cov_filling-262"><span class="linenos">262</span></a>                <span class="c1"># Get lmin and lmax for this field pair</span>
</span><span id="LiLit.cov_filling-263"><a href="#LiLit.cov_filling-263"><span class="linenos">263</span></a>                <span class="n">lmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="LiLit.cov_filling-264"><a href="#LiLit.cov_filling-264"><span class="linenos">264</span></a>                <span class="n">lmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="LiLit.cov_filling-265"><a href="#LiLit.cov_filling-265"><span class="linenos">265</span></a>
</span><span id="LiLit.cov_filling-266"><a href="#LiLit.cov_filling-266"><span class="linenos">266</span></a>                <span class="c1"># Get the covariance for this field pair</span>
</span><span id="LiLit.cov_filling-267"><a href="#LiLit.cov_filling-267"><span class="linenos">267</span></a>                <span class="n">cov</span> <span class="o">=</span> <span class="n">cov_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit.cov_filling-268"><a href="#LiLit.cov_filling-268"><span class="linenos">268</span></a>
</span><span id="LiLit.cov_filling-269"><a href="#LiLit.cov_filling-269"><span class="linenos">269</span></a>                <span class="c1"># Set the appropriate values in the covariance matrix</span>
</span><span id="LiLit.cov_filling-270"><a href="#LiLit.cov_filling-270"><span class="linenos">270</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.cov_filling-271"><a href="#LiLit.cov_filling-271"><span class="linenos">271</span></a>                <span class="c1"># Fill the covariance matrix symmetrically</span>
</span><span id="LiLit.cov_filling-272"><a href="#LiLit.cov_filling-272"><span class="linenos">272</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.cov_filling-273"><a href="#LiLit.cov_filling-273"><span class="linenos">273</span></a>
</span><span id="LiLit.cov_filling-274"><a href="#LiLit.cov_filling-274"><span class="linenos">274</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Fill covariance matrix with appropriate spectra.</p>

<p>Computes the covariance matrix once given a dictionary. Returns the covariance matrix of the considered fields, in a shape equal to (num_fields x num_fields x lmax). Note that if more than one lmax, or lmin, is specified, there will be null values in the matrices, making them singular. This will be handled in another method.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>cov_dict (dict):</strong>  The input dictionary of spectra.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.get_keys" class="classattr">
                                        <input id="LiLit.get_keys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_keys</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.get_keys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.get_keys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.get_keys-276"><a href="#LiLit.get_keys-276"><span class="linenos">276</span></a>    <span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.get_keys-277"><a href="#LiLit.get_keys-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts the keys that has to be used as a function of the requested fields. These will be the usual 2-points, e.g., tt, te, ee, etc.&quot;&quot;&quot;</span>
</span><span id="LiLit.get_keys-278"><a href="#LiLit.get_keys-278"><span class="linenos">278</span></a>        <span class="c1"># List of all the possible combinations of the requested fields</span>
</span><span id="LiLit.get_keys-279"><a href="#LiLit.get_keys-279"><span class="linenos">279</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LiLit.get_keys-280"><a href="#LiLit.get_keys-280"><span class="linenos">280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.get_keys-281"><a href="#LiLit.get_keys-281"><span class="linenos">281</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span><span id="LiLit.get_keys-282"><a href="#LiLit.get_keys-282"><span class="linenos">282</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span><span id="LiLit.get_keys-283"><a href="#LiLit.get_keys-283"><span class="linenos">283</span></a>        <span class="p">]</span>
</span><span id="LiLit.get_keys-284"><a href="#LiLit.get_keys-284"><span class="linenos">284</span></a>        <span class="c1"># Print the requested keys</span>
</span><span id="LiLit.get_keys-285"><a href="#LiLit.get_keys-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.get_keys-286"><a href="#LiLit.get_keys-286"><span class="linenos">286</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The requested keys are </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.get_keys-287"><a href="#LiLit.get_keys-287"><span class="linenos">287</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Extracts the keys that has to be used as a function of the requested fields. These will be the usual 2-points, e.g., tt, te, ee, etc.</p>
</div>


                            </div>
                            <div id="LiLit.get_Gauss_keys" class="classattr">
                                        <input id="LiLit.get_Gauss_keys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_Gauss_keys</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.get_Gauss_keys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.get_Gauss_keys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.get_Gauss_keys-289"><a href="#LiLit.get_Gauss_keys-289"><span class="linenos">289</span></a>    <span class="k">def</span> <span class="nf">get_Gauss_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.get_Gauss_keys-290"><a href="#LiLit.get_Gauss_keys-290"><span class="linenos">290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the proper dictionary keys for the requested fields.</span>
</span><span id="LiLit.get_Gauss_keys-291"><a href="#LiLit.get_Gauss_keys-291"><span class="linenos">291</span></a>
</span><span id="LiLit.get_Gauss_keys-292"><a href="#LiLit.get_Gauss_keys-292"><span class="linenos">292</span></a><span class="sd">        Extracts the keys that has to be used as a function of the requested fields for the Gaussian likelihood. Indeed, the Gaussian likelihood is computed using 4-points, so the keys are different. E.g., there will be keys such as tttt, ttee, tete, etc.</span>
</span><span id="LiLit.get_Gauss_keys-293"><a href="#LiLit.get_Gauss_keys-293"><span class="linenos">293</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.get_Gauss_keys-294"><a href="#LiLit.get_Gauss_keys-294"><span class="linenos">294</span></a>        <span class="c1"># Calculate the number of elements in the covariance matrix</span>
</span><span id="LiLit.get_Gauss_keys-295"><a href="#LiLit.get_Gauss_keys-295"><span class="linenos">295</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit.get_Gauss_keys-296"><a href="#LiLit.get_Gauss_keys-296"><span class="linenos">296</span></a>        <span class="c1"># Initialize a 3-d array to store the keys</span>
</span><span id="LiLit.get_Gauss_keys-297"><a href="#LiLit.get_Gauss_keys-297"><span class="linenos">297</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="LiLit.get_Gauss_keys-298"><a href="#LiLit.get_Gauss_keys-298"><span class="linenos">298</span></a>        <span class="c1"># Loop over all the elements in the covariance matrix</span>
</span><span id="LiLit.get_Gauss_keys-299"><a href="#LiLit.get_Gauss_keys-299"><span class="linenos">299</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.get_Gauss_keys-300"><a href="#LiLit.get_Gauss_keys-300"><span class="linenos">300</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.get_Gauss_keys-301"><a href="#LiLit.get_Gauss_keys-301"><span class="linenos">301</span></a>                <span class="c1"># Generate a key for the i-th and j-th element</span>
</span><span id="LiLit.get_Gauss_keys-302"><a href="#LiLit.get_Gauss_keys-302"><span class="linenos">302</span></a>                <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.get_Gauss_keys-303"><a href="#LiLit.get_Gauss_keys-303"><span class="linenos">303</span></a>                <span class="c1"># Loop over all the characters in the key</span>
</span><span id="LiLit.get_Gauss_keys-304"><a href="#LiLit.get_Gauss_keys-304"><span class="linenos">304</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span id="LiLit.get_Gauss_keys-305"><a href="#LiLit.get_Gauss_keys-305"><span class="linenos">305</span></a>                    <span class="c1"># Add the k-th character to the i-th, j-th, and k-th</span>
</span><span id="LiLit.get_Gauss_keys-306"><a href="#LiLit.get_Gauss_keys-306"><span class="linenos">306</span></a>                    <span class="c1"># indices of the array</span>
</span><span id="LiLit.get_Gauss_keys-307"><a href="#LiLit.get_Gauss_keys-307"><span class="linenos">307</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">elem</span><span class="p">)[</span><span class="n">k</span><span class="p">])</span>
</span><span id="LiLit.get_Gauss_keys-308"><a href="#LiLit.get_Gauss_keys-308"><span class="linenos">308</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span id="LiLit.get_Gauss_keys-309"><a href="#LiLit.get_Gauss_keys-309"><span class="linenos">309</span></a>        <span class="c1"># Print the keys if the debug flag is set</span>
</span><span id="LiLit.get_Gauss_keys-310"><a href="#LiLit.get_Gauss_keys-310"><span class="linenos">310</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.get_Gauss_keys-311"><a href="#LiLit.get_Gauss_keys-311"><span class="linenos">311</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The requested keys are </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.get_Gauss_keys-312"><a href="#LiLit.get_Gauss_keys-312"><span class="linenos">312</span></a>        <span class="c1"># Return the keys</span>
</span><span id="LiLit.get_Gauss_keys-313"><a href="#LiLit.get_Gauss_keys-313"><span class="linenos">313</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Find the proper dictionary keys for the requested fields.</p>

<p>Extracts the keys that has to be used as a function of the requested fields for the Gaussian likelihood. Indeed, the Gaussian likelihood is computed using 4-points, so the keys are different. E.g., there will be keys such as tttt, ttee, tete, etc.</p>
</div>


                            </div>
                            <div id="LiLit.find_spectrum" class="classattr">
                                        <input id="LiLit.find_spectrum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_spectrum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">input_dict</span>, </span><span class="param"><span class="n">key</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.find_spectrum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.find_spectrum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.find_spectrum-315"><a href="#LiLit.find_spectrum-315"><span class="linenos">315</span></a>    <span class="k">def</span> <span class="nf">find_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="LiLit.find_spectrum-316"><a href="#LiLit.find_spectrum-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a spectrum in a given dictionary.</span>
</span><span id="LiLit.find_spectrum-317"><a href="#LiLit.find_spectrum-317"><span class="linenos">317</span></a>
</span><span id="LiLit.find_spectrum-318"><a href="#LiLit.find_spectrum-318"><span class="linenos">318</span></a><span class="sd">        Returns the corresponding power sepctrum for a given key. If the key is not found, it will try to find the reverse key. Otherwise it will fill the array with zeros.</span>
</span><span id="LiLit.find_spectrum-319"><a href="#LiLit.find_spectrum-319"><span class="linenos">319</span></a>
</span><span id="LiLit.find_spectrum-320"><a href="#LiLit.find_spectrum-320"><span class="linenos">320</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.find_spectrum-321"><a href="#LiLit.find_spectrum-321"><span class="linenos">321</span></a><span class="sd">            input_dict (dict):</span>
</span><span id="LiLit.find_spectrum-322"><a href="#LiLit.find_spectrum-322"><span class="linenos">322</span></a><span class="sd">                Dictionary where you want to search for keys.</span>
</span><span id="LiLit.find_spectrum-323"><a href="#LiLit.find_spectrum-323"><span class="linenos">323</span></a>
</span><span id="LiLit.find_spectrum-324"><a href="#LiLit.find_spectrum-324"><span class="linenos">324</span></a><span class="sd">            key (str):</span>
</span><span id="LiLit.find_spectrum-325"><a href="#LiLit.find_spectrum-325"><span class="linenos">325</span></a><span class="sd">                Key to search for.</span>
</span><span id="LiLit.find_spectrum-326"><a href="#LiLit.find_spectrum-326"><span class="linenos">326</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.find_spectrum-327"><a href="#LiLit.find_spectrum-327"><span class="linenos">327</span></a>        <span class="c1"># create a zero array</span>
</span><span id="LiLit.find_spectrum-328"><a href="#LiLit.find_spectrum-328"><span class="linenos">328</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit.find_spectrum-329"><a href="#LiLit.find_spectrum-329"><span class="linenos">329</span></a>
</span><span id="LiLit.find_spectrum-330"><a href="#LiLit.find_spectrum-330"><span class="linenos">330</span></a>        <span class="c1"># get lmin and lmax</span>
</span><span id="LiLit.find_spectrum-331"><a href="#LiLit.find_spectrum-331"><span class="linenos">331</span></a>        <span class="n">lmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">)</span>
</span><span id="LiLit.find_spectrum-332"><a href="#LiLit.find_spectrum-332"><span class="linenos">332</span></a>        <span class="n">lmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmaxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
</span><span id="LiLit.find_spectrum-333"><a href="#LiLit.find_spectrum-333"><span class="linenos">333</span></a>
</span><span id="LiLit.find_spectrum-334"><a href="#LiLit.find_spectrum-334"><span class="linenos">334</span></a>        <span class="c1"># try to find the key in the dictionary</span>
</span><span id="LiLit.find_spectrum-335"><a href="#LiLit.find_spectrum-335"><span class="linenos">335</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
</span><span id="LiLit.find_spectrum-336"><a href="#LiLit.find_spectrum-336"><span class="linenos">336</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="LiLit.find_spectrum-337"><a href="#LiLit.find_spectrum-337"><span class="linenos">337</span></a>        <span class="c1"># if the key is not found, try the reverse key</span>
</span><span id="LiLit.find_spectrum-338"><a href="#LiLit.find_spectrum-338"><span class="linenos">338</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.find_spectrum-339"><a href="#LiLit.find_spectrum-339"><span class="linenos">339</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit.find_spectrum-340"><a href="#LiLit.find_spectrum-340"><span class="linenos">340</span></a>
</span><span id="LiLit.find_spectrum-341"><a href="#LiLit.find_spectrum-341"><span class="linenos">341</span></a>        <span class="c1"># fill the array with the requested spectrum</span>
</span><span id="LiLit.find_spectrum-342"><a href="#LiLit.find_spectrum-342"><span class="linenos">342</span></a>        <span class="n">res</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">lmin</span> <span class="p">:</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.find_spectrum-343"><a href="#LiLit.find_spectrum-343"><span class="linenos">343</span></a>
</span><span id="LiLit.find_spectrum-344"><a href="#LiLit.find_spectrum-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Find a spectrum in a given dictionary.</p>

<p>Returns the corresponding power sepctrum for a given key. If the key is not found, it will try to find the reverse key. Otherwise it will fill the array with zeros.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>input_dict (dict):</strong>  Dictionary where you want to search for keys.</li>
<li><strong>key (str):</strong>  Key to search for.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.sigma" class="classattr">
                                        <input id="LiLit.sigma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sigma</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">keys</span>, </span><span class="param"><span class="n">fiduDICT</span>, </span><span class="param"><span class="n">noiseDICT</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.sigma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.sigma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.sigma-346"><a href="#LiLit.sigma-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">fiduDICT</span><span class="p">,</span> <span class="n">noiseDICT</span><span class="p">):</span>
</span><span id="LiLit.sigma-347"><a href="#LiLit.sigma-347"><span class="linenos">347</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the covariance matrix for the Gaussian case.</span>
</span><span id="LiLit.sigma-348"><a href="#LiLit.sigma-348"><span class="linenos">348</span></a>
</span><span id="LiLit.sigma-349"><a href="#LiLit.sigma-349"><span class="linenos">349</span></a><span class="sd">        In case of Gaussian likelihood, this returns the covariance matrix needed for the computation of the chi2. Note that the inversion is done in a separate funciton.</span>
</span><span id="LiLit.sigma-350"><a href="#LiLit.sigma-350"><span class="linenos">350</span></a>
</span><span id="LiLit.sigma-351"><a href="#LiLit.sigma-351"><span class="linenos">351</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.sigma-352"><a href="#LiLit.sigma-352"><span class="linenos">352</span></a><span class="sd">            keys (dict):</span>
</span><span id="LiLit.sigma-353"><a href="#LiLit.sigma-353"><span class="linenos">353</span></a><span class="sd">                Keys for the covariance elements.</span>
</span><span id="LiLit.sigma-354"><a href="#LiLit.sigma-354"><span class="linenos">354</span></a>
</span><span id="LiLit.sigma-355"><a href="#LiLit.sigma-355"><span class="linenos">355</span></a><span class="sd">            fiduDICT (dict):</span>
</span><span id="LiLit.sigma-356"><a href="#LiLit.sigma-356"><span class="linenos">356</span></a><span class="sd">                Dictionary with the fiducial spectra.</span>
</span><span id="LiLit.sigma-357"><a href="#LiLit.sigma-357"><span class="linenos">357</span></a>
</span><span id="LiLit.sigma-358"><a href="#LiLit.sigma-358"><span class="linenos">358</span></a><span class="sd">            noiseDICT (dict):</span>
</span><span id="LiLit.sigma-359"><a href="#LiLit.sigma-359"><span class="linenos">359</span></a><span class="sd">                Dictionary with the noise spectra.</span>
</span><span id="LiLit.sigma-360"><a href="#LiLit.sigma-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.sigma-361"><a href="#LiLit.sigma-361"><span class="linenos">361</span></a>        <span class="c1"># The covariance matrix has to be symmetric.</span>
</span><span id="LiLit.sigma-362"><a href="#LiLit.sigma-362"><span class="linenos">362</span></a>        <span class="c1"># The number of parameters in the likelihood is self.n.</span>
</span><span id="LiLit.sigma-363"><a href="#LiLit.sigma-363"><span class="linenos">363</span></a>        <span class="c1"># The covariance matrix is a (self.n x self.n x self.lmax+1) ndarray.</span>
</span><span id="LiLit.sigma-364"><a href="#LiLit.sigma-364"><span class="linenos">364</span></a>        <span class="c1"># We will store the covariance matrix in a (n x n x self.lmax+1) ndarray,</span>
</span><span id="LiLit.sigma-365"><a href="#LiLit.sigma-365"><span class="linenos">365</span></a>        <span class="c1"># where n = int(self.n * (self.n + 1) / 2).</span>
</span><span id="LiLit.sigma-366"><a href="#LiLit.sigma-366"><span class="linenos">366</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit.sigma-367"><a href="#LiLit.sigma-367"><span class="linenos">367</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LiLit.sigma-368"><a href="#LiLit.sigma-368"><span class="linenos">368</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># Loop over all combinations of pairs of spectra</span>
</span><span id="LiLit.sigma-369"><a href="#LiLit.sigma-369"><span class="linenos">369</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="LiLit.sigma-370"><a href="#LiLit.sigma-370"><span class="linenos">370</span></a>                <span class="n">C_AC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span>
</span><span id="LiLit.sigma-371"><a href="#LiLit.sigma-371"><span class="linenos">371</span></a>                    <span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit.sigma-372"><a href="#LiLit.sigma-372"><span class="linenos">372</span></a>                <span class="p">)</span>  <span class="c1"># Find the fiducial spectra for each pair</span>
</span><span id="LiLit.sigma-373"><a href="#LiLit.sigma-373"><span class="linenos">373</span></a>                <span class="n">C_BD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit.sigma-374"><a href="#LiLit.sigma-374"><span class="linenos">374</span></a>                <span class="n">C_AD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit.sigma-375"><a href="#LiLit.sigma-375"><span class="linenos">375</span></a>                <span class="n">C_BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">fiduDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="LiLit.sigma-376"><a href="#LiLit.sigma-376"><span class="linenos">376</span></a>                <span class="n">N_AC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span>
</span><span id="LiLit.sigma-377"><a href="#LiLit.sigma-377"><span class="linenos">377</span></a>                    <span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit.sigma-378"><a href="#LiLit.sigma-378"><span class="linenos">378</span></a>                <span class="p">)</span>  <span class="c1"># Find the noise spectra for each pair</span>
</span><span id="LiLit.sigma-379"><a href="#LiLit.sigma-379"><span class="linenos">379</span></a>                <span class="n">N_BD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit.sigma-380"><a href="#LiLit.sigma-380"><span class="linenos">380</span></a>                <span class="n">N_AD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="LiLit.sigma-381"><a href="#LiLit.sigma-381"><span class="linenos">381</span></a>                <span class="n">N_BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spectrum</span><span class="p">(</span><span class="n">noiseDICT</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="LiLit.sigma-382"><a href="#LiLit.sigma-382"><span class="linenos">382</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If self.fsky is defined, use the fsky value</span>
</span><span id="LiLit.sigma-383"><a href="#LiLit.sigma-383"><span class="linenos">383</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit.sigma-384"><a href="#LiLit.sigma-384"><span class="linenos">384</span></a>                        <span class="p">(</span><span class="n">C_AC</span> <span class="o">+</span> <span class="n">N_AC</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_BD</span> <span class="o">+</span> <span class="n">N_BD</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">C_AD</span> <span class="o">+</span> <span class="n">N_AD</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_BC</span> <span class="o">+</span> <span class="n">N_BC</span><span class="p">)</span>
</span><span id="LiLit.sigma-385"><a href="#LiLit.sigma-385"><span class="linenos">385</span></a>                    <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsky</span>
</span><span id="LiLit.sigma-386"><a href="#LiLit.sigma-386"><span class="linenos">386</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, use the fsky values from the input spectra</span>
</span><span id="LiLit.sigma-387"><a href="#LiLit.sigma-387"><span class="linenos">387</span></a>                    <span class="n">AC</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit.sigma-388"><a href="#LiLit.sigma-388"><span class="linenos">388</span></a>                    <span class="n">BD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="LiLit.sigma-389"><a href="#LiLit.sigma-389"><span class="linenos">389</span></a>                    <span class="n">AD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="LiLit.sigma-390"><a href="#LiLit.sigma-390"><span class="linenos">390</span></a>                    <span class="n">BC</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="LiLit.sigma-391"><a href="#LiLit.sigma-391"><span class="linenos">391</span></a>                    <span class="n">AB</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.sigma-392"><a href="#LiLit.sigma-392"><span class="linenos">392</span></a>                    <span class="n">CD</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="LiLit.sigma-393"><a href="#LiLit.sigma-393"><span class="linenos">393</span></a>                    <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit.sigma-394"><a href="#LiLit.sigma-394"><span class="linenos">394</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AC</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">BD</span><span class="p">])</span>
</span><span id="LiLit.sigma-395"><a href="#LiLit.sigma-395"><span class="linenos">395</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_AC</span> <span class="o">+</span> <span class="n">N_AC</span><span class="p">)</span>
</span><span id="LiLit.sigma-396"><a href="#LiLit.sigma-396"><span class="linenos">396</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_BD</span> <span class="o">+</span> <span class="n">N_BD</span><span class="p">)</span>
</span><span id="LiLit.sigma-397"><a href="#LiLit.sigma-397"><span class="linenos">397</span></a>                        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AD</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">BC</span><span class="p">])</span>
</span><span id="LiLit.sigma-398"><a href="#LiLit.sigma-398"><span class="linenos">398</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_AD</span> <span class="o">+</span> <span class="n">N_AD</span><span class="p">)</span>
</span><span id="LiLit.sigma-399"><a href="#LiLit.sigma-399"><span class="linenos">399</span></a>                        <span class="o">*</span> <span class="p">(</span><span class="n">C_BC</span> <span class="o">+</span> <span class="n">N_BC</span><span class="p">)</span>
</span><span id="LiLit.sigma-400"><a href="#LiLit.sigma-400"><span class="linenos">400</span></a>                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">AB</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fskies</span><span class="p">[</span><span class="n">CD</span><span class="p">])</span>
</span><span id="LiLit.sigma-401"><a href="#LiLit.sigma-401"><span class="linenos">401</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="LiLit.sigma-402"><a href="#LiLit.sigma-402"><span class="linenos">402</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Define the covariance matrix for the Gaussian case.</p>

<p>In case of Gaussian likelihood, this returns the covariance matrix needed for the computation of the chi2. Note that the inversion is done in a separate funciton.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>keys (dict):</strong>  Keys for the covariance elements.</li>
<li><strong>fiduDICT (dict):</strong>  Dictionary with the fiducial spectra.</li>
<li><strong>noiseDICT (dict):</strong>  Dictionary with the noise spectra.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.inv_sigma" class="classattr">
                                        <input id="LiLit.inv_sigma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">inv_sigma</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sigma</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.inv_sigma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.inv_sigma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.inv_sigma-404"><a href="#LiLit.inv_sigma-404"><span class="linenos">404</span></a>    <span class="k">def</span> <span class="nf">inv_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="LiLit.inv_sigma-405"><a href="#LiLit.inv_sigma-405"><span class="linenos">405</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the covariance matrix of the Gaussian case.</span>
</span><span id="LiLit.inv_sigma-406"><a href="#LiLit.inv_sigma-406"><span class="linenos">406</span></a>
</span><span id="LiLit.inv_sigma-407"><a href="#LiLit.inv_sigma-407"><span class="linenos">407</span></a><span class="sd">        Inverts the previously calculated sigma ndarray. Note that some elements may be null, thus the covariance may be singular. If so, this also reduces the dimension of the matrix by deleting the corresponding row and column.</span>
</span><span id="LiLit.inv_sigma-408"><a href="#LiLit.inv_sigma-408"><span class="linenos">408</span></a>
</span><span id="LiLit.inv_sigma-409"><a href="#LiLit.inv_sigma-409"><span class="linenos">409</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.inv_sigma-410"><a href="#LiLit.inv_sigma-410"><span class="linenos">410</span></a><span class="sd">            ndarray (np.ndarray):</span>
</span><span id="LiLit.inv_sigma-411"><a href="#LiLit.inv_sigma-411"><span class="linenos">411</span></a><span class="sd">                (self.n x self.n x self.lmax+1) ndarray with the previously computed sigma (not inverted).</span>
</span><span id="LiLit.inv_sigma-412"><a href="#LiLit.inv_sigma-412"><span class="linenos">412</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.inv_sigma-413"><a href="#LiLit.inv_sigma-413"><span class="linenos">413</span></a>        <span class="c1"># Initialize array to store the inverted covariance matrices</span>
</span><span id="LiLit.inv_sigma-414"><a href="#LiLit.inv_sigma-414"><span class="linenos">414</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="LiLit.inv_sigma-415"><a href="#LiLit.inv_sigma-415"><span class="linenos">415</span></a>
</span><span id="LiLit.inv_sigma-416"><a href="#LiLit.inv_sigma-416"><span class="linenos">416</span></a>        <span class="c1"># Loop over multipoles</span>
</span><span id="LiLit.inv_sigma-417"><a href="#LiLit.inv_sigma-417"><span class="linenos">417</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="LiLit.inv_sigma-418"><a href="#LiLit.inv_sigma-418"><span class="linenos">418</span></a>            <span class="c1"># Check if matrix is singular</span>
</span><span id="LiLit.inv_sigma-419"><a href="#LiLit.inv_sigma-419"><span class="linenos">419</span></a>            <span class="n">COV</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit.inv_sigma-420"><a href="#LiLit.inv_sigma-420"><span class="linenos">420</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LiLit.inv_sigma-421"><a href="#LiLit.inv_sigma-421"><span class="linenos">421</span></a>                <span class="c1"># Get indices of null diagonal elements</span>
</span><span id="LiLit.inv_sigma-422"><a href="#LiLit.inv_sigma-422"><span class="linenos">422</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.inv_sigma-423"><a href="#LiLit.inv_sigma-423"><span class="linenos">423</span></a>                <span class="c1"># Remove corresponding rows and columns</span>
</span><span id="LiLit.inv_sigma-424"><a href="#LiLit.inv_sigma-424"><span class="linenos">424</span></a>                <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LiLit.inv_sigma-425"><a href="#LiLit.inv_sigma-425"><span class="linenos">425</span></a>                <span class="n">COV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit.inv_sigma-426"><a href="#LiLit.inv_sigma-426"><span class="linenos">426</span></a>            <span class="c1"># Invert matrix</span>
</span><span id="LiLit.inv_sigma-427"><a href="#LiLit.inv_sigma-427"><span class="linenos">427</span></a>            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span>
</span><span id="LiLit.inv_sigma-428"><a href="#LiLit.inv_sigma-428"><span class="linenos">428</span></a>        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</span></pre></div>


            <div class="docstring"><p>Invert the covariance matrix of the Gaussian case.</p>

<p>Inverts the previously calculated sigma ndarray. Note that some elements may be null, thus the covariance may be singular. If so, this also reduces the dimension of the matrix by deleting the corresponding row and column.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>ndarray (np.ndarray):</strong>  (self.n x self.n x self.lmax+1) ndarray with the previously computed sigma (not inverted).</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.get_reduced_data" class="classattr">
                                        <input id="LiLit.get_reduced_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_reduced_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mat</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.get_reduced_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.get_reduced_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.get_reduced_data-430"><a href="#LiLit.get_reduced_data-430"><span class="linenos">430</span></a>    <span class="k">def</span> <span class="nf">get_reduced_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
</span><span id="LiLit.get_reduced_data-431"><a href="#LiLit.get_reduced_data-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the reduced data eliminating the singularity of the matrix.</span>
</span><span id="LiLit.get_reduced_data-432"><a href="#LiLit.get_reduced_data-432"><span class="linenos">432</span></a>
</span><span id="LiLit.get_reduced_data-433"><a href="#LiLit.get_reduced_data-433"><span class="linenos">433</span></a><span class="sd">        Cuts the row and column corresponding to a zero diagonal value. Indeed, in case of different lmax, or lmin, for the fields, you will have singular marices.</span>
</span><span id="LiLit.get_reduced_data-434"><a href="#LiLit.get_reduced_data-434"><span class="linenos">434</span></a>
</span><span id="LiLit.get_reduced_data-435"><a href="#LiLit.get_reduced_data-435"><span class="linenos">435</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.get_reduced_data-436"><a href="#LiLit.get_reduced_data-436"><span class="linenos">436</span></a><span class="sd">            ndarray (np.ndarray):</span>
</span><span id="LiLit.get_reduced_data-437"><a href="#LiLit.get_reduced_data-437"><span class="linenos">437</span></a><span class="sd">                A ndarray containing the covariance matrices, with some singular ones.</span>
</span><span id="LiLit.get_reduced_data-438"><a href="#LiLit.get_reduced_data-438"><span class="linenos">438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.get_reduced_data-439"><a href="#LiLit.get_reduced_data-439"><span class="linenos">439</span></a>        <span class="c1"># Select the indices corresponding to the zero diagonal</span>
</span><span id="LiLit.get_reduced_data-440"><a href="#LiLit.get_reduced_data-440"><span class="linenos">440</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.get_reduced_data-441"><a href="#LiLit.get_reduced_data-441"><span class="linenos">441</span></a>        <span class="c1"># Delete the rows and columns from the matrix</span>
</span><span id="LiLit.get_reduced_data-442"><a href="#LiLit.get_reduced_data-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find the reduced data eliminating the singularity of the matrix.</p>

<p>Cuts the row and column corresponding to a zero diagonal value. Indeed, in case of different lmax, or lmin, for the fields, you will have singular marices.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>ndarray (np.ndarray):</strong>  A ndarray containing the covariance matrices, with some singular ones.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.CAMBres2dict" class="classattr">
                                        <input id="LiLit.CAMBres2dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CAMBres2dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">camb_results</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.CAMBres2dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.CAMBres2dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.CAMBres2dict-444"><a href="#LiLit.CAMBres2dict-444"><span class="linenos">444</span></a>    <span class="k">def</span> <span class="nf">CAMBres2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camb_results</span><span class="p">):</span>
</span><span id="LiLit.CAMBres2dict-445"><a href="#LiLit.CAMBres2dict-445"><span class="linenos">445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes the CAMB result product from get_cmb_power_spectra and convert it to a dictionary with the proper keys.</span>
</span><span id="LiLit.CAMBres2dict-446"><a href="#LiLit.CAMBres2dict-446"><span class="linenos">446</span></a>
</span><span id="LiLit.CAMBres2dict-447"><a href="#LiLit.CAMBres2dict-447"><span class="linenos">447</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.CAMBres2dict-448"><a href="#LiLit.CAMBres2dict-448"><span class="linenos">448</span></a><span class="sd">            camb_results (CAMBdata):</span>
</span><span id="LiLit.CAMBres2dict-449"><a href="#LiLit.CAMBres2dict-449"><span class="linenos">449</span></a><span class="sd">                CAMB result product from the method get_cmb_power_spectra.</span>
</span><span id="LiLit.CAMBres2dict-450"><a href="#LiLit.CAMBres2dict-450"><span class="linenos">450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.CAMBres2dict-451"><a href="#LiLit.CAMBres2dict-451"><span class="linenos">451</span></a>        <span class="c1"># Get the number of multipoles</span>
</span><span id="LiLit.CAMBres2dict-452"><a href="#LiLit.CAMBres2dict-452"><span class="linenos">452</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">camb_results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="LiLit.CAMBres2dict-453"><a href="#LiLit.CAMBres2dict-453"><span class="linenos">453</span></a>        <span class="c1"># Mapping between the CAMB keys and the ones we want</span>
</span><span id="LiLit.CAMBres2dict-454"><a href="#LiLit.CAMBres2dict-454"><span class="linenos">454</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;te&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span id="LiLit.CAMBres2dict-455"><a href="#LiLit.CAMBres2dict-455"><span class="linenos">455</span></a>        <span class="c1"># Initialize the output dictionary</span>
</span><span id="LiLit.CAMBres2dict-456"><a href="#LiLit.CAMBres2dict-456"><span class="linenos">456</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ell&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>
</span><span id="LiLit.CAMBres2dict-457"><a href="#LiLit.CAMBres2dict-457"><span class="linenos">457</span></a>        <span class="c1"># Loop over the keys we want</span>
</span><span id="LiLit.CAMBres2dict-458"><a href="#LiLit.CAMBres2dict-458"><span class="linenos">458</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LiLit.CAMBres2dict-459"><a href="#LiLit.CAMBres2dict-459"><span class="linenos">459</span></a>            <span class="c1"># Save the results</span>
</span><span id="LiLit.CAMBres2dict-460"><a href="#LiLit.CAMBres2dict-460"><span class="linenos">460</span></a>            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">camb_results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit.CAMBres2dict-461"><a href="#LiLit.CAMBres2dict-461"><span class="linenos">461</span></a>        <span class="c1"># Check if we want the lensing potential</span>
</span><span id="LiLit.CAMBres2dict-462"><a href="#LiLit.CAMBres2dict-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="s2">&quot;pp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="LiLit.CAMBres2dict-463"><a href="#LiLit.CAMBres2dict-463"><span class="linenos">463</span></a>            <span class="c1"># Get the lensing potential</span>
</span><span id="LiLit.CAMBres2dict-464"><a href="#LiLit.CAMBres2dict-464"><span class="linenos">464</span></a>            <span class="n">cl_lens</span> <span class="o">=</span> <span class="n">camb_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lens_potential&quot;</span><span class="p">)</span>
</span><span id="LiLit.CAMBres2dict-465"><a href="#LiLit.CAMBres2dict-465"><span class="linenos">465</span></a>            <span class="c1"># Check if it exists</span>
</span><span id="LiLit.CAMBres2dict-466"><a href="#LiLit.CAMBres2dict-466"><span class="linenos">466</span></a>            <span class="k">if</span> <span class="n">cl_lens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit.CAMBres2dict-467"><a href="#LiLit.CAMBres2dict-467"><span class="linenos">467</span></a>                <span class="c1"># Save it</span>
</span><span id="LiLit.CAMBres2dict-468"><a href="#LiLit.CAMBres2dict-468"><span class="linenos">468</span></a>                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_lens</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LiLit.CAMBres2dict-469"><a href="#LiLit.CAMBres2dict-469"><span class="linenos">469</span></a>                <span class="c1"># Check if we want the cross terms</span>
</span><span id="LiLit.CAMBres2dict-470"><a href="#LiLit.CAMBres2dict-470"><span class="linenos">470</span></a>                <span class="k">if</span> <span class="s2">&quot;pt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="ow">and</span> <span class="s2">&quot;pe&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="LiLit.CAMBres2dict-471"><a href="#LiLit.CAMBres2dict-471"><span class="linenos">471</span></a>                    <span class="c1"># Loop over the cross terms</span>
</span><span id="LiLit.CAMBres2dict-472"><a href="#LiLit.CAMBres2dict-472"><span class="linenos">472</span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cross</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;pe&quot;</span><span class="p">]):</span>
</span><span id="LiLit.CAMBres2dict-473"><a href="#LiLit.CAMBres2dict-473"><span class="linenos">473</span></a>                        <span class="c1"># Save the result</span>
</span><span id="LiLit.CAMBres2dict-474"><a href="#LiLit.CAMBres2dict-474"><span class="linenos">474</span></a>                        <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_lens</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LiLit.CAMBres2dict-475"><a href="#LiLit.CAMBres2dict-475"><span class="linenos">475</span></a>                        <span class="c1"># Save the symmetric term</span>
</span><span id="LiLit.CAMBres2dict-476"><a href="#LiLit.CAMBres2dict-476"><span class="linenos">476</span></a>                        <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">cross</span><span class="p">]</span>
</span><span id="LiLit.CAMBres2dict-477"><a href="#LiLit.CAMBres2dict-477"><span class="linenos">477</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Takes the CAMB result product from get_cmb_power_spectra and convert it to a dictionary with the proper keys.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>camb_results (CAMBdata):</strong>  CAMB result product from the method get_cmb_power_spectra.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.txt2dict" class="classattr">
                                        <input id="LiLit.txt2dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">txt2dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">txt</span>, </span><span class="param"><span class="n">mapping</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.txt2dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.txt2dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.txt2dict-479"><a href="#LiLit.txt2dict-479"><span class="linenos">479</span></a>    <span class="k">def</span> <span class="nf">txt2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LiLit.txt2dict-480"><a href="#LiLit.txt2dict-480"><span class="linenos">480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes a txt file and convert it to a dictionary. This requires a way to map the columns to the keys. Also, it is possible to apply an ell factor to the Cls.</span>
</span><span id="LiLit.txt2dict-481"><a href="#LiLit.txt2dict-481"><span class="linenos">481</span></a>
</span><span id="LiLit.txt2dict-482"><a href="#LiLit.txt2dict-482"><span class="linenos">482</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.txt2dict-483"><a href="#LiLit.txt2dict-483"><span class="linenos">483</span></a><span class="sd">            txt (str):</span>
</span><span id="LiLit.txt2dict-484"><a href="#LiLit.txt2dict-484"><span class="linenos">484</span></a><span class="sd">                Path to txt file containing the spectra as columns.</span>
</span><span id="LiLit.txt2dict-485"><a href="#LiLit.txt2dict-485"><span class="linenos">485</span></a><span class="sd">            mapping (dict):</span>
</span><span id="LiLit.txt2dict-486"><a href="#LiLit.txt2dict-486"><span class="linenos">486</span></a><span class="sd">                Dictionary containing the mapping. Keywords will become the new keywords and values represent the index of the corresponding column.</span>
</span><span id="LiLit.txt2dict-487"><a href="#LiLit.txt2dict-487"><span class="linenos">487</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.txt2dict-488"><a href="#LiLit.txt2dict-488"><span class="linenos">488</span></a>        <span class="c1"># Define the ell values from the length of the txt file</span>
</span><span id="LiLit.txt2dict-489"><a href="#LiLit.txt2dict-489"><span class="linenos">489</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.txt2dict-490"><a href="#LiLit.txt2dict-490"><span class="linenos">490</span></a>            <span class="n">mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit.txt2dict-491"><a href="#LiLit.txt2dict-491"><span class="linenos">491</span></a>        <span class="p">),</span> <span class="s2">&quot;You must provide a way to map the columns of your txt to the keys of a dictionary&quot;</span>
</span><span id="LiLit.txt2dict-492"><a href="#LiLit.txt2dict-492"><span class="linenos">492</span></a>        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="LiLit.txt2dict-493"><a href="#LiLit.txt2dict-493"><span class="linenos">493</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ell&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>
</span><span id="LiLit.txt2dict-494"><a href="#LiLit.txt2dict-494"><span class="linenos">494</span></a>        <span class="c1"># Loop over the mapping and extract the corresponding column from the txt file</span>
</span><span id="LiLit.txt2dict-495"><a href="#LiLit.txt2dict-495"><span class="linenos">495</span></a>        <span class="c1"># and store it in the dictionary under the corresponding keyword</span>
</span><span id="LiLit.txt2dict-496"><a href="#LiLit.txt2dict-496"><span class="linenos">496</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LiLit.txt2dict-497"><a href="#LiLit.txt2dict-497"><span class="linenos">497</span></a>            <span class="k">if</span> <span class="n">apply_ellfactor</span><span class="p">:</span>
</span><span id="LiLit.txt2dict-498"><a href="#LiLit.txt2dict-498"><span class="linenos">498</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ls</span> <span class="o">*</span> <span class="p">(</span><span class="n">ls</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit.txt2dict-499"><a href="#LiLit.txt2dict-499"><span class="linenos">499</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.txt2dict-500"><a href="#LiLit.txt2dict-500"><span class="linenos">500</span></a>                <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit.txt2dict-501"><a href="#LiLit.txt2dict-501"><span class="linenos">501</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Takes a txt file and convert it to a dictionary. This requires a way to map the columns to the keys. Also, it is possible to apply an ell factor to the Cls.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>txt (str):</strong>  Path to txt file containing the spectra as columns.</li>
<li><strong>mapping (dict):</strong>  Dictionary containing the mapping. Keywords will become the new keywords and values represent the index of the corresponding column.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.prod_fidu" class="classattr">
                                        <input id="LiLit.prod_fidu-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prod_fidu</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.prod_fidu-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.prod_fidu"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.prod_fidu-503"><a href="#LiLit.prod_fidu-503"><span class="linenos">503</span></a>    <span class="k">def</span> <span class="nf">prod_fidu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.prod_fidu-504"><a href="#LiLit.prod_fidu-504"><span class="linenos">504</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce fiducial spectra or read the input ones.</span>
</span><span id="LiLit.prod_fidu-505"><a href="#LiLit.prod_fidu-505"><span class="linenos">505</span></a>
</span><span id="LiLit.prod_fidu-506"><a href="#LiLit.prod_fidu-506"><span class="linenos">506</span></a><span class="sd">        If the user has not provided a Cl file, this function will produce the fiducial power spectra starting from the CAMB inifile for Planck2018. The extra keywords defined will maximize the accordance between the fiducial Cls and the ones obtained from Cobaya. If B-modes are requested, the tensor-to-scalar ratio and the spectral tilt will be set to the requested values. Note that if you do not provide a tilt, this will follow the standard single-field consistency relation. If instead you provide a custom file, stores that.</span>
</span><span id="LiLit.prod_fidu-507"><a href="#LiLit.prod_fidu-507"><span class="linenos">507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.prod_fidu-508"><a href="#LiLit.prod_fidu-508"><span class="linenos">508</span></a>        <span class="c1"># If a custom file is provided, use that</span>
</span><span id="LiLit.prod_fidu-509"><a href="#LiLit.prod_fidu-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit.prod_fidu-510"><a href="#LiLit.prod_fidu-510"><span class="linenos">510</span></a>            <span class="c1"># If the file is a pickle file, load it</span>
</span><span id="LiLit.prod_fidu-511"><a href="#LiLit.prod_fidu-511"><span class="linenos">511</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">):</span>
</span><span id="LiLit.prod_fidu-512"><a href="#LiLit.prod_fidu-512"><span class="linenos">512</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
</span><span id="LiLit.prod_fidu-513"><a href="#LiLit.prod_fidu-513"><span class="linenos">513</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-514"><a href="#LiLit.prod_fidu-514"><span class="linenos">514</span></a>            <span class="c1"># Otherwise, load it as text file</span>
</span><span id="LiLit.prod_fidu-515"><a href="#LiLit.prod_fidu-515"><span class="linenos">515</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.prod_fidu-516"><a href="#LiLit.prod_fidu-516"><span class="linenos">516</span></a>                <span class="n">txt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_file</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-517"><a href="#LiLit.prod_fidu-517"><span class="linenos">517</span></a>                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;te&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span id="LiLit.prod_fidu-518"><a href="#LiLit.prod_fidu-518"><span class="linenos">518</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt2dict</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-519"><a href="#LiLit.prod_fidu-519"><span class="linenos">519</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit.prod_fidu-520"><a href="#LiLit.prod_fidu-520"><span class="linenos">520</span></a>
</span><span id="LiLit.prod_fidu-521"><a href="#LiLit.prod_fidu-521"><span class="linenos">521</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LiLit.prod_fidu-522"><a href="#LiLit.prod_fidu-522"><span class="linenos">522</span></a>            <span class="kn">import</span> <span class="nn">camb</span>
</span><span id="LiLit.prod_fidu-523"><a href="#LiLit.prod_fidu-523"><span class="linenos">523</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="LiLit.prod_fidu-524"><a href="#LiLit.prod_fidu-524"><span class="linenos">524</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAMB seems to be not installed. Check the requirements.&quot;</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-525"><a href="#LiLit.prod_fidu-525"><span class="linenos">525</span></a>
</span><span id="LiLit.prod_fidu-526"><a href="#LiLit.prod_fidu-526"><span class="linenos">526</span></a>        <span class="c1"># Read the ini file containing the parameters for CAMB</span>
</span><span id="LiLit.prod_fidu-527"><a href="#LiLit.prod_fidu-527"><span class="linenos">527</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="LiLit.prod_fidu-528"><a href="#LiLit.prod_fidu-528"><span class="linenos">528</span></a>        <span class="n">planck_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;planck_2018.ini&quot;</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-529"><a href="#LiLit.prod_fidu-529"><span class="linenos">529</span></a>        <span class="n">pars</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">read_ini</span><span class="p">(</span><span class="n">planck_path</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-530"><a href="#LiLit.prod_fidu-530"><span class="linenos">530</span></a>
</span><span id="LiLit.prod_fidu-531"><a href="#LiLit.prod_fidu-531"><span class="linenos">531</span></a>        <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>  <span class="c1"># If we want to include the tensor mode</span>
</span><span id="LiLit.prod_fidu-532"><a href="#LiLit.prod_fidu-532"><span class="linenos">532</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Producing fiducial spectra for r=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="si">}</span><span class="s2"> and nt=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-533"><a href="#LiLit.prod_fidu-533"><span class="linenos">533</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span>
</span><span id="LiLit.prod_fidu-534"><a href="#LiLit.prod_fidu-534"><span class="linenos">534</span></a>                <span class="n">As</span><span class="o">=</span><span class="mf">2.100549e-9</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-535"><a href="#LiLit.prod_fidu-535"><span class="linenos">535</span></a>                <span class="n">ns</span><span class="o">=</span><span class="mf">0.9660499</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-536"><a href="#LiLit.prod_fidu-536"><span class="linenos">536</span></a>                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-537"><a href="#LiLit.prod_fidu-537"><span class="linenos">537</span></a>                <span class="n">nt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-538"><a href="#LiLit.prod_fidu-538"><span class="linenos">538</span></a>                <span class="n">pivot_tensor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_t</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-539"><a href="#LiLit.prod_fidu-539"><span class="linenos">539</span></a>                <span class="n">pivot_scalar</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-540"><a href="#LiLit.prod_fidu-540"><span class="linenos">540</span></a>                <span class="n">parameterization</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-541"><a href="#LiLit.prod_fidu-541"><span class="linenos">541</span></a>            <span class="p">)</span>
</span><span id="LiLit.prod_fidu-542"><a href="#LiLit.prod_fidu-542"><span class="linenos">542</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">WantTensors</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LiLit.prod_fidu-543"><a href="#LiLit.prod_fidu-543"><span class="linenos">543</span></a>            <span class="n">pars</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">AccurateBB</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LiLit.prod_fidu-544"><a href="#LiLit.prod_fidu-544"><span class="linenos">544</span></a>        <span class="n">pars</span><span class="o">.</span><span class="n">DoLensing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LiLit.prod_fidu-545"><a href="#LiLit.prod_fidu-545"><span class="linenos">545</span></a>        <span class="c1"># _pars.Accuracy.AccuracyBoost = 2 # This helps getting an extra squeeze on the accordance of Cobaya and Fiducial spectra</span>
</span><span id="LiLit.prod_fidu-546"><a href="#LiLit.prod_fidu-546"><span class="linenos">546</span></a>
</span><span id="LiLit.prod_fidu-547"><a href="#LiLit.prod_fidu-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.prod_fidu-548"><a href="#LiLit.prod_fidu-548"><span class="linenos">548</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-549"><a href="#LiLit.prod_fidu-549"><span class="linenos">549</span></a>
</span><span id="LiLit.prod_fidu-550"><a href="#LiLit.prod_fidu-550"><span class="linenos">550</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="LiLit.prod_fidu-551"><a href="#LiLit.prod_fidu-551"><span class="linenos">551</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_cmb_power_spectra</span><span class="p">(</span>
</span><span id="LiLit.prod_fidu-552"><a href="#LiLit.prod_fidu-552"><span class="linenos">552</span></a>            <span class="n">CMB_unit</span><span class="o">=</span><span class="s2">&quot;muK&quot;</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-553"><a href="#LiLit.prod_fidu-553"><span class="linenos">553</span></a>            <span class="n">lmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-554"><a href="#LiLit.prod_fidu-554"><span class="linenos">554</span></a>            <span class="n">raw_cl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LiLit.prod_fidu-555"><a href="#LiLit.prod_fidu-555"><span class="linenos">555</span></a>        <span class="p">)</span>
</span><span id="LiLit.prod_fidu-556"><a href="#LiLit.prod_fidu-556"><span class="linenos">556</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CAMBres2dict</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Produce fiducial spectra or read the input ones.</p>

<p>If the user has not provided a Cl file, this function will produce the fiducial power spectra starting from the CAMB inifile for Planck2018. The extra keywords defined will maximize the accordance between the fiducial Cls and the ones obtained from Cobaya. If B-modes are requested, the tensor-to-scalar ratio and the spectral tilt will be set to the requested values. Note that if you do not provide a tilt, this will follow the standard single-field consistency relation. If instead you provide a custom file, stores that.</p>
</div>


                            </div>
                            <div id="LiLit.prod_noise" class="classattr">
                                        <input id="LiLit.prod_noise-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prod_noise</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.prod_noise-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.prod_noise"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.prod_noise-558"><a href="#LiLit.prod_noise-558"><span class="linenos">558</span></a>    <span class="k">def</span> <span class="nf">prod_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.prod_noise-559"><a href="#LiLit.prod_noise-559"><span class="linenos">559</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce noise power spectra or read the input ones.</span>
</span><span id="LiLit.prod_noise-560"><a href="#LiLit.prod_noise-560"><span class="linenos">560</span></a>
</span><span id="LiLit.prod_noise-561"><a href="#LiLit.prod_noise-561"><span class="linenos">561</span></a><span class="sd">        If the user has not provided a noise file, this function will produce the noise power spectra for a given experiment with inverse noise weighting of white noise in each channel (TT, EE, BB). Note that you may want to have a look at the procedure since it is merely a place-holder. Indeed, you should provide a more realistic file from which to read the noise spectra, given that inverse noise weighting severely underestimates the amount of noise. If instead you provide the proper custom file, this method stores that.</span>
</span><span id="LiLit.prod_noise-562"><a href="#LiLit.prod_noise-562"><span class="linenos">562</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.prod_noise-563"><a href="#LiLit.prod_noise-563"><span class="linenos">563</span></a>        <span class="c1"># If the input noise file is a pickle file, load it.</span>
</span><span id="LiLit.prod_noise-564"><a href="#LiLit.prod_noise-564"><span class="linenos">564</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LiLit.prod_noise-565"><a href="#LiLit.prod_noise-565"><span class="linenos">565</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">):</span>
</span><span id="LiLit.prod_noise-566"><a href="#LiLit.prod_noise-566"><span class="linenos">566</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
</span><span id="LiLit.prod_noise-567"><a href="#LiLit.prod_noise-567"><span class="linenos">567</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-568"><a href="#LiLit.prod_noise-568"><span class="linenos">568</span></a>            <span class="c1"># If not, load the file as a text file</span>
</span><span id="LiLit.prod_noise-569"><a href="#LiLit.prod_noise-569"><span class="linenos">569</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.prod_noise-570"><a href="#LiLit.prod_noise-570"><span class="linenos">570</span></a>                <span class="n">_txt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl_file</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-571"><a href="#LiLit.prod_noise-571"><span class="linenos">571</span></a>                <span class="c1"># Convert the text file to a dictionary</span>
</span><span id="LiLit.prod_noise-572"><a href="#LiLit.prod_noise-572"><span class="linenos">572</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">txt2dict</span><span class="p">(</span><span class="n">_txt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">apply_ellfactor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-573"><a href="#LiLit.prod_noise-573"><span class="linenos">573</span></a>            <span class="k">return</span> <span class="n">res</span>
</span><span id="LiLit.prod_noise-574"><a href="#LiLit.prod_noise-574"><span class="linenos">574</span></a>
</span><span id="LiLit.prod_noise-575"><a href="#LiLit.prod_noise-575"><span class="linenos">575</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="LiLit.prod_noise-576"><a href="#LiLit.prod_noise-576"><span class="linenos">576</span></a>            <span class="s2">&quot;***WARNING***: the inverse noise weighting performed here severely underestimates </span><span class="se">\</span>
</span><span id="LiLit.prod_noise-577"><a href="#LiLit.prod_noise-577"><span class="linenos">577</span></a><span class="s2">            the actual noise level of LiteBIRD. You should provide an input </span><span class="se">\</span>
</span><span id="LiLit.prod_noise-578"><a href="#LiLit.prod_noise-578"><span class="linenos">578</span></a><span class="s2">            noise power spectrum with a more realistic noise.&quot;</span>
</span><span id="LiLit.prod_noise-579"><a href="#LiLit.prod_noise-579"><span class="linenos">579</span></a>        <span class="p">)</span>
</span><span id="LiLit.prod_noise-580"><a href="#LiLit.prod_noise-580"><span class="linenos">580</span></a>
</span><span id="LiLit.prod_noise-581"><a href="#LiLit.prod_noise-581"><span class="linenos">581</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LiLit.prod_noise-582"><a href="#LiLit.prod_noise-582"><span class="linenos">582</span></a>            <span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="LiLit.prod_noise-583"><a href="#LiLit.prod_noise-583"><span class="linenos">583</span></a>            <span class="kn">from</span> <span class="nn">yaml.loader</span> <span class="kn">import</span> <span class="n">SafeLoader</span>
</span><span id="LiLit.prod_noise-584"><a href="#LiLit.prod_noise-584"><span class="linenos">584</span></a>            <span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
</span><span id="LiLit.prod_noise-585"><a href="#LiLit.prod_noise-585"><span class="linenos">585</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="LiLit.prod_noise-586"><a href="#LiLit.prod_noise-586"><span class="linenos">586</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YAML or Healpy seems to be not installed. Check the requirements.&quot;</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-587"><a href="#LiLit.prod_noise-587"><span class="linenos">587</span></a>
</span><span id="LiLit.prod_noise-588"><a href="#LiLit.prod_noise-588"><span class="linenos">588</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="LiLit.prod_noise-589"><a href="#LiLit.prod_noise-589"><span class="linenos">589</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="LiLit.prod_noise-590"><a href="#LiLit.prod_noise-590"><span class="linenos">590</span></a>        <span class="p">),</span> <span class="s2">&quot;You must specify the experiment you want to consider&quot;</span>
</span><span id="LiLit.prod_noise-591"><a href="#LiLit.prod_noise-591"><span class="linenos">591</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Computing noise for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-592"><a href="#LiLit.prod_noise-592"><span class="linenos">592</span></a>
</span><span id="LiLit.prod_noise-593"><a href="#LiLit.prod_noise-593"><span class="linenos">593</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="LiLit.prod_noise-594"><a href="#LiLit.prod_noise-594"><span class="linenos">594</span></a>        <span class="n">experiments_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;experiments.yaml&quot;</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-595"><a href="#LiLit.prod_noise-595"><span class="linenos">595</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">experiments_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="LiLit.prod_noise-596"><a href="#LiLit.prod_noise-596"><span class="linenos">596</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-597"><a href="#LiLit.prod_noise-597"><span class="linenos">597</span></a>
</span><span id="LiLit.prod_noise-598"><a href="#LiLit.prod_noise-598"><span class="linenos">598</span></a>        <span class="c1"># Get the instrument data from the saved data</span>
</span><span id="LiLit.prod_noise-599"><a href="#LiLit.prod_noise-599"><span class="linenos">599</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">]</span>
</span><span id="LiLit.prod_noise-600"><a href="#LiLit.prod_noise-600"><span class="linenos">600</span></a>
</span><span id="LiLit.prod_noise-601"><a href="#LiLit.prod_noise-601"><span class="linenos">601</span></a>        <span class="c1"># Get the FWHM values from the instrument data</span>
</span><span id="LiLit.prod_noise-602"><a href="#LiLit.prod_noise-602"><span class="linenos">602</span></a>        <span class="n">fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">])</span>
</span><span id="LiLit.prod_noise-603"><a href="#LiLit.prod_noise-603"><span class="linenos">603</span></a>
</span><span id="LiLit.prod_noise-604"><a href="#LiLit.prod_noise-604"><span class="linenos">604</span></a>        <span class="c1"># Get the frequency values from the instrument data</span>
</span><span id="LiLit.prod_noise-605"><a href="#LiLit.prod_noise-605"><span class="linenos">605</span></a>        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">])</span>
</span><span id="LiLit.prod_noise-606"><a href="#LiLit.prod_noise-606"><span class="linenos">606</span></a>
</span><span id="LiLit.prod_noise-607"><a href="#LiLit.prod_noise-607"><span class="linenos">607</span></a>        <span class="c1"># Get the depth values from the instrument data</span>
</span><span id="LiLit.prod_noise-608"><a href="#LiLit.prod_noise-608"><span class="linenos">608</span></a>        <span class="n">depth_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;depth_p&quot;</span><span class="p">])</span>
</span><span id="LiLit.prod_noise-609"><a href="#LiLit.prod_noise-609"><span class="linenos">609</span></a>        <span class="n">depth_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;depth_i&quot;</span><span class="p">])</span>
</span><span id="LiLit.prod_noise-610"><a href="#LiLit.prod_noise-610"><span class="linenos">610</span></a>
</span><span id="LiLit.prod_noise-611"><a href="#LiLit.prod_noise-611"><span class="linenos">611</span></a>        <span class="c1"># Convert the depth to a pixel value</span>
</span><span id="LiLit.prod_noise-612"><a href="#LiLit.prod_noise-612"><span class="linenos">612</span></a>        <span class="n">depth_p</span> <span class="o">/=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-613"><a href="#LiLit.prod_noise-613"><span class="linenos">613</span></a>        <span class="n">depth_i</span> <span class="o">/=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-614"><a href="#LiLit.prod_noise-614"><span class="linenos">614</span></a>        <span class="n">depth_p</span> <span class="o">=</span> <span class="n">depth_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="LiLit.prod_noise-615"><a href="#LiLit.prod_noise-615"><span class="linenos">615</span></a>            <span class="n">hp</span><span class="o">.</span><span class="n">pixelfunc</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="LiLit.prod_noise-616"><a href="#LiLit.prod_noise-616"><span class="linenos">616</span></a>        <span class="p">)</span>
</span><span id="LiLit.prod_noise-617"><a href="#LiLit.prod_noise-617"><span class="linenos">617</span></a>        <span class="n">depth_i</span> <span class="o">=</span> <span class="n">depth_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="LiLit.prod_noise-618"><a href="#LiLit.prod_noise-618"><span class="linenos">618</span></a>            <span class="n">hp</span><span class="o">.</span><span class="n">pixelfunc</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="LiLit.prod_noise-619"><a href="#LiLit.prod_noise-619"><span class="linenos">619</span></a>        <span class="p">)</span>
</span><span id="LiLit.prod_noise-620"><a href="#LiLit.prod_noise-620"><span class="linenos">620</span></a>
</span><span id="LiLit.prod_noise-621"><a href="#LiLit.prod_noise-621"><span class="linenos">621</span></a>        <span class="c1"># Get the number of frequencies</span>
</span><span id="LiLit.prod_noise-622"><a href="#LiLit.prod_noise-622"><span class="linenos">622</span></a>        <span class="n">n_freq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-623"><a href="#LiLit.prod_noise-623"><span class="linenos">623</span></a>
</span><span id="LiLit.prod_noise-624"><a href="#LiLit.prod_noise-624"><span class="linenos">624</span></a>        <span class="c1"># Define the ell values as a numpy array</span>
</span><span id="LiLit.prod_noise-625"><a href="#LiLit.prod_noise-625"><span class="linenos">625</span></a>        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-626"><a href="#LiLit.prod_noise-626"><span class="linenos">626</span></a>
</span><span id="LiLit.prod_noise-627"><a href="#LiLit.prod_noise-627"><span class="linenos">627</span></a>        <span class="c1"># Define the keys for the dictionary that will be returned</span>
</span><span id="LiLit.prod_noise-628"><a href="#LiLit.prod_noise-628"><span class="linenos">628</span></a>        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">,</span> <span class="s2">&quot;ee&quot;</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">]</span>
</span><span id="LiLit.prod_noise-629"><a href="#LiLit.prod_noise-629"><span class="linenos">629</span></a>
</span><span id="LiLit.prod_noise-630"><a href="#LiLit.prod_noise-630"><span class="linenos">630</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">fwhms</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</span><span id="LiLit.prod_noise-631"><a href="#LiLit.prod_noise-631"><span class="linenos">631</span></a>        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>
</span><span id="LiLit.prod_noise-632"><a href="#LiLit.prod_noise-632"><span class="linenos">632</span></a>
</span><span id="LiLit.prod_noise-633"><a href="#LiLit.prod_noise-633"><span class="linenos">633</span></a>        <span class="c1"># Calculate the Gaussian beam function</span>
</span><span id="LiLit.prod_noise-634"><a href="#LiLit.prod_noise-634"><span class="linenos">634</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="LiLit.prod_noise-635"><a href="#LiLit.prod_noise-635"><span class="linenos">635</span></a>
</span><span id="LiLit.prod_noise-636"><a href="#LiLit.prod_noise-636"><span class="linenos">636</span></a>        <span class="c1"># Calculate the polarization factor</span>
</span><span id="LiLit.prod_noise-637"><a href="#LiLit.prod_noise-637"><span class="linenos">637</span></a>        <span class="n">pol_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="LiLit.prod_noise-638"><a href="#LiLit.prod_noise-638"><span class="linenos">638</span></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sigma2</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">],</span>
</span><span id="LiLit.prod_noise-639"><a href="#LiLit.prod_noise-639"><span class="linenos">639</span></a>        <span class="p">)</span>
</span><span id="LiLit.prod_noise-640"><a href="#LiLit.prod_noise-640"><span class="linenos">640</span></a>
</span><span id="LiLit.prod_noise-641"><a href="#LiLit.prod_noise-641"><span class="linenos">641</span></a>        <span class="c1"># Calculate the polarization factor as a function of ell</span>
</span><span id="LiLit.prod_noise-642"><a href="#LiLit.prod_noise-642"><span class="linenos">642</span></a>        <span class="n">pol_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pol_factor</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-643"><a href="#LiLit.prod_noise-643"><span class="linenos">643</span></a>
</span><span id="LiLit.prod_noise-644"><a href="#LiLit.prod_noise-644"><span class="linenos">644</span></a>        <span class="c1"># Calculate the Gaussian beam function for each polarization</span>
</span><span id="LiLit.prod_noise-645"><a href="#LiLit.prod_noise-645"><span class="linenos">645</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LiLit.prod_noise-646"><a href="#LiLit.prod_noise-646"><span class="linenos">646</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pol_factor</span><span class="p">):</span>
</span><span id="LiLit.prod_noise-647"><a href="#LiLit.prod_noise-647"><span class="linenos">647</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="LiLit.prod_noise-648"><a href="#LiLit.prod_noise-648"><span class="linenos">648</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-649"><a href="#LiLit.prod_noise-649"><span class="linenos">649</span></a>
</span><span id="LiLit.prod_noise-650"><a href="#LiLit.prod_noise-650"><span class="linenos">650</span></a>        <span class="c1"># Initialize the dictionary that will be returned</span>
</span><span id="LiLit.prod_noise-651"><a href="#LiLit.prod_noise-651"><span class="linenos">651</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
</span><span id="LiLit.prod_noise-652"><a href="#LiLit.prod_noise-652"><span class="linenos">652</span></a>
</span><span id="LiLit.prod_noise-653"><a href="#LiLit.prod_noise-653"><span class="linenos">653</span></a>        <span class="c1"># Calculate the unnormalized power spectra</span>
</span><span id="LiLit.prod_noise-654"><a href="#LiLit.prod_noise-654"><span class="linenos">654</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_i</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-655"><a href="#LiLit.prod_noise-655"><span class="linenos">655</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-656"><a href="#LiLit.prod_noise-656"><span class="linenos">656</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">depth_p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="LiLit.prod_noise-657"><a href="#LiLit.prod_noise-657"><span class="linenos">657</span></a>
</span><span id="LiLit.prod_noise-658"><a href="#LiLit.prod_noise-658"><span class="linenos">658</span></a>        <span class="c1"># Calculate the normalized power spectra</span>
</span><span id="LiLit.prod_noise-659"><a href="#LiLit.prod_noise-659"><span class="linenos">659</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit.prod_noise-660"><a href="#LiLit.prod_noise-660"><span class="linenos">660</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit.prod_noise-661"><a href="#LiLit.prod_noise-661"><span class="linenos">661</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="LiLit.prod_noise-662"><a href="#LiLit.prod_noise-662"><span class="linenos">662</span></a>
</span><span id="LiLit.prod_noise-663"><a href="#LiLit.prod_noise-663"><span class="linenos">663</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;tt&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.prod_noise-664"><a href="#LiLit.prod_noise-664"><span class="linenos">664</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ee&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.prod_noise-665"><a href="#LiLit.prod_noise-665"><span class="linenos">665</span></a>        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;bb&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.prod_noise-666"><a href="#LiLit.prod_noise-666"><span class="linenos">666</span></a>
</span><span id="LiLit.prod_noise-667"><a href="#LiLit.prod_noise-667"><span class="linenos">667</span></a>        <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Produce noise power spectra or read the input ones.</p>

<p>If the user has not provided a noise file, this function will produce the noise power spectra for a given experiment with inverse noise weighting of white noise in each channel (TT, EE, BB). Note that you may want to have a look at the procedure since it is merely a place-holder. Indeed, you should provide a more realistic file from which to read the noise spectra, given that inverse noise weighting severely underestimates the amount of noise. If instead you provide the proper custom file, this method stores that.</p>
</div>


                            </div>
                            <div id="LiLit.initialize" class="classattr">
                                        <input id="LiLit.initialize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.initialize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.initialize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.initialize-669"><a href="#LiLit.initialize-669"><span class="linenos">669</span></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.initialize-670"><a href="#LiLit.initialize-670"><span class="linenos">670</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the fiducial spectra and the noise power spectra.&quot;&quot;&quot;</span>
</span><span id="LiLit.initialize-671"><a href="#LiLit.initialize-671"><span class="linenos">671</span></a>        <span class="c1"># Compute the fiducial and noise power spectra</span>
</span><span id="LiLit.initialize-672"><a href="#LiLit.initialize-672"><span class="linenos">672</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_fidu</span><span class="p">()</span>
</span><span id="LiLit.initialize-673"><a href="#LiLit.initialize-673"><span class="linenos">673</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_noise</span><span class="p">()</span>
</span><span id="LiLit.initialize-674"><a href="#LiLit.initialize-674"><span class="linenos">674</span></a>
</span><span id="LiLit.initialize-675"><a href="#LiLit.initialize-675"><span class="linenos">675</span></a>        <span class="c1"># Compute the covariance matrices</span>
</span><span id="LiLit.initialize-676"><a href="#LiLit.initialize-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">)</span>
</span><span id="LiLit.initialize-677"><a href="#LiLit.initialize-677"><span class="linenos">677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">)</span>
</span><span id="LiLit.initialize-678"><a href="#LiLit.initialize-678"><span class="linenos">678</span></a>
</span><span id="LiLit.initialize-679"><a href="#LiLit.initialize-679"><span class="linenos">679</span></a>        <span class="c1"># Print some information for debugging</span>
</span><span id="LiLit.initialize-680"><a href="#LiLit.initialize-680"><span class="linenos">680</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.initialize-681"><a href="#LiLit.initialize-681"><span class="linenos">681</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of fiducial CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.initialize-682"><a href="#LiLit.initialize-682"><span class="linenos">682</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of noise CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.initialize-683"><a href="#LiLit.initialize-683"><span class="linenos">683</span></a>
</span><span id="LiLit.initialize-684"><a href="#LiLit.initialize-684"><span class="linenos">684</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing the first few values to check that it starts from 0...&quot;</span><span class="p">)</span>
</span><span id="LiLit.initialize-685"><a href="#LiLit.initialize-685"><span class="linenos">685</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.initialize-686"><a href="#LiLit.initialize-686"><span class="linenos">686</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fiducial CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.initialize-687"><a href="#LiLit.initialize-687"><span class="linenos">687</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.initialize-688"><a href="#LiLit.initialize-688"><span class="linenos">688</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.initialize-689"><a href="#LiLit.initialize-689"><span class="linenos">689</span></a>
</span><span id="LiLit.initialize-690"><a href="#LiLit.initialize-690"><span class="linenos">690</span></a>        <span class="c1"># Compute the total covariance matrix</span>
</span><span id="LiLit.initialize-691"><a href="#LiLit.initialize-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit.initialize-692"><a href="#LiLit.initialize-692"><span class="linenos">692</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.initialize-693"><a href="#LiLit.initialize-693"><span class="linenos">693</span></a>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.initialize-694"><a href="#LiLit.initialize-694"><span class="linenos">694</span></a>        <span class="p">)</span>
</span><span id="LiLit.initialize-695"><a href="#LiLit.initialize-695"><span class="linenos">695</span></a>
</span><span id="LiLit.initialize-696"><a href="#LiLit.initialize-696"><span class="linenos">696</span></a>        <span class="c1"># Compute the inverse of the covariance matrix</span>
</span><span id="LiLit.initialize-697"><a href="#LiLit.initialize-697"><span class="linenos">697</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
</span><span id="LiLit.initialize-698"><a href="#LiLit.initialize-698"><span class="linenos">698</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Gauss_keys</span><span class="p">()</span>
</span><span id="LiLit.initialize-699"><a href="#LiLit.initialize-699"><span class="linenos">699</span></a>            <span class="n">sigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiduCLS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCLS</span><span class="p">)</span>
</span><span id="LiLit.initialize-700"><a href="#LiLit.initialize-700"><span class="linenos">700</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_sigma</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the fiducial spectra and the noise power spectra.</p>
</div>


                            </div>
                            <div id="LiLit.get_requirements" class="classattr">
                                        <input id="LiLit.get_requirements-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_requirements</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.get_requirements-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.get_requirements"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.get_requirements-702"><a href="#LiLit.get_requirements-702"><span class="linenos">702</span></a>    <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.get_requirements-703"><a href="#LiLit.get_requirements-703"><span class="linenos">703</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Defines requirements of the likelihood, specifying quantities calculated by a theory code are needed. Note that you may want to change the overall keyword from &#39;Cl&#39; to &#39;unlensed_Cl&#39; if you want to work without considering lensing.&quot;&quot;&quot;</span>
</span><span id="LiLit.get_requirements-704"><a href="#LiLit.get_requirements-704"><span class="linenos">704</span></a>        <span class="c1"># The likelihood needs the lensed CMB angular power spectra. The keyword can be set to &quot;unlensed_Cl&quot; to get the unlensed ones</span>
</span><span id="LiLit.get_requirements-705"><a href="#LiLit.get_requirements-705"><span class="linenos">705</span></a>        <span class="n">requitements</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LiLit.get_requirements-706"><a href="#LiLit.get_requirements-706"><span class="linenos">706</span></a>        <span class="n">requitements</span><span class="p">[</span><span class="s2">&quot;Cl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cl</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">}</span>
</span><span id="LiLit.get_requirements-707"><a href="#LiLit.get_requirements-707"><span class="linenos">707</span></a>        <span class="c1"># If debug is set to True, the likelihood will print the list of items required by the likelihood</span>
</span><span id="LiLit.get_requirements-708"><a href="#LiLit.get_requirements-708"><span class="linenos">708</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.get_requirements-709"><a href="#LiLit.get_requirements-709"><span class="linenos">709</span></a>            <span class="n">requitements</span><span class="p">[</span><span class="s2">&quot;CAMBdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LiLit.get_requirements-710"><a href="#LiLit.get_requirements-710"><span class="linenos">710</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="LiLit.get_requirements-711"><a href="#LiLit.get_requirements-711"><span class="linenos">711</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You requested that Cobaya provides to the likelihood the following items: </span><span class="si">{</span><span class="n">requitements</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="LiLit.get_requirements-712"><a href="#LiLit.get_requirements-712"><span class="linenos">712</span></a>            <span class="p">)</span>
</span><span id="LiLit.get_requirements-713"><a href="#LiLit.get_requirements-713"><span class="linenos">713</span></a>        <span class="k">return</span> <span class="n">requitements</span>
</span></pre></div>


            <div class="docstring"><p>Defines requirements of the likelihood, specifying quantities calculated by a theory code are needed. Note that you may want to change the overall keyword from 'Cl' to 'unlensed_Cl' if you want to work without considering lensing.</p>
</div>


                            </div>
                            <div id="LiLit.data_vector" class="classattr">
                                        <input id="LiLit.data_vector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">data_vector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cov</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.data_vector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.data_vector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.data_vector-715"><a href="#LiLit.data_vector-715"><span class="linenos">715</span></a>    <span class="k">def</span> <span class="nf">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov</span><span class="p">):</span>
</span><span id="LiLit.data_vector-716"><a href="#LiLit.data_vector-716"><span class="linenos">716</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data vector from the covariance matrix.</span>
</span><span id="LiLit.data_vector-717"><a href="#LiLit.data_vector-717"><span class="linenos">717</span></a>
</span><span id="LiLit.data_vector-718"><a href="#LiLit.data_vector-718"><span class="linenos">718</span></a><span class="sd">        Extracts the data vector necessary for the Gaussian case. Note that this will cut the null value since some may be null when the fields have different values for lmax.</span>
</span><span id="LiLit.data_vector-719"><a href="#LiLit.data_vector-719"><span class="linenos">719</span></a>
</span><span id="LiLit.data_vector-720"><a href="#LiLit.data_vector-720"><span class="linenos">720</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.data_vector-721"><a href="#LiLit.data_vector-721"><span class="linenos">721</span></a><span class="sd">            cov (np.ndarray):</span>
</span><span id="LiLit.data_vector-722"><a href="#LiLit.data_vector-722"><span class="linenos">722</span></a><span class="sd">                A ndarray containing the covariance matrices, with some null ones.</span>
</span><span id="LiLit.data_vector-723"><a href="#LiLit.data_vector-723"><span class="linenos">723</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.data_vector-724"><a href="#LiLit.data_vector-724"><span class="linenos">724</span></a>        <span class="k">return</span> <span class="n">cov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)][</span><span class="n">cov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get data vector from the covariance matrix.</p>

<p>Extracts the data vector necessary for the Gaussian case. Note that this will cut the null value since some may be null when the fields have different values for lmax.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>cov (np.ndarray):</strong>  A ndarray containing the covariance matrices, with some null ones.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.chi_exact" class="classattr">
                                        <input id="LiLit.chi_exact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">chi_exact</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">i</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.chi_exact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.chi_exact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.chi_exact-726"><a href="#LiLit.chi_exact-726"><span class="linenos">726</span></a>    <span class="k">def</span> <span class="nf">chi_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="LiLit.chi_exact-727"><a href="#LiLit.chi_exact-727"><span class="linenos">727</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes proper chi-square term for the exact likelihood case.</span>
</span><span id="LiLit.chi_exact-728"><a href="#LiLit.chi_exact-728"><span class="linenos">728</span></a>
</span><span id="LiLit.chi_exact-729"><a href="#LiLit.chi_exact-729"><span class="linenos">729</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.chi_exact-730"><a href="#LiLit.chi_exact-730"><span class="linenos">730</span></a><span class="sd">            i (int, optional):</span>
</span><span id="LiLit.chi_exact-731"><a href="#LiLit.chi_exact-731"><span class="linenos">731</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="LiLit.chi_exact-732"><a href="#LiLit.chi_exact-732"><span class="linenos">732</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.chi_exact-733"><a href="#LiLit.chi_exact-733"><span class="linenos">733</span></a>        <span class="c1"># If the number of datasets is not equal to 1, then we have a</span>
</span><span id="LiLit.chi_exact-734"><a href="#LiLit.chi_exact-734"><span class="linenos">734</span></a>        <span class="c1"># multi-dataset case, in which case we need to compute the</span>
</span><span id="LiLit.chi_exact-735"><a href="#LiLit.chi_exact-735"><span class="linenos">735</span></a>        <span class="c1"># covariance matrix for each dataset.</span>
</span><span id="LiLit.chi_exact-736"><a href="#LiLit.chi_exact-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LiLit.chi_exact-737"><a href="#LiLit.chi_exact-737"><span class="linenos">737</span></a>            <span class="c1"># We extract the covariance matrix and data for the ith</span>
</span><span id="LiLit.chi_exact-738"><a href="#LiLit.chi_exact-738"><span class="linenos">738</span></a>            <span class="c1"># dataset.</span>
</span><span id="LiLit.chi_exact-739"><a href="#LiLit.chi_exact-739"><span class="linenos">739</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit.chi_exact-740"><a href="#LiLit.chi_exact-740"><span class="linenos">740</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="LiLit.chi_exact-741"><a href="#LiLit.chi_exact-741"><span class="linenos">741</span></a>            <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">coba</span><span class="p">)</span>
</span><span id="LiLit.chi_exact-742"><a href="#LiLit.chi_exact-742"><span class="linenos">742</span></a>            <span class="c1"># If the determinant is equal to 0, then we need to reduce</span>
</span><span id="LiLit.chi_exact-743"><a href="#LiLit.chi_exact-743"><span class="linenos">743</span></a>            <span class="c1"># the dimensionality of the data and covariance matrix.</span>
</span><span id="LiLit.chi_exact-744"><a href="#LiLit.chi_exact-744"><span class="linenos">744</span></a>            <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LiLit.chi_exact-745"><a href="#LiLit.chi_exact-745"><span class="linenos">745</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="LiLit.chi_exact-746"><a href="#LiLit.chi_exact-746"><span class="linenos">746</span></a>                <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_data</span><span class="p">(</span><span class="n">coba</span><span class="p">)</span>
</span><span id="LiLit.chi_exact-747"><a href="#LiLit.chi_exact-747"><span class="linenos">747</span></a>            <span class="c1"># We compute the matrix M using the covariance matrix and</span>
</span><span id="LiLit.chi_exact-748"><a href="#LiLit.chi_exact-748"><span class="linenos">748</span></a>            <span class="c1"># the data.</span>
</span><span id="LiLit.chi_exact-749"><a href="#LiLit.chi_exact-749"><span class="linenos">749</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">coba</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="LiLit.chi_exact-750"><a href="#LiLit.chi_exact-750"><span class="linenos">750</span></a>            <span class="c1"># We compute the chi-square term using the trace of M, the</span>
</span><span id="LiLit.chi_exact-751"><a href="#LiLit.chi_exact-751"><span class="linenos">751</span></a>            <span class="c1"># log determinant of M, and the number of fields.</span>
</span><span id="LiLit.chi_exact-752"><a href="#LiLit.chi_exact-752"><span class="linenos">752</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">M</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.chi_exact-753"><a href="#LiLit.chi_exact-753"><span class="linenos">753</span></a>        <span class="c1"># If the number of datasets is equal to 1, then we have a single</span>
</span><span id="LiLit.chi_exact-754"><a href="#LiLit.chi_exact-754"><span class="linenos">754</span></a>        <span class="c1"># dataset case, in which case we do not need to loop over the</span>
</span><span id="LiLit.chi_exact-755"><a href="#LiLit.chi_exact-755"><span class="linenos">755</span></a>        <span class="c1"># datasets.</span>
</span><span id="LiLit.chi_exact-756"><a href="#LiLit.chi_exact-756"><span class="linenos">756</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.chi_exact-757"><a href="#LiLit.chi_exact-757"><span class="linenos">757</span></a>            <span class="c1"># We compute the matrix M using the covariance matrix and</span>
</span><span id="LiLit.chi_exact-758"><a href="#LiLit.chi_exact-758"><span class="linenos">758</span></a>            <span class="c1"># the data.</span>
</span><span id="LiLit.chi_exact-759"><a href="#LiLit.chi_exact-759"><span class="linenos">759</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span>
</span><span id="LiLit.chi_exact-760"><a href="#LiLit.chi_exact-760"><span class="linenos">760</span></a>            <span class="c1"># We compute the chi-square term using M, the log of M, and</span>
</span><span id="LiLit.chi_exact-761"><a href="#LiLit.chi_exact-761"><span class="linenos">761</span></a>            <span class="c1"># a constant value.</span>
</span><span id="LiLit.chi_exact-762"><a href="#LiLit.chi_exact-762"><span class="linenos">762</span></a>            <span class="k">return</span> <span class="n">M</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">M</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Computes proper chi-square term for the exact likelihood case.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>i (int, optional):</strong>  ell index if needed. Defaults to 0.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.chi_gaussian" class="classattr">
                                        <input id="LiLit.chi_gaussian-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">chi_gaussian</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">i</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.chi_gaussian-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.chi_gaussian"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.chi_gaussian-764"><a href="#LiLit.chi_gaussian-764"><span class="linenos">764</span></a>    <span class="k">def</span> <span class="nf">chi_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="LiLit.chi_gaussian-765"><a href="#LiLit.chi_gaussian-765"><span class="linenos">765</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes proper chi-square term for the Gaussian likelihood case.</span>
</span><span id="LiLit.chi_gaussian-766"><a href="#LiLit.chi_gaussian-766"><span class="linenos">766</span></a>
</span><span id="LiLit.chi_gaussian-767"><a href="#LiLit.chi_gaussian-767"><span class="linenos">767</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.chi_gaussian-768"><a href="#LiLit.chi_gaussian-768"><span class="linenos">768</span></a><span class="sd">            i (int, optional):</span>
</span><span id="LiLit.chi_gaussian-769"><a href="#LiLit.chi_gaussian-769"><span class="linenos">769</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="LiLit.chi_gaussian-770"><a href="#LiLit.chi_gaussian-770"><span class="linenos">770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.chi_gaussian-771"><a href="#LiLit.chi_gaussian-771"><span class="linenos">771</span></a>        <span class="c1"># If we have more than one data vector</span>
</span><span id="LiLit.chi_gaussian-772"><a href="#LiLit.chi_gaussian-772"><span class="linenos">772</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LiLit.chi_gaussian-773"><a href="#LiLit.chi_gaussian-773"><span class="linenos">773</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="LiLit.chi_gaussian-774"><a href="#LiLit.chi_gaussian-774"><span class="linenos">774</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="LiLit.chi_gaussian-775"><a href="#LiLit.chi_gaussian-775"><span class="linenos">775</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span>
</span><span id="LiLit.chi_gaussian-776"><a href="#LiLit.chi_gaussian-776"><span class="linenos">776</span></a>        <span class="c1"># If we have only one data vector</span>
</span><span id="LiLit.chi_gaussian-777"><a href="#LiLit.chi_gaussian-777"><span class="linenos">777</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.chi_gaussian-778"><a href="#LiLit.chi_gaussian-778"><span class="linenos">778</span></a>            <span class="n">coba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coba</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="LiLit.chi_gaussian-779"><a href="#LiLit.chi_gaussian-779"><span class="linenos">779</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="LiLit.chi_gaussian-780"><a href="#LiLit.chi_gaussian-780"><span class="linenos">780</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma2</span> <span class="o">*</span> <span class="p">(</span><span class="n">coba</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span>
</span><span id="LiLit.chi_gaussian-781"><a href="#LiLit.chi_gaussian-781"><span class="linenos">781</span></a>            <span class="k">return</span> <span class="n">res</span>
</span></pre></div>


            <div class="docstring"><p>Computes proper chi-square term for the Gaussian likelihood case.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>i (int, optional):</strong>  ell index if needed. Defaults to 0.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.compute_chi_part" class="classattr">
                                        <input id="LiLit.compute_chi_part-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_chi_part</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">i</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.compute_chi_part-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.compute_chi_part"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.compute_chi_part-783"><a href="#LiLit.compute_chi_part-783"><span class="linenos">783</span></a>    <span class="k">def</span> <span class="nf">compute_chi_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="LiLit.compute_chi_part-784"><a href="#LiLit.compute_chi_part-784"><span class="linenos">784</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Chooses which chi-square term to compute.</span>
</span><span id="LiLit.compute_chi_part-785"><a href="#LiLit.compute_chi_part-785"><span class="linenos">785</span></a>
</span><span id="LiLit.compute_chi_part-786"><a href="#LiLit.compute_chi_part-786"><span class="linenos">786</span></a><span class="sd">        Parameters:</span>
</span><span id="LiLit.compute_chi_part-787"><a href="#LiLit.compute_chi_part-787"><span class="linenos">787</span></a><span class="sd">            i (int, optional):</span>
</span><span id="LiLit.compute_chi_part-788"><a href="#LiLit.compute_chi_part-788"><span class="linenos">788</span></a><span class="sd">                ell index if needed. Defaults to 0.</span>
</span><span id="LiLit.compute_chi_part-789"><a href="#LiLit.compute_chi_part-789"><span class="linenos">789</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LiLit.compute_chi_part-790"><a href="#LiLit.compute_chi_part-790"><span class="linenos">790</span></a>        <span class="c1"># check if the likelihood is &quot;exact&quot;</span>
</span><span id="LiLit.compute_chi_part-791"><a href="#LiLit.compute_chi_part-791"><span class="linenos">791</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;exact&quot;</span><span class="p">:</span>
</span><span id="LiLit.compute_chi_part-792"><a href="#LiLit.compute_chi_part-792"><span class="linenos">792</span></a>            <span class="c1"># if so, compute the chi-square term for the exact likelihood</span>
</span><span id="LiLit.compute_chi_part-793"><a href="#LiLit.compute_chi_part-793"><span class="linenos">793</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_exact</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="LiLit.compute_chi_part-794"><a href="#LiLit.compute_chi_part-794"><span class="linenos">794</span></a>        <span class="c1"># if not, check if it is &quot;gaussian&quot;</span>
</span><span id="LiLit.compute_chi_part-795"><a href="#LiLit.compute_chi_part-795"><span class="linenos">795</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
</span><span id="LiLit.compute_chi_part-796"><a href="#LiLit.compute_chi_part-796"><span class="linenos">796</span></a>            <span class="c1"># if so, compute the chi-square term for the gaussian likelihood</span>
</span><span id="LiLit.compute_chi_part-797"><a href="#LiLit.compute_chi_part-797"><span class="linenos">797</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_gaussian</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="LiLit.compute_chi_part-798"><a href="#LiLit.compute_chi_part-798"><span class="linenos">798</span></a>        <span class="c1"># if neither, print an error message</span>
</span><span id="LiLit.compute_chi_part-799"><a href="#LiLit.compute_chi_part-799"><span class="linenos">799</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.compute_chi_part-800"><a href="#LiLit.compute_chi_part-800"><span class="linenos">800</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You requested something different from &#39;exact or &#39;gaussian&#39;!&quot;</span><span class="p">)</span>
</span><span id="LiLit.compute_chi_part-801"><a href="#LiLit.compute_chi_part-801"><span class="linenos">801</span></a>            <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Chooses which chi-square term to compute.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>i (int, optional):</strong>  ell index if needed. Defaults to 0.</li>
</ul>
</div>


                            </div>
                            <div id="LiLit.log_likelihood" class="classattr">
                                        <input id="LiLit.log_likelihood-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">log_likelihood</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.log_likelihood-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.log_likelihood"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.log_likelihood-803"><a href="#LiLit.log_likelihood-803"><span class="linenos">803</span></a>    <span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LiLit.log_likelihood-804"><a href="#LiLit.log_likelihood-804"><span class="linenos">804</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the log likelihood.&quot;&quot;&quot;</span>
</span><span id="LiLit.log_likelihood-805"><a href="#LiLit.log_likelihood-805"><span class="linenos">805</span></a>        <span class="c1"># Get the array of multipoles</span>
</span><span id="LiLit.log_likelihood-806"><a href="#LiLit.log_likelihood-806"><span class="linenos">806</span></a>        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit.log_likelihood-807"><a href="#LiLit.log_likelihood-807"><span class="linenos">807</span></a>        <span class="c1"># Compute the log likelihood for each multipole</span>
</span><span id="LiLit.log_likelihood-808"><a href="#LiLit.log_likelihood-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LiLit.log_likelihood-809"><a href="#LiLit.log_likelihood-809"><span class="linenos">809</span></a>            <span class="n">logp_ℓ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ell</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="LiLit.log_likelihood-810"><a href="#LiLit.log_likelihood-810"><span class="linenos">810</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span><span class="p">):</span>
</span><span id="LiLit.log_likelihood-811"><a href="#LiLit.log_likelihood-811"><span class="linenos">811</span></a>                <span class="n">logp_ℓ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chi_part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="LiLit.log_likelihood-812"><a href="#LiLit.log_likelihood-812"><span class="linenos">812</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LiLit.log_likelihood-813"><a href="#LiLit.log_likelihood-813"><span class="linenos">813</span></a>            <span class="n">logp_ℓ</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chi_part</span><span class="p">()</span>
</span><span id="LiLit.log_likelihood-814"><a href="#LiLit.log_likelihood-814"><span class="linenos">814</span></a>        <span class="c1"># Sum the log likelihood over multipoles</span>
</span><span id="LiLit.log_likelihood-815"><a href="#LiLit.log_likelihood-815"><span class="linenos">815</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logp_ℓ</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Computes the log likelihood.</p>
</div>


                            </div>
                            <div id="LiLit.logp" class="classattr">
                                        <input id="LiLit.logp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">logp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">params_values</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LiLit.logp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LiLit.logp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LiLit.logp-817"><a href="#LiLit.logp-817"><span class="linenos">817</span></a>    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params_values</span><span class="p">):</span>
</span><span id="LiLit.logp-818"><a href="#LiLit.logp-818"><span class="linenos">818</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the log likelihood and pass it to Cobaya to carry on the MCMC process.&quot;&quot;&quot;</span>
</span><span id="LiLit.logp-819"><a href="#LiLit.logp-819"><span class="linenos">819</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.logp-820"><a href="#LiLit.logp-820"><span class="linenos">820</span></a>            <span class="n">CAMBdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">get_CAMBdata</span><span class="p">()</span>
</span><span id="LiLit.logp-821"><a href="#LiLit.logp-821"><span class="linenos">821</span></a>            <span class="n">pars</span> <span class="o">=</span> <span class="n">CAMBdata</span><span class="o">.</span><span class="n">Params</span>
</span><span id="LiLit.logp-822"><a href="#LiLit.logp-822"><span class="linenos">822</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</span><span id="LiLit.logp-823"><a href="#LiLit.logp-823"><span class="linenos">823</span></a>
</span><span id="LiLit.logp-824"><a href="#LiLit.logp-824"><span class="linenos">824</span></a>        <span class="c1"># Get the Cls from Cobaya</span>
</span><span id="LiLit.logp-825"><a href="#LiLit.logp-825"><span class="linenos">825</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">get_Cl</span><span class="p">(</span><span class="n">ell_factor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LiLit.logp-826"><a href="#LiLit.logp-826"><span class="linenos">826</span></a>
</span><span id="LiLit.logp-827"><a href="#LiLit.logp-827"><span class="linenos">827</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.logp-828"><a href="#LiLit.logp-828"><span class="linenos">828</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys of Cobaya CLs ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.logp-829"><a href="#LiLit.logp-829"><span class="linenos">829</span></a>
</span><span id="LiLit.logp-830"><a href="#LiLit.logp-830"><span class="linenos">830</span></a>            <span class="n">field</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LiLit.logp-831"><a href="#LiLit.logp-831"><span class="linenos">831</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing the first few values to check that it starts from 0...&quot;</span><span class="p">)</span>
</span><span id="LiLit.logp-832"><a href="#LiLit.logp-832"><span class="linenos">832</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cobaya CLs for </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LiLit.logp-833"><a href="#LiLit.logp-833"><span class="linenos">833</span></a>
</span><span id="LiLit.logp-834"><a href="#LiLit.logp-834"><span class="linenos">834</span></a>        <span class="c1"># Fill the covariance matrix with the Cls from Cobaya</span>
</span><span id="LiLit.logp-835"><a href="#LiLit.logp-835"><span class="linenos">835</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_filling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cobaCLs</span><span class="p">)</span>
</span><span id="LiLit.logp-836"><a href="#LiLit.logp-836"><span class="linenos">836</span></a>
</span><span id="LiLit.logp-837"><a href="#LiLit.logp-837"><span class="linenos">837</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.logp-838"><a href="#LiLit.logp-838"><span class="linenos">838</span></a>            <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LiLit.logp-839"><a href="#LiLit.logp-839"><span class="linenos">839</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiduCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fiducial CLs&quot;</span><span class="p">)</span>
</span><span id="LiLit.logp-840"><a href="#LiLit.logp-840"><span class="linenos">840</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cobaya CLs&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</span><span id="LiLit.logp-841"><a href="#LiLit.logp-841"><span class="linenos">841</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Noise CLs&quot;</span><span class="p">)</span>
</span><span id="LiLit.logp-842"><a href="#LiLit.logp-842"><span class="linenos">842</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="LiLit.logp-843"><a href="#LiLit.logp-843"><span class="linenos">843</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="LiLit.logp-844"><a href="#LiLit.logp-844"><span class="linenos">844</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="LiLit.logp-845"><a href="#LiLit.logp-845"><span class="linenos">845</span></a>
</span><span id="LiLit.logp-846"><a href="#LiLit.logp-846"><span class="linenos">846</span></a>        <span class="c1"># Add the noise covariance to the covariance matrix filled with the Cls from Cobaya</span>
</span><span id="LiLit.logp-847"><a href="#LiLit.logp-847"><span class="linenos">847</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coba</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LiLit.logp-848"><a href="#LiLit.logp-848"><span class="linenos">848</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cobaCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.logp-849"><a href="#LiLit.logp-849"><span class="linenos">849</span></a>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseCOV</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmin</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="LiLit.logp-850"><a href="#LiLit.logp-850"><span class="linenos">850</span></a>        <span class="p">)</span>
</span><span id="LiLit.logp-851"><a href="#LiLit.logp-851"><span class="linenos">851</span></a>
</span><span id="LiLit.logp-852"><a href="#LiLit.logp-852"><span class="linenos">852</span></a>        <span class="c1"># Compute the likelihood</span>
</span><span id="LiLit.logp-853"><a href="#LiLit.logp-853"><span class="linenos">853</span></a>        <span class="n">logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">()</span>
</span><span id="LiLit.logp-854"><a href="#LiLit.logp-854"><span class="linenos">854</span></a>
</span><span id="LiLit.logp-855"><a href="#LiLit.logp-855"><span class="linenos">855</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="LiLit.logp-856"><a href="#LiLit.logp-856"><span class="linenos">856</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">logp</span><span class="p">)</span>
</span><span id="LiLit.logp-857"><a href="#LiLit.logp-857"><span class="linenos">857</span></a>            <span class="n">exit</span><span class="p">()</span>
</span><span id="LiLit.logp-858"><a href="#LiLit.logp-858"><span class="linenos">858</span></a>
</span><span id="LiLit.logp-859"><a href="#LiLit.logp-859"><span class="linenos">859</span></a>        <span class="k">return</span> <span class="n">logp</span>
</span></pre></div>


            <div class="docstring"><p>Gets the log likelihood and pass it to Cobaya to carry on the MCMC process.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>cobaya.likelihood.Likelihood</dt>
                                <dd id="LiLit.marginal" class="function">marginal</dd>
                <dd id="LiLit.calculate" class="function">calculate</dd>
                <dd id="LiLit.wait" class="function">wait</dd>

            </div>
            <div><dt>cobaya.theory.Theory</dt>
                                <dd id="LiLit.must_provide" class="function">must_provide</dd>
                <dd id="LiLit.initialize_with_params" class="function">initialize_with_params</dd>
                <dd id="LiLit.initialize_with_provider" class="function">initialize_with_provider</dd>
                <dd id="LiLit.get_param" class="function">get_param</dd>
                <dd id="LiLit.get_result" class="function">get_result</dd>
                <dd id="LiLit.get_can_provide_methods" class="function">get_can_provide_methods</dd>
                <dd id="LiLit.get_can_provide" class="function">get_can_provide</dd>
                <dd id="LiLit.get_can_provide_params" class="function">get_can_provide_params</dd>
                <dd id="LiLit.get_can_support_params" class="function">get_can_support_params</dd>
                <dd id="LiLit.get_allow_agnostic" class="function">get_allow_agnostic</dd>
                <dd id="LiLit.input_params_extra" class="variable">input_params_extra</dd>
                <dd id="LiLit.set_cache_size" class="function">set_cache_size</dd>
                <dd id="LiLit.check_cache_and_compute" class="function">check_cache_and_compute</dd>
                <dd id="LiLit.get_current_derived" class="function">get_current_derived</dd>
                <dd id="LiLit.get_provider" class="function">get_provider</dd>
                <dd id="LiLit.get_helper_theories" class="function">get_helper_theories</dd>
                <dd id="LiLit.update_for_helper_theories" class="function">update_for_helper_theories</dd>
                <dd id="LiLit.get_attr_list_with_helpers" class="function">get_attr_list_with_helpers</dd>
                <dd id="LiLit.get_speed" class="function">get_speed</dd>
                <dd id="LiLit.set_measured_speed" class="function">set_measured_speed</dd>

            </div>
            <div><dt>cobaya.component.CobayaComponent</dt>
                                <dd id="LiLit.set_timing_on" class="function">set_timing_on</dd>
                <dd id="LiLit.get_name" class="function">get_name</dd>
                <dd id="LiLit.close" class="function">close</dd>
                <dd id="LiLit.set_instance_defaults" class="function">set_instance_defaults</dd>
                <dd id="LiLit.get_version" class="function">get_version</dd>
                <dd id="LiLit.has_version" class="function">has_version</dd>
                <dd id="LiLit.get_kind" class="function">get_kind</dd>
                <dd id="LiLit.compare_versions" class="function">compare_versions</dd>

            </div>
            <div><dt>cobaya.log.HasLogger</dt>
                                <dd id="LiLit.set_logger" class="function">set_logger</dd>
                <dd id="LiLit.is_debug" class="function">is_debug</dd>
                <dd id="LiLit.mpi_warning" class="function">mpi_warning</dd>
                <dd id="LiLit.mpi_info" class="function">mpi_info</dd>
                <dd id="LiLit.mpi_debug" class="function">mpi_debug</dd>

            </div>
            <div><dt>cobaya.component.HasDefaults</dt>
                                <dd id="LiLit.get_qualified_names" class="function">get_qualified_names</dd>
                <dd id="LiLit.get_qualified_class_name" class="function">get_qualified_class_name</dd>
                <dd id="LiLit.get_class_path" class="function">get_class_path</dd>
                <dd id="LiLit.get_file_base_name" class="function">get_file_base_name</dd>
                <dd id="LiLit.get_root_file_name" class="function">get_root_file_name</dd>
                <dd id="LiLit.get_yaml_file" class="function">get_yaml_file</dd>
                <dd id="LiLit.get_desc" class="function">get_desc</dd>
                <dd id="LiLit.get_bibtex" class="function">get_bibtex</dd>
                <dd id="LiLit.get_associated_file_content" class="function">get_associated_file_content</dd>
                <dd id="LiLit.get_class_options" class="function">get_class_options</dd>
                <dd id="LiLit.get_defaults" class="function">get_defaults</dd>
                <dd id="LiLit.get_annotations" class="function">get_annotations</dd>

            </div>
            <div><dt>cobaya.likelihood.LikelihoodInterface</dt>
                                <dd id="LiLit.current_logp" class="variable">current_logp</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>